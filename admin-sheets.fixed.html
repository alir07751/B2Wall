
<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>مدیریت پروژه‌ها • Google Sheets (بدون گیت/لوکال)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Vazirmatn',system-ui,-apple-system,"Segoe UI",Roboto,"Noto Naskh Arabic",sans-serif}
    .table-wrap{ overflow:auto }
    .drawer{ position:fixed; inset:0; z-index:50; display:none }
    .drawer.open{ display:block }
    .drawer-panel{ position:absolute; inset-y:0; right:0; width:min(880px,100%); background:#fff; box-shadow:0 0 50px rgba(0,0,0,.25); overflow-y:auto }
    .dropzone{ border:2px dashed #cbd5e1; border-radius:1rem; padding:1rem; background:#f8fafc; cursor:pointer }
    .dropzone.dragover{ background:#eef2ff; border-color:#818cf8 }
    .badge-status{ font-size:12px; font-weight:700; padding:.25rem .5rem; border-radius:9999px; border:1px solid; }
    .badge-open{ background:#eff6ff; color:#1d4ed8; border-color:#bfdbfe }
    .badge-completed{ background:#ecfdf5; color:#047857; border-color:#a7f3d0 }
    .badge-coming{ background:#fffbeb; color:#b45309; border-color:#fde68a }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace }
    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:16px; z-index:60; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="max-w-6xl mx-auto px-4 py-5">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <h1 class="text-2xl md:text-3xl font-bold">پنل مدیریت پروژه‌ها</h1>
        <span class="px-2 py-0.5 rounded-full text-xs bg-emerald-50 text-emerald-700 border border-emerald-200">Google Sheets</span>
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="btn-new" class="px-3 py-1.5 rounded-xl border text-sm bg-blue-600 text-white">➕ افزودن پروژه</button>
      </div>
    </div>

    <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-3">
      <div class="flex items-center gap-2 text-sm">
        <span class="px-2 py-0.5 rounded-full text-xs bg-slate-100 text-slate-700 border border-slate-200">مجموع: <b id="count" class="mx-1">۰</b> پروژه</span>
        <span class="px-2 py-0.5 rounded-full text-xs bg-slate-100 text-slate-700 border border-slate-200">منبع داده: <b class="mx-1">Google Sheets</b></span>
      </div>
      <div class="sm:col-span-2 flex flex-wrap items-center justify-end gap-2">
        <input id="q" type="search" placeholder="جستجو در عنوان..." class="px-3 py-2 rounded-xl border border-slate-300 w-full sm:w-64">
        <select id="filter-status" class="px-3 py-2 rounded-xl border border-slate-300">
          <option value="all">همه وضعیت‌ها</option>
          <option value="open">در حال جذب</option>
          <option value="completed">تکمیل شده</option>
          <option value="coming_soon">به‌زودی</option>
        </select>
        <select id="sort-by" class="px-3 py-2 rounded-xl border border-slate-300">
          <option value="id_desc">مرتب‌سازی: جدیدترین</option>
          <option value="id_asc">قدیمی‌تر</option>
          <option value="raised_desc">تأمین‌شده (زیاد → کم)</option>
          <option value="raised_asc">تأمین‌شده (کم → زیاد)</option>
        </select>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-28">
    <div class="bg-white border border-slate-200 rounded-2xl shadow">
      <div class="table-wrap">
        <table class="w-full min-w-[980px] text-sm">
          <thead>
            <tr class="bg-slate-100 text-slate-700">
              <th class="text-right p-2 w-12">#</th>
              <th class="text-right p-2 w-20">تصویر</th>
              <th class="text-right p-2">عنوان</th>
              <th class="text-right p-2">وضعیت</th>
              <th class="text-right p-2">موردنیاز</th>
              <th class="text-right p-2">تأمین‌شده</th>
              <th class="text-right p-2">مدت</th>
              <th class="text-right p-2">سود</th>
              <th class="text-right p-2 w-28">اقدامات</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </main>

  <div id="drawer" class="drawer">
    <div class="absolute inset-0 bg-black/40" data-close></div>
    <div class="drawer-panel">
      <div class="p-4 sm:p-6 border-b border-slate-200 flex items-center justify-between sticky top-0 bg-white z-10">
        <h2 id="drawer-title" class="text-xl font-bold">افزودن پروژه</h2>
        <div class="flex items-center gap-2">
          <button class="px-3 py-1.5 rounded-xl border text-sm bg-slate-100" data-close>بستن</button>
        </div>
      </div>

      <form id="form" class="p-4 sm:p-6 space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="space-y-4">
            <div>
              <label class="block text-sm mb-1" for="id">شناسه (id)</label>
              <input id="id" type="number" class="px-3 py-2 rounded-xl border border-slate-300 w-full" placeholder="اگر خالی بماند خودکار تعیین می‌شود">
            </div>
            <div>
              <label class="block text-sm mb-1" for="title">عنوان</label>
              <input id="title" type="text" class="px-3 py-2 rounded-xl border border-slate-300 w-full" placeholder="عنوان پروژه" required>
            </div>
            <div>
              <div class="flex items-center gap-2 mb-2">
                <span class="text-sm">تصویر پروژه</span>
                <div class="flex gap-1 text-xs">
                  <button type="button" id="tab-url" class="px-2 py-0.5 rounded-full bg-slate-200 border border-slate-300">لینک</button>
                  <button type="button" id="tab-upload" class="px-2 py-0.5 rounded-full border border-slate-300">آپلود</button>
                </div>
              </div>
              <div id="pane-url" class="space-y-2">
                <input id="image" type="text" class="px-3 py-2 rounded-xl border border-slate-300 w-full" placeholder="مثلاً projects/filename.jpg یا URL کامل">
                <p class="text-xs text-slate-500">پیشنهاد: تصاویر را در گوگل‌درایو/سی‌دی‌ان میزبانی کنید و لینک بدهید.</p>
              </div>
              <div id="pane-upload" class="space-y-2 hidden">
                <div id="dropzone" class="dropzone text-sm text-slate-600">
                  <input id="file-image" type="file" accept="image/*" class="hidden">
                  <p><b>فایل تصویر را اینجا رها کنید</b> یا کلیک کنید تا انتخاب کنید.</p>
                  <p class="text-xs mt-1">حداکثر عرض: 1200px — کیفیت: 0.8 — هدف: &lt; 400KB</p>
                </div>
                <div class="flex items-center gap-3">
                  <img id="preview" class="w-28 h-20 object-cover rounded border border-slate-200" alt="پیش‌نمایش">
                  <button type="button" id="btn-clear-img" class="px-3 py-1.5 rounded-xl border text-sm bg-white">حذف تصویر</button>
                </div>
                <input id="image-dataurl" type="text" class="px-3 py-2 rounded-xl border border-slate-300 w-full mono" readonly placeholder="data:image/... (برای آپلود به Drive)">
              </div>
            </div>
            <div>
              <label class="block text-sm mb-1" for="status">وضعیت</label>
              <select id="status" class="px-3 py-2 rounded-xl border border-slate-300 w-full">
                <option value="open">در حال جذب</option>
                <option value="completed">تکمیل شده</option>
                <option value="coming_soon">به‌زودی</option>
              </select>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm mb-1" for="capital_required">مبلغ موردنیاز</label>
                <input id="capital_required" type="number" class="px-3 py-2 rounded-xl border border-slate-300 w-full" placeholder="مثلاً 5000000000">
              </div>
              <div>
                <label class="block text-sm mb-1" for="capital_raised">مبلغ تأمین‌شده</label>
                <input id="capital_raised" type="number" class="px-3 py-2 rounded-xl border border-slate-300 w-full" placeholder="مثلاً 2500000000">
              </div>
            </div>
          </div>

          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm mb-1" for="tenor_months">مدت (ماه)</label>
                <input id="tenor_months" type="number" class="px-3 py-2 rounded-xl border border-slate-300 w-full" placeholder="مثلاً 9">
              </div>
              <div>
                <label class="block text-sm mb-1" for="expected_profit_pct">سود (٪)</label>
                <input id="expected_profit_pct" type="number" step="0.01" class="px-3 py-2 rounded-xl border border-slate-300 w-full" placeholder="مثلاً 5.5">
                <p class="text-xs text-slate-500 mt-1">اگر بیش از 1 وارد کنید درصد محسوب می‌شود (۵.۵). برای ذخیره به اعشار (۰.۰۵۵) تبدیل می‌کنیم.</p>
              </div>
            </div>
            <div>
              <label class="block text-sm mb-1" for="payout_schedule">مواعد پرداخت سود</label>
              <input id="payout_schedule" type="text" class="px-3 py-2 rounded-xl border border-slate-300 w-full" placeholder="ماهانه / فصلی / پایان دوره ...">
            </div>
            <div>
              <label class="block text-sm mb-1" for="principal_return_months">بازگشت اصل پول (ماه)</label>
              <input id="principal_return_months" type="number" class="px-3 py-2 rounded-xl border border-slate-300 w-full" placeholder="مثلاً 12">
            </div>
            <div>
              <label class="block text-sm mb-1" for="guarantees">نوع ضمانت (با ویرگول)</label>
              <input id="guarantees" type="text" class="px-3 py-2 rounded-xl border border-slate-300 w-full" placeholder="دو ضامن حقیقی، وثیقه ملکی">
            </div>
            <fieldset class="border border-slate-200 rounded-2xl p-4">
              <legend class="px-2 text-sm text-slate-500">مالک</legend>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div><label class="block text-sm mb-1" for="owner_id">شناسه مالک</label><input id="owner_id" type="text" class="px-3 py-2 rounded-xl border border-slate-300 w-full" placeholder="مثلاً zahra-babaei"></div>
                <div><label class="block text-sm mb-1" for="owner_name">نام مالک</label><input id="owner_name" type="text" class="px-3 py-2 rounded-xl border border-slate-300 w-full" placeholder="نام و نام خانوادگی"></div>
                <div><label class="block text-sm mb-1" for="owner_profile_image">تصویر پروفایل</label><input id="owner_profile_image" type="text" class="px-3 py-2 rounded-xl border border-slate-300 w-full" placeholder="data:image/svg+xml;... یا URL"></div>
                <div><label class="block text-sm mb-1" for="owner_profile_url">لینک کارنامه</label><input id="owner_profile_url" type="text" class="px-3 py-2 rounded-xl border border-slate-300 w-full" placeholder="owner-profile.html?id=..."></div>
              </div>
            </fieldset>
          </div>
        </div>
        <div class="flex items-center justify-end gap-2 pt-3">
          <button type="button" id="btn-delete" class="px-3 py-1.5 rounded-xl border text-sm bg-rose-600 text-white hidden">حذف</button>
          <button type="submit" id="btn-save" class="px-3 py-1.5 rounded-xl border text-sm bg-blue-600 text-white">ثبت</button>
        </div>
      </form>
    </div>
  </div>

  <div id="toast" class="toast hidden"><div class="px-4 py-2 rounded-xl bg-slate-900/90 text-white text-sm shadow">پیام</div></div>

  <script>
    const API_URL   = "https://script.google.com/macros/s/AKfycbyr5xE9Zt9L5P4_JrZ84pGUmDBAQPt6S06zDCxSmLKVxOLjr6NktDhK65rTzsF4oxM/exec";
    const API_TOKEN = "10HyRsljb1Q05x3RGyOMZDdVJB2xFwUnughr3";

    const el = s => document.querySelector(s);
    const els = s => Array.from(document.querySelectorAll(s));
    const fmt = n => new Intl.NumberFormat('fa-IR').format(n);
    const toast = (msg)=>{ const t=el('#toast'); t.querySelector('div').textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 2000); };

    const state = { projects: [], editIndex: -1, filter: { q: "", status: "all", sort: "id_desc" } };

    async function apiList(){ const res = await fetch(API_URL + '?action=list', { cache:'no-store' }); const data = await res.json(); return Array.isArray(data) ? data : (data.projects || []); }
    async function apiWrite(action, payload){ const body = new URLSearchParams({ action, token: API_TOKEN, payload: JSON.stringify(payload) }); const res = await fetch(API_URL, { method:'POST', headers: { 'Content-Type':'application/x-www-form-urlencoded' }, body }); return res.json(); }

    function badge(status){ if(status==='completed') return '<span class="badge-status badge-completed">تکمیل شده</span>'; if(status==='coming_soon') return '<span class="badge-status badge-coming">به‌زودی</span>'; return '<span class="badge-status badge-open">در حال جذب</span>'; }
    function toRow(p, i){ const img = p.image ? '<img src="'+p.image+'" class="w-16 h-12 object-cover rounded border border-slate-200" alt="">' : '—'; const profit = (typeof p.expected_profit_pct === 'number') ? (p.expected_profit_pct>1?p.expected_profit_pct:p.expected_profit_pct*100) : null; return '<tr class="border-b border-slate-200 hover:bg-slate-50">' + '<td class="p-2">'+(p.id ?? "—")+'</td>' + '<td class="p-2">'+img+'</td>' + '<td class="p-2">'+(p.title ?? "—")+'</td>' + '<td class="p-2">'+badge(p.status)+'</td>' + '<td class="p-2">'+(p.capital_required!=null?fmt(p.capital_required):"—")+'</td>' + '<td class="p-2">'+(p.capital_raised!=null?fmt(p.capital_raised):"—")+'</td>' + '<td class="p-2">'+(p.tenor_months ?? "—")+'</td>' + '<td class="p-2">'+(profit!=null?("%"+(+profit.toFixed(2))):"—")+'</td>' + '<td class="p-2"><button class="px-2 py-1 rounded bg-amber-500 text-white hover:bg-amber-600" onclick="editProject('+i+')">ویرایش</button></td>' + '</tr>'; }

    function applyFilterSort(items){ const {q,status,sort} = state.filter; let list = items; if(q) list = list.filter(p => (p.title||'').includes(q)); if(status!=='all') list = list.filter(p => (p.status||'')===status); if(sort==='id_desc') list = list.slice().sort((a,b)=> (b.id||0)-(a.id||0)); else if(sort==='id_asc') list = list.slice().sort((a,b)=> (a.id||0)-(b.id||0)); else if(sort==='raised_desc') list = list.slice().sort((a,b)=> (b.capital_raised||0)-(a.capital_raised||0)); else if(sort==='raised_asc') list = list.slice().sort((a,b)=> (a.capital_raised||0)-(b.capital_raised||0)); return list; }
    function render(){ const rows = document.getElementById('rows'); const list = applyFilterSort(state.projects); rows.innerHTML = list.map((p,i)=> toRow(p, i)).join(''); document.getElementById('count').textContent = state.projects.length.toLocaleString('fa-IR'); }

    const drawer = document.getElementById('drawer'); 
    const form = document.getElementById('form'); // single definition

    function openDrawer(title){ document.getElementById('drawer-title').textContent = title||'افزودن پروژه'; drawer.classList.add('open'); }
    function closeDrawer(){ drawer.classList.remove('open'); form.reset(); state.editIndex=-1; document.getElementById('btn-delete').classList.add('hidden'); document.getElementById('preview').src=''; document.getElementById('image-dataurl').value=''; setTab('url'); }
    els('[data-close]').forEach(b=> b.addEventListener('click', closeDrawer));

    function setTab(which){ const paneUrl=document.getElementById('pane-url'), paneUpload=document.getElementById('pane-upload'); const tabUrl=document.getElementById('tab-url'), tabUpload=document.getElementById('tab-upload'); if(which==='url'){ tabUrl.classList.add('bg-slate-200'); tabUpload.classList.remove('bg-slate-200'); paneUrl.classList.remove('hidden'); paneUpload.classList.add('hidden'); } else { tabUpload.classList.add('bg-slate-200'); tabUrl.classList.remove('bg-slate-200'); paneUpload.classList.remove('hidden'); paneUrl.classList.add('hidden'); } }
    document.getElementById('tab-url').addEventListener('click', ()=> setTab('url'));
    document.getElementById('tab-upload').addEventListener('click', ()=> setTab('upload'));

    const dropzone = document.getElementById('dropzone'); const fileInput = document.getElementById('file-image'); const preview = document.getElementById('preview'); const imageDataUrl = document.getElementById('image-dataurl');
    ['dragenter','dragover'].forEach(ev=> dropzone.addEventListener(ev, e=>{e.preventDefault(); dropzone.classList.add('dragover');}));
    ['dragleave','drop'].forEach(ev=> dropzone.addEventListener(ev, e=>{e.preventDefault(); dropzone.classList.remove('dragover');}));
    dropzone.addEventListener('click', ()=> fileInput.click());
    dropzone.addEventListener('drop', e=>{ const f=e.dataTransfer.files?.[0]; if(f) handleImageFile(f); });
    fileInput.addEventListener('change', e=>{ const f=e.target.files?.[0]; if(f) handleImageFile(f); });
    document.getElementById('btn-clear-img').addEventListener('click', ()=>{ imageDataUrl.value=''; preview.src=''; });

    async function handleImageFile(file){ if(!file.type.startsWith('image/')){ toast('فایل انتخابی تصویر نیست'); return; } const dataUrl = await compressImage(file, 1200, .8); imageDataUrl.value = dataUrl; preview.src = dataUrl; setTab('upload'); }
    function compressImage(file, maxW=1200, quality=.8){ return new Promise((resolve,reject)=>{ const img = new Image(); const reader = new FileReader(); reader.onload = ()=> img.src = reader.result; reader.onerror = reject; img.onload = ()=>{ const scale = Math.min(1, maxW / img.naturalWidth); const w = Math.round(img.naturalWidth * scale); const h = Math.round(img.naturalHeight * scale); const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h; const ctx = canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h); const jpeg = canvas.toDataURL('image/jpeg', quality); const webp = canvas.toDataURL('image/webp', quality); resolve((webp.length < jpeg.length) ? webp : jpeg); }; img.onerror = reject; reader.readAsDataURL(file); }); }

    function fillForm(p){ const set = (id,v)=> document.getElementById(id).value = (v ?? ''); set('id', p.id); set('title', p.title); if(p.image && p.image.startsWith('data:image/')){ setTab('upload'); imageDataUrl.value=p.image; preview.src=p.image; set('image',''); } else { setTab('url'); set('image', p.image); imageDataUrl.value=''; preview.src=''; } set('status', p.status || 'open'); set('capital_required', p.capital_required); set('capital_raised', p.capital_raised); set('tenor_months', p.tenor_months); set('expected_profit_pct', (typeof p.expected_profit_pct==='number') ? (p.expected_profit_pct > 1 ? p.expected_profit_pct : +(p.expected_profit_pct*100).toFixed(2)) : ''); set('payout_schedule', p.payout_schedule); set('principal_return_months', p.principal_return_months); set('guarantees', Array.isArray(p.guarantees) ? p.guarantees.join('، ') : ''); const o = p.owner || {}; set('owner_id', o.id); set('owner_name', o.name); set('owner_profile_image', o.profile_image); set('owner_profile_url', o.profile_url); }
    function formToObj(){ const g = id => document.getElementById(id).value.trim(); const num = id => { const v=g(id); if(v==='') return null; const n=Number(v.replaceAll(',','.')); return Number.isFinite(n)?n:null; }; const imgUrl = g('image'); const imgData = g('image-dataurl'); let profit = num('expected_profit_pct'); if (profit != null){ if (profit > 1) profit = profit/100; } const guarantees = g('guarantees'); const owner = (g('owner_id') || g('owner_name') || g('owner_profile_image') || g('owner_profile_url')) ? { id: g('owner_id') || null, name: g('owner_name') || null, profile_image: g('owner_profile_image') || null, profile_url: g('owner_profile_url') || null, } : null; const obj = { id: num('id'), title: g('title') || null, image: imgUrl || null, status: g('status') || 'open', capital_required: num('capital_required'), capital_raised: num('capital_raised'), tenor_months: num('tenor_months'), expected_profit_pct: profit, payout_schedule: g('payout_schedule') || null, principal_return_months: num('principal_return_months'), guarantees: guarantees ? guarantees.split('،').join(',').split(',').map(s=>s.trim()).filter(Boolean) : [], owner }; if(!obj.title) throw new Error('عنوان الزامی است.'); if(obj.capital_required != null && obj.capital_raised != null && obj.capital_raised > obj.capital_required){ throw new Error('مبلغ تأمین‌شده نمی‌تواند بیش از مبلغ موردنیاز باشد.'); } return {obj, imgData}; }

    window.editProject = function(i){ state.editIndex = i; fillForm(state.projects[i]); document.getElementById('btn-delete').classList.remove('hidden'); openDrawer('ویرایش پروژه'); };
    document.getElementById('btn-new').addEventListener('click', ()=>{ state.editIndex = -1; form.reset(); document.getElementById('btn-delete').classList.add('hidden'); preview.src=''; imageDataUrl.value=''; setTab('url'); openDrawer('افزودن پروژه'); });

    form.addEventListener('submit', async (e)=>{ e.preventDefault(); try{ const {obj, imgData} = formToObj(); const payload = { project: obj, imageDataUrl: imgData || '' }; if(state.editIndex >= 0){ const res = await apiWrite('update', payload); if(!res.ok) throw new Error(res.error || 'خطا در به‌روزرسانی'); } else { const res = await apiWrite('create', payload); if(!res.ok) throw new Error(res.error || 'خطا در ایجاد'); } state.projects = await apiList(); render(); closeDrawer(); toast('ذخیره شد'); }catch(err){ toast(err.message || 'خطا'); } });
    document.getElementById('btn-delete').addEventListener('click', async ()=>{ if(state.editIndex < 0) return; if(!confirm('این پروژه حذف شود؟')) return; try{ const id = state.projects[state.editIndex].id; const res = await apiWrite('delete', { id }); if(!res.ok) throw new Error(res.error || 'خطا در حذف'); state.projects = await apiList(); render(); closeDrawer(); }catch(err){ toast(err.message || 'خطا'); } });

    document.getElementById('q').addEventListener('input', e=>{ state.filter.q = e.target.value.trim(); render(); });
    document.getElementById('filter-status').addEventListener('change', e=>{ state.filter.status = e.target.value; render(); });
    document.getElementById('sort-by').addEventListener('change', e=>{ state.filter.sort = e.target.value; render(); });

    (async ()=>{ 
      try { state.projects = await apiList(); } 
      catch (err) { console.error(err); toast('خطا در خواندن داده‌ها'); }
      render(); 
    })();
  </script>
</body>
</html>
