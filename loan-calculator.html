<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒÚ¯Ø± Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª ÙˆØ§Ù…</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Vazirmatn', 'IRANSans', system-ui, -apple-system, sans-serif; 
      background: #f5f7fa; 
      line-height: 1.6;
      direction: rtl;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }
    .card { 
      background: #fff; 
      border: 1px solid #e2e8f0; 
      border-radius: 1rem; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.06); 
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      transition: box-shadow 0.2s;
    }
    .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .card-header {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid #e2e8f0;
    }
    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #334155;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .input-field {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid #cbd5e1;
      border-radius: 0.75rem;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.2s;
      background: #fff;
      font-family: 'Vazirmatn', system-ui;
      direction: ltr;
      text-align: left;
    }
    .input-field:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .input-field.error {
      border-color: #ef4444;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.2s;
      cursor: pointer;
      border: none;
      font-family: 'Vazirmatn', system-ui;
    }
    .btn-primary {
      background: #3b82f6;
      color: #fff;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }
    .btn-primary:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    .btn-primary:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      transform: none;
    }
    .btn-secondary {
      background: #f1f5f9;
      color: #475569;
      border: 1px solid #e2e8f0;
    }
    .btn-secondary:hover {
      background: #e2e8f0;
    }
    .btn-success {
      background: #10b981;
      color: #fff;
    }
    .btn-success:hover {
      background: #059669;
    }
    .btn-danger {
      background: #ef4444;
      color: #fff;
    }
    .btn-danger:hover {
      background: #dc2626;
    }
    .label {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      color: #475569;
      margin-bottom: 0.5rem;
    }
    .label-required::after {
      content: ' *';
      color: #ef4444;
    }
    .help-text {
      font-size: 0.8rem;
      color: #64748b;
      margin-top: 0.5rem;
      line-height: 1.5;
    }
    .error-text {
      font-size: 0.8rem;
      color: #ef4444;
      margin-top: 0.25rem;
    }
    .toggle-switch {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem;
      background: #f8fafc;
      border-radius: 0.75rem;
      border: 1px solid #e2e8f0;
      cursor: pointer;
      transition: all 0.2s;
    }
    .toggle-switch:hover {
      background: #f1f5f9;
    }
    .toggle-switch input[type="checkbox"] {
      width: 2.5rem;
      height: 1.5rem;
      cursor: pointer;
    }
    .module-content {
      margin-top: 1rem;
      padding: 1rem;
      background: #fafbfc;
      border-radius: 0.75rem;
      border: 1px solid #e2e8f0;
    }
    .module-content.hidden {
      display: none;
    }
    .auto-split-section {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .auto-split-controls {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 1rem;
      align-items: end;
      margin-top: 1rem;
    }
    @media (max-width: 768px) {
      .auto-split-controls {
        grid-template-columns: 1fr;
      }
    }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 0.9rem;
    }
    th {
      background: #f1f5f9;
      font-weight: 700;
      padding: 1rem;
      text-align: right;
      border-bottom: 2px solid #e2e8f0;
      color: #334155;
      white-space: nowrap;
    }
    td {
      padding: 0.875rem 1rem;
      text-align: right;
      border-bottom: 1px solid #e5e7eb;
      color: #475569;
    }
    tr:hover {
      background: #f8fafc;
    }
    .summary-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      padding: 1.5rem;
      border-radius: 1rem;
      margin-bottom: 1rem;
    }
    .summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    .summary-item:last-child {
      border-bottom: none;
    }
    .summary-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    .summary-value {
      font-size: 1.25rem;
      font-weight: 700;
      font-family: 'Vazirmatn', system-ui;
      font-feature-settings: 'tnum';
    }
    .loading {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid #fff;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .row-item {
      display: flex;
      gap: 1rem;
      align-items: flex-start;
      margin-bottom: 1rem;
      padding: 1rem;
      background: #fafbfc;
      border-radius: 0.75rem;
      border: 1px solid #e2e8f0;
    }
    .row-item > div {
      flex: 1;
    }
    .remove-btn {
      background: none;
      border: none;
      color: #ef4444;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.5rem;
      transition: all 0.2s;
    }
    .remove-btn:hover {
      background: #fee2e2;
    }
    .persian-number {
      font-family: 'Vazirmatn', system-ui;
      font-feature-settings: 'tnum';
      direction: rtl;
    }
    .divider {
      height: 1px;
      background: #e2e8f0;
      margin: 1.5rem 0;
    }
  </style>
</head>
<body>
  <header class="bg-white border-b border-slate-200 shadow-sm">
    <div class="container">
      <h1 class="text-2xl font-bold text-slate-900">Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒÚ¯Ø± Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª ÙˆØ§Ù…</h1>
      <p class="text-sm text-slate-600 mt-1">Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ø¯Ù‚ÛŒÙ‚ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª ÙˆØ§Ù… Ø¨Ø§ Ø¬Ø¯ÙˆÙ„ ØªÙØµÛŒÙ„ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡</p>
    </div>
  </header>

  <main class="container">
    <form id="calculatorForm">
      <!-- Ø¨Ø®Ø´ Û±: Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ§Ù… -->
      <div class="card">
        <div class="card-header">ğŸ“‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ§Ù…</div>
        
        <div class="mb-4">
          <label for="loanAmount" class="label label-required">Ù…Ø¨Ù„Øº ÙˆØ§Ù… (ØªÙˆÙ…Ø§Ù†)</label>
          <input type="text" id="loanAmount" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 330000000" 
                 oninput="LoanModule.updateAmountDisplay()" />
          <div id="loanAmountDisplay" class="help-text persian-number text-blue-600 font-semibold"></div>
          <div class="help-text">ğŸ’¡ Ù…Ø¨Ù„Øº Ú©Ù„ ÙˆØ§Ù… Ø±Ø§ Ø¨Ù‡ ØªÙˆÙ…Ø§Ù† ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯. Ø§Ø¹Ø¯Ø§Ø¯ Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.</div>
        </div>

        <div class="mb-4">
          <label for="monthlyRate" class="label label-required">Ù†Ø±Ø® Ø³ÙˆØ¯ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ (%)</label>
          <input type="text" id="monthlyRate" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 4.5" 
                 oninput="LoanModule.validateRate()" />
          <div id="monthlyRateError" class="error-text"></div>
          <div class="help-text">ğŸ’¡ Ù†Ø±Ø® Ø³ÙˆØ¯ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ Ø¨Ø±Ø­Ø³Ø¨ Ø¯Ø±ØµØ¯ ÙˆØ§Ø±Ø¯ Ø´ÙˆØ¯ (Ù…Ø«Ù„Ø§Ù‹ Û´.Ûµ Ø¨Ø±Ø§ÛŒ Û´.ÛµÙª)</div>
        </div>
      </div>

      <!-- Ø¨Ø®Ø´ Û²: Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª Ø§ØµÙ„ -->
      <div class="card">
        <div class="card-header">ğŸ“… Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª Ø§ØµÙ„ Ù¾ÙˆÙ„</div>
        
        <div class="auto-split-section">
          <label class="toggle-switch">
            <input type="checkbox" id="autoPrincipalMode" onchange="PrincipalModule.toggleAuto()" />
            <span class="font-semibold text-slate-900">ØªÙ‚Ø³ÛŒÙ… Ø®ÙˆØ¯Ú©Ø§Ø± Ø§ØµÙ„ Ù¾ÙˆÙ„</span>
          </label>
          <div class="help-text mr-7 mt-2">Ø¨Ø§ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ† Ú¯Ø²ÛŒÙ†Ù‡ØŒ Ø³ÛŒØ³ØªÙ… Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø§ØµÙ„ Ù¾ÙˆÙ„ Ø±Ø§ ØªÙ‚Ø³ÛŒÙ… Ù…ÛŒâ€ŒÚ©Ù†Ø¯</div>
          
          <div id="autoPrincipalOptions" class="hidden mt-4">
            <div class="auto-split-controls">
              <div>
                <label class="label">Ø±ÙˆØ´ ØªÙ‚Ø³ÛŒÙ…</label>
                <select id="principalSplitMethod" class="input-field">
                  <option value="equal">ØªÙ‚Ø³ÛŒÙ… Ù…Ø³Ø§ÙˆÛŒ</option>
                  <option value="interval">ØªÙ‚Ø³ÛŒÙ… Ø¨Ø± Ø§Ø³Ø§Ø³ ÙØ§ØµÙ„Ù‡ Ø²Ù…Ø§Ù†ÛŒ</option>
                </select>
                <div class="help-text">Ø±ÙˆØ´ ØªÙ‚Ø³ÛŒÙ… Ø®ÙˆØ¯Ú©Ø§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>
              </div>
              <div id="principalIntervalContainer">
                <label class="label">ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ (Ø±ÙˆØ²)</label>
                <input type="text" id="principalPaymentInterval" class="input-field" value="30" placeholder="Ù…Ø«Ø§Ù„: 30" 
                       oninput="this.value = formatInteger(this.value)" />
                <div class="help-text">ÙØ§ØµÙ„Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ø¨ÛŒÙ† Ù‡Ø± Ù¾Ø±Ø¯Ø§Ø®Øª</div>
              </div>
              <div>
                <label class="label">ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§</label>
                <input type="text" id="numberOfPayments" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 4" 
                       oninput="this.value = formatInteger(this.value)" />
                <div class="help-text">ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ Ù¾ÙˆÙ„</div>
              </div>
            </div>
            <button type="button" onclick="PrincipalModule.calculateAuto()" class="btn btn-primary mt-4">
              ğŸ§® Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø±
            </button>
          </div>
        </div>
        
        <div id="principalRows" class="space-y-3"></div>
        
        <button type="button" onclick="PrincipalModule.addRow()" class="btn btn-secondary mt-3">
          â• Ø§ÙØ²ÙˆØ¯Ù† Ø±Ø¯ÛŒÙ Ù¾Ø±Ø¯Ø§Ø®Øª
        </button>
        
        <div id="totalPrincipal" class="mt-4 p-4 bg-slate-50 rounded-lg"></div>
      </div>

      <!-- Ø¨Ø®Ø´ Û³: ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙˆØ¯ -->
      <div class="card">
        <div class="card-header">ğŸ“† ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙˆØ¯</div>
        
        <div class="auto-split-section">
          <label class="toggle-switch">
            <input type="checkbox" id="autoInterestMode" onchange="InterestModule.toggleAuto()" />
            <span class="font-semibold text-slate-900">ØªÙ‚Ø³ÛŒÙ… Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙˆØ¯</span>
          </label>
          <div class="help-text mr-7 mt-2">Ø¨Ø§ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ† Ú¯Ø²ÛŒÙ†Ù‡ØŒ Ø³ÛŒØ³ØªÙ… Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙˆØ¯ Ø±Ø§ ØªÙ‚Ø³ÛŒÙ… Ù…ÛŒâ€ŒÚ©Ù†Ø¯</div>
          
          <div id="autoInterestOptions" class="hidden mt-4">
            <div class="auto-split-controls">
              <div>
                <label class="label">Ø±ÙˆØ´ ØªÙ‚Ø³ÛŒÙ…</label>
                <select id="interestSplitMethod" class="input-field">
                  <option value="equal">ØªÙ‚Ø³ÛŒÙ… Ù…Ø³Ø§ÙˆÛŒ</option>
                  <option value="interval">ØªÙ‚Ø³ÛŒÙ… Ø¨Ø± Ø§Ø³Ø§Ø³ ÙØ§ØµÙ„Ù‡ Ø²Ù…Ø§Ù†ÛŒ</option>
                </select>
                <div class="help-text">Ø±ÙˆØ´ ØªÙ‚Ø³ÛŒÙ… Ø®ÙˆØ¯Ú©Ø§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>
              </div>
              <div id="interestIntervalContainer">
                <label class="label">ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ (Ø±ÙˆØ²)</label>
                <input type="text" id="interestPaymentInterval" class="input-field" value="90" placeholder="Ù…Ø«Ø§Ù„: 90" 
                       oninput="this.value = formatInteger(this.value)" />
                <div class="help-text">ÙØ§ØµÙ„Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ø¨ÛŒÙ† Ù‡Ø± Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙˆØ¯</div>
              </div>
              <div>
                <label class="label">ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§</label>
                <input type="text" id="numberOfInterestPayments" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 2" 
                       oninput="this.value = formatInteger(this.value)" />
                <div class="help-text">ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ø³ÙˆØ¯</div>
              </div>
            </div>
            <button type="button" onclick="InterestModule.calculateAuto()" class="btn btn-primary mt-4">
              ğŸ§® Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø±
            </button>
          </div>
        </div>
        
        <div id="interestDateRows" class="space-y-3"></div>
        
        <button type="button" onclick="InterestModule.addRow()" class="btn btn-secondary mt-3">
          â• Ø§ÙØ²ÙˆØ¯Ù† ØªØ§Ø±ÛŒØ® Ù¾Ø±Ø¯Ø§Ø®Øª
        </button>
      </div>

      <!-- Ø¨Ø®Ø´ Û´: Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ -->
      <div class="card">
        <div class="card-header">âš™ï¸ Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ø®ØªÛŒØ§Ø±ÛŒ</div>
        
        <!-- Ù…Ø§Ú˜ÙˆÙ„ Ú©Ø§Ø±Ù…Ø²Ø¯ -->
        <div class="mb-4">
          <label class="toggle-switch">
            <input type="checkbox" id="feeModuleEnabled" onchange="FeeModule.toggle()" />
            <span class="font-semibold text-slate-900">ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù…Ø§Ú˜ÙˆÙ„ Ú©Ø§Ø±Ù…Ø²Ø¯</span>
          </label>
          <div id="feeModuleContent" class="module-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="label">Ù†ÙˆØ¹ Ú©Ø§Ø±Ù…Ø²Ø¯</label>
                <select id="feeMode" class="input-field" onchange="FeeModule.updateDisplay()">
                  <option value="percentage">Ø¯Ø±ØµØ¯ÛŒ Ø§Ø² Ø§ØµÙ„ ÙˆØ§Ù…</option>
                  <option value="fixed">Ù…Ø¨Ù„Øº Ø«Ø§Ø¨Øª</option>
                </select>
              </div>
              <div id="feeRateContainer">
                <label class="label">Ù†Ø±Ø® Ú©Ø§Ø±Ù…Ø²Ø¯ (%)</label>
                <input type="text" id="feeRate" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 2" 
                       oninput="this.value = formatDecimal(this.value); FeeModule.updateDisplay()" />
              </div>
              <div id="feeAmountContainer" class="hidden">
                <label class="label">Ù…Ø¨Ù„Øº Ú©Ø§Ø±Ù…Ø²Ø¯ (ØªÙˆÙ…Ø§Ù†)</label>
                <input type="text" id="feeAmount" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 1000000" 
                       oninput="this.value = formatNumber(this.value); FeeModule.updateDisplay()" />
              </div>
            </div>
            <div id="feeDisplay" class="mt-4 p-3 bg-blue-50 rounded-lg hidden">
              <div class="text-sm font-semibold text-slate-700">Ù…Ø¨Ù„Øº Ú©Ø§Ø±Ù…Ø²Ø¯:</div>
              <div id="feeAmountDisplay" class="text-lg font-bold text-blue-700 persian-number"></div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- Ù…Ø§Ú˜ÙˆÙ„ Ø¶Ù…Ø§Ù†Øª -->
        <div class="mb-4">
          <label class="toggle-switch">
            <input type="checkbox" id="guaranteeModuleEnabled" onchange="GuaranteeModule.toggle()" />
            <span class="font-semibold text-slate-900">ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù…Ø§Ú˜ÙˆÙ„ Ø¶Ù…Ø§Ù†Øª</span>
          </label>
          <div id="guaranteeModuleContent" class="module-content hidden">
            <div>
              <label class="label">Ù†Ø±Ø® Ù‡Ø²ÛŒÙ†Ù‡ Ø¶Ù…Ø§Ù†Øª Ø§Ø² Ø§ØµÙ„ ÙˆØ§Ù… (%)</label>
              <input type="text" id="guaranteeRate" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 1.5" 
                     oninput="this.value = formatDecimal(this.value); GuaranteeModule.updateDisplay()" />
              <div class="help-text">Ø¯Ø±ØµØ¯ÛŒ Ø§Ø² Ù…Ø¨Ù„Øº Ø§ØµÙ„ÛŒ ÙˆØ§Ù… Ú©Ù‡ Ø¨Ù‡â€ŒØ¹Ù†ÙˆØ§Ù† Ù‡Ø²ÛŒÙ†Ù‡ Ø¶Ù…Ø§Ù†Øª Ù„Ø­Ø§Ø¸ Ù…ÛŒâ€ŒØ´ÙˆØ¯</div>
            </div>
            <div id="guaranteeDisplay" class="mt-4 p-3 bg-green-50 rounded-lg hidden">
              <div class="text-sm font-semibold text-slate-700">Ù…Ø¨Ù„Øº Ø¶Ù…Ø§Ù†Øª:</div>
              <div id="guaranteeAmountDisplay" class="text-lg font-bold text-green-700 persian-number"></div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- Ù…Ø§Ú˜ÙˆÙ„ Ù…Ø§Ù„ÛŒØ§Øª -->
        <div class="mb-4">
          <label class="toggle-switch">
            <input type="checkbox" id="taxModuleEnabled" onchange="TaxModule.toggle()" />
            <span class="font-semibold text-slate-900">ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù…Ø§Ú˜ÙˆÙ„ Ù…Ø§Ù„ÛŒØ§Øª</span>
          </label>
          <div id="taxModuleContent" class="module-content hidden">
            <div class="help-text mb-4">Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù…Ø§Ù„ÛŒØ§Øªâ€ŒÙ‡Ø§ÛŒÛŒ Ø±Ø§ Ú©Ù‡ Ø¯Ø±ØµØ¯ÛŒ Ø§Ø² Â«Ø³ÙˆØ¯ ÙˆØ§Ù…Â»ØŒ Â«Ù‡Ø²ÛŒÙ†Ù‡ Ú©Ø§Ø±Ù…Ø²Ø¯Â» ÛŒØ§ Â«Ù‡Ø²ÛŒÙ†Ù‡ Ø¶Ù…Ø§Ù†ØªÂ» Ù‡Ø³ØªÙ†Ø¯ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.</div>
            <div id="taxRows" class="space-y-3"></div>
            <button type="button" onclick="TaxModule.addRow()" class="btn btn-secondary mt-3">
              â• Ø§ÙØ²ÙˆØ¯Ù† Ø±Ø¯ÛŒÙ Ù…Ø§Ù„ÛŒØ§Øª
            </button>
            <div id="totalTaxes" class="mt-4 p-4 bg-slate-50 rounded-lg"></div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- Ù…Ø§Ú˜ÙˆÙ„ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ -->
        <div class="mb-4">
          <label class="toggle-switch">
            <input type="checkbox" id="costScheduleModuleEnabled" onchange="CostScheduleModule.toggle()" />
            <span class="font-semibold text-slate-900">ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ ØªÙ‚Ø³ÛŒÙ… Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</span>
          </label>
          <div id="costScheduleModuleContent" class="module-content hidden">
            <div class="help-text mb-4">
              Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ ÛŒÚ©â€ŒØ¨Ø§Ø±Ù‡ (Ú©Ø§Ø±Ù…Ø²Ø¯ØŒ Ø¶Ù…Ø§Ù†Øª Ùˆ Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø§Ù„ÛŒØ§Øªâ€ŒÙ‡Ø§) Ø±Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¯Ø± ÛŒÚ© ÛŒØ§ Ú†Ù†Ø¯ Ø±ÙˆØ² Ø§Ø² Ø¯ÙˆØ±Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ù†ÛŒØ¯. Ù…Ø¬Ù…ÙˆØ¹ Ø¯Ø±ØµØ¯Ù‡Ø§ Ø¨Ø§ÛŒØ¯ Û±Û°Û°Ùª Ø¨Ø§Ø´Ø¯.
            </div>
            
            <!-- Auto-Split Section for Cost Schedule -->
            <div class="auto-split-section">
              <label class="toggle-switch">
                <input type="checkbox" id="autoCostScheduleMode" onchange="CostScheduleModule.toggleAutoSplit()" />
                <span class="font-semibold text-slate-900">ØªÙ‚Ø³ÛŒÙ… Ø®ÙˆØ¯Ú©Ø§Ø± Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</span>
              </label>
              <div class="help-text mr-7 mt-2">Ø¨Ø§ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ† Ú¯Ø²ÛŒÙ†Ù‡ØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± ØªÙ‚Ø³ÛŒÙ… Ú©Ù†ÛŒØ¯</div>
              
              <div id="autoCostScheduleOptions" class="hidden mt-4">
                <div class="auto-split-controls">
                  <div>
                    <label class="label">Ø±ÙˆØ´ ØªÙ‚Ø³ÛŒÙ… Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</label>
                    <select id="costSplitMethod" class="input-field">
                      <option value="equal">ØªÙ‚Ø³ÛŒÙ… Ù…Ø³Ø§ÙˆÛŒ</option>
                      <option value="weighted">ØªÙ‚Ø³ÛŒÙ… Ù…ØªÙ†Ø§Ø³Ø¨ Ø¨Ø§ Ø±ÙˆØ²</option>
                      <option value="normalize">ØªÙ‚Ø³ÛŒÙ… Ø¯Ø±ØµØ¯ÛŒ (Ù¾ÛŒØ´Ø±ÙØªÙ‡)</option>
                    </select>
                    <div class="help-text">Ø±ÙˆØ´ ØªÙ‚Ø³ÛŒÙ… Ø®ÙˆØ¯Ú©Ø§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>
                  </div>
                </div>
                <button type="button" onclick="CostScheduleModule.calculateAuto()" class="btn btn-primary mt-4">
                  ğŸ§® Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø±
                </button>
              </div>
            </div>
            
            <div id="costScheduleRows" class="space-y-3 mt-4"></div>
            <button type="button" onclick="CostScheduleModule.addRow()" class="btn btn-secondary mt-3">
              â• Ø§ÙØ²ÙˆØ¯Ù† Ø±Ø¯ÛŒÙ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ
            </button>
            <div id="costScheduleTotal" class="mt-4 p-4 bg-slate-50 rounded-lg"></div>
          </div>
        </div>
      </div>

      <!-- Ø¯Ú©Ù…Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ -->
      <div class="card">
        <button type="submit" id="submitBtn" class="btn btn-primary w-full py-4 text-lg">
          ğŸ§® Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª
        </button>
      </div>
    </form>

    <!-- Ø¨Ø®Ø´ Ù†ØªØ§ÛŒØ¬ -->
    <div id="results" class="hidden">
      <div class="card">
        <div class="card-header">ğŸ“Š Ø®Ù„Ø§ØµÙ‡ Ù†ØªØ§ÛŒØ¬</div>
        <div id="summaryCards" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        
        <div class="mt-6 flex gap-3">
          <button type="button" onclick="ResultsModule.copyJSON()" class="btn btn-success">
            ğŸ“‹ Ú©Ù¾ÛŒ Ù†ØªØ§ÛŒØ¬ (JSON)
          </button>
          <button type="button" onclick="ResultsModule.downloadJSON()" class="btn btn-success">
            ğŸ’¾ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ JSON
          </button>
          <button type="button" onclick="resetForm()" class="btn btn-secondary">
            ğŸ”„ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¬Ø¯Ø¯
          </button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">ğŸ“‹ Ø¬Ø¯ÙˆÙ„ ØªÙØµÛŒÙ„ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª</div>
        <div class="overflow-x-auto">
          <table id="scheduleTable">
            <thead>
              <tr>
                <th>Ø±ÙˆØ²</th>
                <th>Ø§ØµÙ„ Ù¾ÙˆÙ„ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ (Ù‚Ø¨Ù„)</th>
                <th>Ù¾Ø±Ø¯Ø§Ø®Øª Ø§ØµÙ„ Ù¾ÙˆÙ„</th>
                <th>Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙˆØ¯</th>
                <th>Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</th>
                <th>Ú©Ù„ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ</th>
                <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="scheduleBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script>
    // ============================================================================
    // UTILITY FUNCTIONS
    // ============================================================================

    function toEnglish(str) {
      if (!str) return '';
      const persian = ['Û°', 'Û±', 'Û²', 'Û³', 'Û´', 'Ûµ', 'Û¶', 'Û·', 'Û¸', 'Û¹'];
      const arabic = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
      let result = str.toString();
      persian.forEach((p, i) => result = result.replace(new RegExp(p, 'g'), i));
      arabic.forEach((a, i) => result = result.replace(new RegExp(a, 'g'), i));
      return result;
    }

    function toPersian(num) {
      const persian = ['Û°', 'Û±', 'Û²', 'Û³', 'Û´', 'Ûµ', 'Û¶', 'Û·', 'Û¸', 'Û¹'];
      return num.toString().replace(/\d/g, d => persian[parseInt(d)]);
    }

    function formatToman(num) {
      if (typeof num !== 'number' || isNaN(num)) return 'Û° ØªÙˆÙ…Ø§Ù†';
      const rounded = Math.round(num);
      const formatted = rounded.toLocaleString('en-US');
      return toPersian(formatted) + ' ØªÙˆÙ…Ø§Ù†';
    }

    function parseNumber(str) {
      if (!str) return 0;
      const cleaned = toEnglish(str).replace(/[^\d.]/g, '');
      return parseFloat(cleaned) || 0;
    }

    function formatNumber(str) {
      const cleaned = toEnglish(str).replace(/[^\d]/g, '');
      return cleaned.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function formatInteger(str) {
      const cleaned = toEnglish(str).replace(/[^\d]/g, '');
      return cleaned;
    }

    function formatDecimal(str) {
      let cleaned = toEnglish(str).replace(/[^\d.]/g, '');
      const parts = cleaned.split('.');
      if (parts.length > 2) {
        cleaned = parts[0] + '.' + parts.slice(1).join('');
      }
      const [intPart, decPart] = cleaned.split('.');
      const groupedInt = (intPart || '').replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      return decPart !== undefined ? `${groupedInt}.${decPart}` : groupedInt;
    }

    // ============================================================================
    // AUTOSPLIT MODULE (Unified)
    // ============================================================================

    const AutoSplit = {
      /**
       * Equal distribution: divide 100% equally among all days
       */
      equalSplit(days) {
        if (!Array.isArray(days) || days.length === 0) return [];
        const percent = 100 / days.length;
        return days.map(() => percent);
      },

      /**
       * Weighted by day: distribute based on day values (proportional)
       */
      weightedSplit(days) {
        if (!Array.isArray(days) || days.length === 0) return [];
        const total = days.reduce((sum, day) => sum + day, 0);
        if (total === 0) return this.equalSplit(days);
        return days.map(day => (day / total) * 100);
      },

      /**
       * Normalize entered percentages: scale to sum to 100%
       */
      normalizeSplit(entries) {
        if (!Array.isArray(entries) || entries.length === 0) return [];
        const sum = entries.reduce((s, e) => s + (e.percent || 0), 0);
        if (sum === 0) return this.equalSplit(entries.map(e => e.day));
        const scale = 100 / sum;
        return entries.map(e => (e.percent || 0) * scale);
      },

      /**
       * Apply calculated percentages to rows
       */
      applyToRows(containerSelector, percentages, dayInputName, percentInputName) {
        const rows = document.querySelectorAll(containerSelector + ' .row-item');
        if (rows.length !== percentages.length) {
          console.error('Row count mismatch');
          return false;
        }

        rows.forEach((row, index) => {
          const percentInput = row.querySelector(`[name="${percentInputName}"]`);
          if (percentInput) {
            const percent = percentages[index];
            percentInput.value = percent.toFixed(2);
            // Trigger input event to format
            percentInput.dispatchEvent(new Event('input'));
          }
        });

        return true;
      }
    };

    // ============================================================================
    // LOAN MODULE
    // ============================================================================

    const LoanModule = {
      updateAmountDisplay() {
        const value = document.getElementById('loanAmount').value;
        const num = parseNumber(value);
        const display = document.getElementById('loanAmountDisplay');
        if (num > 0) {
          display.textContent = formatToman(num);
        } else {
          display.textContent = '';
        }
        FeeModule.updateDisplay();
        GuaranteeModule.updateDisplay();
      },

      validateRate() {
        const value = document.getElementById('monthlyRate').value;
        const num = parseNumber(value);
        const errorEl = document.getElementById('monthlyRateError');
        const inputEl = document.getElementById('monthlyRate');
        
        if (value && (num <= 0 || num > 100)) {
          errorEl.textContent = 'Ù†Ø±Ø® Ø³ÙˆØ¯ Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† Û° ØªØ§ Û±Û°Û° Ø¯Ø±ØµØ¯ Ø¨Ø§Ø´Ø¯';
          inputEl.classList.add('error');
        } else {
          errorEl.textContent = '';
          inputEl.classList.remove('error');
        }
      },

      getConfig() {
        const amount = parseNumber(document.getElementById('loanAmount').value);
        const monthlyRate = parseNumber(document.getElementById('monthlyRate').value);
        
        if (amount <= 0 || monthlyRate <= 0 || monthlyRate > 100) {
          return null;
        }
        
        return { amount, monthlyInterestRate: monthlyRate };
      },

      validate() {
        const config = this.getConfig();
        if (!config) {
          alert('Ù„Ø·ÙØ§Ù‹ Ù…Ø¨Ù„Øº ÙˆØ§Ù… Ùˆ Ù†Ø±Ø® Ø³ÙˆØ¯ Ø±Ø§ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
          return false;
        }
        return true;
      }
    };

    // ============================================================================
    // PRINCIPAL MODULE
    // ============================================================================

    const PrincipalModule = {
      init() {
        this.addRow();
      },

      toggleAuto() {
        const isChecked = document.getElementById('autoPrincipalMode').checked;
        const options = document.getElementById('autoPrincipalOptions');
        const rows = document.getElementById('principalRows');
        
        if (isChecked) {
          options.classList.remove('hidden');
          rows.innerHTML = '';
        } else {
          options.classList.add('hidden');
          if (rows.children.length === 0) {
            this.addRow();
          }
        }
      },

      calculateAuto() {
        if (!document.getElementById('autoPrincipalMode').checked) return;
        
        const loanAmount = parseNumber(document.getElementById('loanAmount').value);
        const method = document.getElementById('principalSplitMethod').value;
        const numPayments = parseInt(formatInteger(document.getElementById('numberOfPayments').value)) || 0;
        const interval = parseInt(formatInteger(document.getElementById('principalPaymentInterval').value)) || 30;
        
        if (loanAmount <= 0) {
          alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ù…Ø¨Ù„Øº ÙˆØ§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
          return;
        }
        
        if (numPayments <= 0) {
          alert('ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ø¨Ø²Ø±Ú¯â€ŒØªØ± Ø§Ø² ØµÙØ± Ø¨Ø§Ø´Ø¯');
          return;
        }
        
        if (method === 'interval' && interval <= 0) {
          alert('ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ø¨Ø²Ø±Ú¯â€ŒØªØ± Ø§Ø² ØµÙØ± Ø¨Ø§Ø´Ø¯');
          return;
        }
        
        const rows = document.getElementById('principalRows');
        rows.innerHTML = '';
        
        const amountPerPayment = Math.floor(loanAmount / numPayments);
        const remainder = loanAmount - (amountPerPayment * numPayments);
        
        for (let i = 0; i < numPayments; i++) {
          const days = method === 'interval' ? (i + 1) * interval : (i + 1) * Math.ceil(365 / numPayments);
          const amount = i === numPayments - 1 ? amountPerPayment + remainder : amountPerPayment;
          
          const div = document.createElement('div');
          div.className = 'row-item';
          div.innerHTML = `
            <div>
              <label class="label">Ø±ÙˆØ²</label>
              <input type="text" name="principalDay" class="input-field" value="${days}" />
              <div class="help-text">Ø±ÙˆØ² Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ² Ø§Ø² Ø´Ø±ÙˆØ¹ ÙˆØ§Ù… ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
            </div>
            <div>
              <label class="label">Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</label>
              <input type="text" name="principalAmount" class="input-field" value="${formatNumber(amount.toString())}" 
                     oninput="this.value = formatNumber(this.value); PrincipalModule.updateTotal()" />
            </div>
            <button type="button" onclick="this.parentElement.remove(); PrincipalModule.updateTotal()" class="remove-btn">Ã—</button>
          `;
          rows.appendChild(div);
        }
        
        this.updateTotal();
      },

      addRow() {
        if (document.getElementById('autoPrincipalMode').checked) return;
        const container = document.getElementById('principalRows');
        const div = document.createElement('div');
        div.className = 'row-item';
        div.innerHTML = `
          <div>
            <label class="label">Ø±ÙˆØ²</label>
            <input type="text" name="principalDay" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 60" />
            <div class="help-text">Ø±ÙˆØ² Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ² Ø§Ø² Ø´Ø±ÙˆØ¹ ÙˆØ§Ù… ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
          </div>
          <div>
            <label class="label">Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</label>
            <input type="text" name="principalAmount" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 30000000" 
                   oninput="this.value = formatNumber(this.value); PrincipalModule.updateTotal()" />
          </div>
          <button type="button" onclick="this.parentElement.remove(); PrincipalModule.updateTotal()" class="remove-btn">Ã—</button>
        `;
        container.appendChild(div);
      },

      updateTotal() {
        const rows = document.querySelectorAll('[name="principalAmount"]');
        let total = 0;
        rows.forEach(row => total += parseNumber(row.value));
        const loanAmount = parseNumber(document.getElementById('loanAmount').value);
        const display = document.getElementById('totalPrincipal');
        
        display.innerHTML = `
          <div class="flex items-center justify-between">
            <span class="font-semibold">Ù…Ø¬Ù…ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ Ù¾ÙˆÙ„:</span>
            <span class="text-lg font-bold ${Math.abs(total - loanAmount) <= 1 ? 'text-green-600' : 'text-red-600'} persian-number">
              ${formatToman(total)}
            </span>
          </div>
          ${loanAmount > 0 ? `
            <div class="mt-2 flex items-center justify-between">
              <span class="text-sm text-slate-600">Ù…Ø¨Ù„Øº ÙˆØ§Ù…:</span>
              <span class="text-sm font-semibold persian-number">${formatToman(loanAmount)}</span>
            </div>
          ` : ''}
          ${Math.abs(total - loanAmount) <= 1 && loanAmount > 0 ? 
            '<p class="text-green-600 text-sm mt-2">âœ“ Ù…Ø¬Ù…ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ Ø¨Ø§ Ù…Ø¨Ù„Øº ÙˆØ§Ù… Ù…Ø·Ø§Ø¨Ù‚Øª Ø¯Ø§Ø±Ø¯</p>' : ''}
        `;
      },

      getConfig() {
        const repayments = [];
        document.querySelectorAll('[name="principalDay"]').forEach((dayInput, index) => {
          const day = parseInt(toEnglish(dayInput.value));
          const amount = parseNumber(document.querySelectorAll('[name="principalAmount"]')[index].value);
          if (day > 0 && amount > 0) {
            repayments.push({ days: day, amount: amount });
          }
        });
        return repayments;
      },

      validate() {
        const repayments = this.getConfig();
        if (repayments.length === 0) {
          alert('Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ù¾Ø±Ø¯Ø§Ø®Øª Ø§ØµÙ„ Ù¾ÙˆÙ„ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
          return false;
        }
        return true;
      }
    };

    // ============================================================================
    // INTEREST MODULE
    // ============================================================================

    const InterestModule = {
      init() {
        this.addRow();
      },

      toggleAuto() {
        const isChecked = document.getElementById('autoInterestMode').checked;
        const options = document.getElementById('autoInterestOptions');
        const rows = document.getElementById('interestDateRows');
        
        if (isChecked) {
          options.classList.remove('hidden');
          rows.innerHTML = '';
        } else {
          options.classList.add('hidden');
          if (rows.children.length === 0) {
            this.addRow();
          }
        }
      },

      calculateAuto() {
        if (!document.getElementById('autoInterestMode').checked) return;
        
        const method = document.getElementById('interestSplitMethod').value;
        const numPayments = parseInt(formatInteger(document.getElementById('numberOfInterestPayments').value)) || 0;
        const interval = parseInt(formatInteger(document.getElementById('interestPaymentInterval').value)) || 90;
        
        if (numPayments <= 0) {
          alert('ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ø¨Ø²Ø±Ú¯â€ŒØªØ± Ø§Ø² ØµÙØ± Ø¨Ø§Ø´Ø¯');
          return;
        }
        
        if (method === 'interval' && interval <= 0) {
          alert('ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ø¨Ø²Ø±Ú¯â€ŒØªØ± Ø§Ø² ØµÙØ± Ø¨Ø§Ø´Ø¯');
          return;
        }
        
        const rows = document.getElementById('interestDateRows');
        rows.innerHTML = '';
        
        for (let i = 0; i < numPayments; i++) {
          const days = method === 'interval' ? (i + 1) * interval : (i + 1) * Math.ceil(365 / numPayments);
          
          const div = document.createElement('div');
          div.className = 'row-item';
          div.innerHTML = `
            <div>
              <label class="label">Ø±ÙˆØ²</label>
              <input type="text" name="interestDate" class="input-field" value="${days}" />
              <div class="help-text">Ø±ÙˆØ² Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ² Ø§Ø² Ø´Ø±ÙˆØ¹ ÙˆØ§Ù… ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
            </div>
            <button type="button" onclick="this.parentElement.remove()" class="remove-btn">Ã—</button>
          `;
          rows.appendChild(div);
        }
      },

      addRow() {
        if (document.getElementById('autoInterestMode').checked) return;
        const container = document.getElementById('interestDateRows');
        const div = document.createElement('div');
        div.className = 'row-item';
        div.innerHTML = `
          <div>
            <label class="label">Ø±ÙˆØ²</label>
            <input type="text" name="interestDate" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 180" />
            <div class="help-text">Ø±ÙˆØ² Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ² Ø§Ø² Ø´Ø±ÙˆØ¹ ÙˆØ§Ù… ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
          </div>
          <button type="button" onclick="this.parentElement.remove()" class="remove-btn">Ã—</button>
        `;
        container.appendChild(div);
      },

      getConfig() {
        const dates = [];
        document.querySelectorAll('[name="interestDate"]').forEach(input => {
          const day = parseInt(toEnglish(input.value));
          if (day > 0) dates.push(day);
        });
        return dates;
      },

      validate() {
        const dates = this.getConfig();
        if (dates.length === 0) {
          alert('Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© ØªØ§Ø±ÛŒØ® Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙˆØ¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
          return false;
        }
        return true;
      }
    };

    // ============================================================================
    // FEE MODULE
    // ============================================================================

    const FeeModule = {
      toggle() {
        const isEnabled = document.getElementById('feeModuleEnabled').checked;
        const content = document.getElementById('feeModuleContent');
        if (isEnabled) {
          content.classList.remove('hidden');
        } else {
          content.classList.add('hidden');
        }
      },

      updateDisplay() {
        const mode = document.getElementById('feeMode').value;
        const loanAmount = parseNumber(document.getElementById('loanAmount').value);
        
        document.getElementById('feeRateContainer').classList.toggle('hidden', mode !== 'percentage');
        document.getElementById('feeAmountContainer').classList.toggle('hidden', mode !== 'fixed');
        
        const config = this.getConfig();
        const display = document.getElementById('feeDisplay');
        
        if (!config || loanAmount <= 0) {
          display.classList.add('hidden');
          return;
        }
        
        let feeAmount = 0;
        if (config.mode === 'percentage') {
          feeAmount = loanAmount * (config.rate / 100);
        } else if (config.mode === 'fixed') {
          feeAmount = config.amount;
        }
        
        document.getElementById('feeAmountDisplay').textContent = formatToman(feeAmount);
        display.classList.remove('hidden');
        TaxModule.updateAll();
      },

      getConfig() {
        if (!document.getElementById('feeModuleEnabled').checked) {
          return null;
        }
        
        const mode = document.getElementById('feeMode').value;
        if (mode === 'percentage') {
          const rate = parseNumber(document.getElementById('feeRate').value);
          if (rate > 0) {
            return { mode, rate };
          }
        } else if (mode === 'fixed') {
          const amount = parseNumber(document.getElementById('feeAmount').value);
          if (amount > 0) {
            return { mode, amount };
          }
        }
        return null;
      },

      clear() {
        document.getElementById('feeModuleEnabled').checked = false;
        document.getElementById('feeMode').value = 'percentage';
        document.getElementById('feeRate').value = '';
        document.getElementById('feeAmount').value = '';
        this.toggle();
      }
    };

    // ============================================================================
    // GUARANTEE MODULE
    // ============================================================================

    const GuaranteeModule = {
      toggle() {
        const isEnabled = document.getElementById('guaranteeModuleEnabled').checked;
        const content = document.getElementById('guaranteeModuleContent');
        if (isEnabled) {
          content.classList.remove('hidden');
        } else {
          content.classList.add('hidden');
        }
      },

      updateDisplay() {
        const loanAmount = parseNumber(document.getElementById('loanAmount').value);
        const config = this.getConfig();
        const display = document.getElementById('guaranteeDisplay');
        
        if (!config || loanAmount <= 0) {
          display.classList.add('hidden');
          return;
        }
        
        const guaranteeAmount = loanAmount * (config.rate / 100);
        document.getElementById('guaranteeAmountDisplay').textContent = formatToman(guaranteeAmount);
        display.classList.remove('hidden');
        TaxModule.updateAll();
      },

      getConfig() {
        if (!document.getElementById('guaranteeModuleEnabled').checked) {
          return null;
        }
        
        const rate = parseNumber(document.getElementById('guaranteeRate').value);
        if (rate > 0) {
          return { rate };
        }
        return null;
      },

      clear() {
        document.getElementById('guaranteeModuleEnabled').checked = false;
        document.getElementById('guaranteeRate').value = '';
        this.toggle();
      }
    };

    // ============================================================================
    // TAX MODULE
    // ============================================================================

    const TaxModule = {
      toggle() {
        const isEnabled = document.getElementById('taxModuleEnabled').checked;
        const content = document.getElementById('taxModuleContent');
        if (isEnabled) {
          content.classList.remove('hidden');
          if (document.getElementById('taxRows').children.length === 0) {
            this.addRow();
          }
        } else {
          content.classList.add('hidden');
        }
      },

      addRow() {
        const container = document.getElementById('taxRows');
        const div = document.createElement('div');
        div.className = 'row-item';
        div.innerHTML = `
          <div>
            <label class="label">Ù¾Ø§ÛŒÙ‡ Ù…Ø­Ø§Ø³Ø¨Ù‡</label>
            <select name="taxBase" class="input-field" onchange="TaxModule.updateAll()">
              <option value="interest">Ø³ÙˆØ¯ ÙˆØ§Ù…</option>
              <option value="fees">Ù‡Ø²ÛŒÙ†Ù‡ Ú©Ø§Ø±Ù…Ø²Ø¯</option>
              <option value="guarantee">Ù‡Ø²ÛŒÙ†Ù‡ Ø¶Ù…Ø§Ù†Øª</option>
            </select>
          </div>
          <div>
            <label class="label">Ù†Ø±Ø® Ù…Ø§Ù„ÛŒØ§Øª (%)</label>
            <input type="text" name="taxRate" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 9" 
                   oninput="this.value = formatDecimal(this.value); TaxModule.updateAll()" />
          </div>
          <div class="self-end">
            <div class="text-xs text-slate-600 mb-1">Ù…Ø¨Ù„Øº Ù…Ø§Ù„ÛŒØ§Øª</div>
            <div class="font-bold text-blue-700 tax-amount persian-number">Û° ØªÙˆÙ…Ø§Ù†</div>
          </div>
          <button type="button" onclick="this.parentElement.remove(); TaxModule.updateAll()" class="remove-btn">Ã—</button>
        `;
        container.appendChild(div);
        this.updateAll();
      },

      updateAll() {
        const loanAmount = parseNumber(document.getElementById('loanAmount').value);
        const feeConfig = FeeModule.getConfig();
        const guaranteeConfig = GuaranteeModule.getConfig();
        
        let feeAmount = 0;
        if (feeConfig) {
          if (feeConfig.mode === 'percentage') {
            feeAmount = loanAmount * (feeConfig.rate / 100);
          } else if (feeConfig.mode === 'fixed') {
            feeAmount = feeConfig.amount;
          }
        }
        
        let guaranteeAmount = 0;
        if (guaranteeConfig) {
          guaranteeAmount = loanAmount * (guaranteeConfig.rate / 100);
        }
        
        const baseValues = {
          interest: 0,
          fees: feeAmount,
          guarantee: guaranteeAmount
        };
        
        let total = 0;
        document.querySelectorAll('#taxRows .row-item').forEach(row => {
          const baseSel = row.querySelector('[name="taxBase"]');
          const rateInput = row.querySelector('[name="taxRate"]');
          const amountEl = row.querySelector('.tax-amount');
          
          if (!baseSel || !rateInput || !amountEl) return;
          
          const base = baseSel.value;
          const rate = parseNumber(rateInput.value);
          let baseAmount = baseValues[base] || 0;
          
          const taxAmount = baseAmount * (rate / 100);
          amountEl.textContent = formatToman(taxAmount || 0);
          total += taxAmount;
        });
        
        const totalBox = document.getElementById('totalTaxes');
        if (totalBox) {
          totalBox.innerHTML = total > 0 ? `
            <div class="flex items-center justify-between">
              <span class="font-semibold">Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø§Ù„ÛŒØ§Øªâ€ŒÙ‡Ø§:</span>
              <span class="text-lg font-bold text-blue-700 persian-number">${formatToman(total)}</span>
            </div>
          ` : '';
        }
      },

      getConfig() {
        if (!document.getElementById('taxModuleEnabled').checked) {
          return null;
        }
        
        const taxes = [];
        document.querySelectorAll('#taxRows .row-item').forEach(row => {
          const base = row.querySelector('[name="taxBase"]').value;
          const rate = parseNumber(row.querySelector('[name="taxRate"]').value);
          if (base && rate > 0) {
            taxes.push({ base, rate });
          }
        });
        
        return taxes.length > 0 ? taxes : null;
      },

      clear() {
        document.getElementById('taxModuleEnabled').checked = false;
        document.getElementById('taxRows').innerHTML = '';
        document.getElementById('totalTaxes').innerHTML = '';
        this.toggle();
      }
    };

    // ============================================================================
    // COST SCHEDULE MODULE
    // ============================================================================

    const CostScheduleModule = {
      toggle() {
        const isEnabled = document.getElementById('costScheduleModuleEnabled').checked;
        const content = document.getElementById('costScheduleModuleContent');
        if (isEnabled) {
          content.classList.remove('hidden');
          if (document.getElementById('costScheduleRows').children.length === 0) {
            this.addRow();
          }
        } else {
          content.classList.add('hidden');
        }
      },

      toggleAutoSplit() {
        const isEnabled = document.getElementById('autoCostScheduleMode').checked;
        const options = document.getElementById('autoCostScheduleOptions');
        if (isEnabled) {
          options.classList.remove('hidden');
        } else {
          options.classList.add('hidden');
        }
      },

      calculateAuto() {
        if (!document.getElementById('autoCostScheduleMode').checked) return;
        
        const method = document.getElementById('costSplitMethod').value;
        const rows = document.querySelectorAll('#costScheduleRows .row-item');
        
        if (rows.length === 0) {
          alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ÛŒ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯');
          return;
        }
        
        // Collect days and existing percentages
        const entries = [];
        let hasInvalidDay = false;
        
        rows.forEach(row => {
          const dayInput = row.querySelector('[name="costDay"]');
          const percentInput = row.querySelector('[name="costPercent"]');
          const day = parseInt(toEnglish(dayInput.value));
          const percent = parseNumber(percentInput.value);
          
          if (day <= 0) {
            hasInvalidDay = true;
            dayInput.classList.add('error');
          } else {
            dayInput.classList.remove('error');
          }
          
          entries.push({ day, percent });
        });
        
        if (hasInvalidDay) {
          alert('Ø±ÙˆØ² Ø¨Ø§ÛŒØ¯ Ø¨Ø²Ø±Ú¯â€ŒØªØ± Ø§Ø² ØµÙØ± Ø¨Ø§Ø´Ø¯');
          return;
        }
        
        // Calculate percentages based on method
        let percentages = [];
        const days = entries.map(e => e.day);
        
        if (method === 'equal') {
          percentages = AutoSplit.equalSplit(days);
        } else if (method === 'weighted') {
          percentages = AutoSplit.weightedSplit(days);
        } else if (method === 'normalize') {
          percentages = AutoSplit.normalizeSplit(entries);
        }
        
        // Apply to rows
        AutoSplit.applyToRows('#costScheduleRows', percentages, 'costDay', 'costPercent');
        
        // Update total display
        this.updateTotal();
      },

      addRow() {
        const container = document.getElementById('costScheduleRows');
        const div = document.createElement('div');
        div.className = 'row-item';
        div.innerHTML = `
          <div>
            <label class="label">Ø±ÙˆØ² Ù¾Ø±Ø¯Ø§Ø®Øª</label>
            <input type="text" name="costDay" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 30" 
                   oninput="this.value = formatInteger(this.value); CostScheduleModule.updateTotal()" />
            <div class="help-text">Ø±ÙˆØ² Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ² Ø§Ø² Ø´Ø±ÙˆØ¹ ÙˆØ§Ù… ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
          </div>
          <div>
            <label class="label">Ø³Ù‡Ù… Ø§Ø² Ú©Ù„ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ (%)</label>
            <input type="text" name="costPercent" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 100" 
                   oninput="this.value = formatDecimal(this.value); CostScheduleModule.updateTotal()" />
            <div class="help-text">Ø¯Ø±ØµØ¯ Ø³Ù‡Ù… Ø§ÛŒÙ† Ø±ÙˆØ² Ø§Ø² Ú©Ù„ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</div>
          </div>
          <button type="button" onclick="this.parentElement.remove(); CostScheduleModule.updateTotal()" class="remove-btn">Ã—</button>
        `;
        container.appendChild(div);
        this.updateTotal();
      },

      updateTotal() {
        const rows = document.querySelectorAll('[name="costPercent"]');
        let total = 0;
        rows.forEach(row => total += parseNumber(row.value));
        
        const display = document.getElementById('costScheduleTotal');
        const isValid = Math.abs(total - 100) < 0.01;
        
        display.innerHTML = `
          <div class="flex items-center justify-between">
            <span class="font-semibold">Ù…Ø¬Ù…ÙˆØ¹ Ø¯Ø±ØµØ¯Ù‡Ø§:</span>
            <span class="text-lg font-bold ${isValid ? 'text-green-600' : 'text-red-600'} persian-number">
              ${total.toFixed(2)}%
            </span>
          </div>
          ${isValid ? 
            '<p class="text-green-600 text-sm mt-2">âœ“ Ù…Ø¬Ù…ÙˆØ¹ Ø¯Ø±ØµØ¯Ù‡Ø§ Ø¨Ø±Ø§Ø¨Ø± Û±Û°Û°Ùª Ø§Ø³Øª</p>' : 
            '<p class="text-red-600 text-sm mt-2">âš  Ù…Ø¬Ù…ÙˆØ¹ Ø¯Ø±ØµØ¯Ù‡Ø§ Ø¨Ø§ÛŒØ¯ Ø¨Ø±Ø§Ø¨Ø± Û±Û°Û°Ùª Ø¨Ø§Ø´Ø¯</p>'}
        `;
      },

      getConfig() {
        if (!document.getElementById('costScheduleModuleEnabled').checked) {
          return null;
        }
        
        const schedule = [];
        document.querySelectorAll('[name="costDay"]').forEach((dayInput, index) => {
          const day = parseInt(toEnglish(dayInput.value));
          const percent = parseNumber(document.querySelectorAll('[name="costPercent"]')[index].value);
          if (day > 0 && percent >= 0) {
            schedule.push({ day, percent });
          }
        });
        
        return schedule.length > 0 ? schedule : null;
      },

      clear() {
        document.getElementById('costScheduleModuleEnabled').checked = false;
        document.getElementById('autoCostScheduleMode').checked = false;
        document.getElementById('costScheduleRows').innerHTML = '';
        document.getElementById('costScheduleTotal').innerHTML = '';
        this.toggle();
        this.toggleAutoSplit();
      }
    };

    // ============================================================================
    // RESULTS MODULE
    // ============================================================================

    const ResultsModule = {
      display(data) {
        const schedule = data.schedule || [];
        const summary = data.summary?._raw || data.summary || {};
        
        const summaryCards = document.getElementById('summaryCards');
        summaryCards.innerHTML = `
          <div class="summary-card">
            <div class="summary-item">
              <span class="summary-label">Ù…Ø¬Ù…ÙˆØ¹ Ø³ÙˆØ¯ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ</span>
              <span class="summary-value persian-number">${formatToman(summary.totalInterestPaid || 0)}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Ù…Ø¬Ù…ÙˆØ¹ Ú©Ø§Ø±Ù…Ø²Ø¯Ù‡Ø§ÛŒ Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ</span>
              <span class="summary-value persian-number">${formatToman(summary.totalUpfrontFees || 0)}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø§Ù„ÛŒØ§Øªâ€ŒÙ‡Ø§</span>
              <span class="summary-value persian-number">${formatToman(summary.totalTaxes || 0)}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª</span>
              <span class="summary-value persian-number">${toPersian(summary.finalDay || 0)} Ø±ÙˆØ²</span>
            </div>
          </div>
        `;
        
        const paymentDays = schedule.filter(d => {
          const raw = d._raw || {};
          return (raw.principalPayment > 0 || raw.interestPayment > 0 || raw.costPayment > 0);
        });
        const firstDay = schedule[0];
        const lastDay = schedule[schedule.length - 1];
        const daysToShow = [firstDay, ...paymentDays, lastDay]
          .filter((d, i, arr) => arr.findIndex(x => (x._raw?.day || x.Ø±ÙˆØ²) === (d._raw?.day || d.Ø±ÙˆØ²)) === i)
          .sort((a, b) => (a._raw?.day || a.Ø±ÙˆØ² || 0) - (b._raw?.day || b.Ø±ÙˆØ² || 0));
        
        const tbody = document.getElementById('scheduleBody');
        tbody.innerHTML = daysToShow.map(day => {
          const raw = day._raw || {};
          const dayNum = raw.day || day.Ø±ÙˆØ² || 0;
          const principalBefore = raw.remainingPrincipalBefore || 0;
          const principalPayment = raw.principalPayment || 0;
          const interestPayment = raw.interestPayment || 0;
          const costPayment = raw.costPayment || 0;
          const totalPayment = raw.totalPayment || 0;
          const description = day.ØªÙˆØ¶ÛŒØ­Ø§Øª || 'Ù‡ÛŒÚ† Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯';
          const isPayment = principalPayment > 0 || interestPayment > 0 || costPayment > 0;
          
          return `
            <tr class="${isPayment ? 'bg-blue-50' : ''}">
              <td class="font-semibold persian-number">${toPersian(dayNum)}</td>
              <td class="persian-number">${formatToman(principalBefore)}</td>
              <td class="persian-number">${principalPayment > 0 ? `<span class="font-semibold text-green-600">${formatToman(principalPayment)}</span>` : '<span class="text-slate-400">-</span>'}</td>
              <td class="persian-number">${interestPayment > 0 ? `<span class="font-semibold text-orange-600">${formatToman(interestPayment)}</span>` : '<span class="text-slate-400">-</span>'}</td>
              <td class="persian-number">${costPayment > 0 ? `<span class="font-semibold text-amber-600">${formatToman(costPayment)}</span>` : '<span class="text-slate-400">-</span>'}</td>
              <td class="persian-number">${totalPayment > 0 ? `<span class="font-semibold text-blue-600">${formatToman(totalPayment)}</span>` : '<span class="text-slate-400">-</span>'}</td>
              <td class="text-sm text-slate-600">${description}</td>
            </tr>
          `;
        }).join('');
        
        window.lastCalculationResult = data;
        
        document.getElementById('results').classList.remove('hidden');
        document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
      },

      copyJSON() {
        if (!window.lastCalculationResult) {
          alert('Ù‡ÛŒÚ† Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
          return;
        }
        
        const json = JSON.stringify(window.lastCalculationResult, null, 2);
        navigator.clipboard.writeText(json).then(() => {
          alert('Ù†ØªØ§ÛŒØ¬ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ú©Ù¾ÛŒ Ø´Ø¯');
        }).catch(() => {
          alert('Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† Ù†ØªØ§ÛŒØ¬');
        });
      },

      downloadJSON() {
        if (!window.lastCalculationResult) {
          alert('Ù‡ÛŒÚ† Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
          return;
        }
        
        const json = JSON.stringify(window.lastCalculationResult, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `loan-calculation-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
    };

    // ============================================================================
    // FORM SUBMISSION
    // ============================================================================

    document.getElementById('calculatorForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!LoanModule.validate()) return;
      if (!PrincipalModule.validate()) return;
      if (!InterestModule.validate()) return;
      
      const loanConfig = LoanModule.getConfig();
      const principalRepayments = PrincipalModule.getConfig();
      const interestPaymentDates = InterestModule.getConfig();
      
      const payload = {
        Loan: {
          amount: loanConfig.amount,
          monthlyInterestRate: loanConfig.monthlyInterestRate,
          principalRepayments: principalRepayments,
          interestPaymentDates: interestPaymentDates
        },
        Modules: {}
      };
      
      const feeConfig = FeeModule.getConfig();
      if (feeConfig) {
        payload.Modules.fee = feeConfig;
      }
      
      const guaranteeConfig = GuaranteeModule.getConfig();
      if (guaranteeConfig) {
        payload.Modules.guarantee = guaranteeConfig;
      }
      
      const taxConfig = TaxModule.getConfig();
      if (taxConfig) {
        payload.Modules.taxes = taxConfig;
      }
      
      const costScheduleConfig = CostScheduleModule.getConfig();
      if (costScheduleConfig) {
        payload.Modules.costSchedule = costScheduleConfig;
      }
      
      const submitBtn = document.getElementById('submitBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading"></span> Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡...';
      
      try {
        const response = await fetch('https://n8nb2wall.darkube.app/webhook/calculate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
          throw new Error(`Ø®Ø·Ø§ÛŒ HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.message || data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡');
        }
        
        ResultsModule.display(data);
      } catch (error) {
        alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±: ' + error.message);
        console.error('Error:', error);
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    });

    // ============================================================================
    // INITIALIZATION
    // ============================================================================

    function resetForm() {
      document.getElementById('calculatorForm').reset();
      document.getElementById('loanAmountDisplay').textContent = '';
      document.getElementById('totalPrincipal').innerHTML = '';
      document.getElementById('results').classList.add('hidden');
      
      PrincipalModule.init();
      InterestModule.init();
      FeeModule.clear();
      GuaranteeModule.clear();
      TaxModule.clear();
      CostScheduleModule.clear();
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    document.addEventListener('DOMContentLoaded', function() {
      PrincipalModule.init();
      InterestModule.init();
    });
  </script>
</body>
</html>
