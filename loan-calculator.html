<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒÚ¯Ø± Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª ÙˆØ§Ù… | B2Wall</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Vazirmatn', system-ui, -apple-system, sans-serif; background: #f8fafc; }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 1.25rem; box-shadow: 0 4px 16px rgba(0,0,0,0.04); }
    .input-clean { width: 100%; padding: 0.875rem 1rem; border: 2px solid #e2e8f0; border-radius: 0.875rem; font-size: 1.125rem; font-weight: 600; transition: all 0.2s; background: #fff; font-family: 'Vazirmatn', system-ui; font-feature-settings: "tnum"; }
    .input-clean:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.875rem 1.5rem; border-radius: 0.875rem; font-weight: 700; transition: all 0.2s; cursor: pointer; border: none; font-size: 1rem; }
    .btn-primary { background: #2563eb; color: #fff; box-shadow: 0 4px 12px rgba(37,99,235,0.3); }
    .btn-primary:hover { background: #1d4ed8; transform: translateY(-1px); }
    table { width: 100%; border-collapse: separate; border-spacing: 0; }
    th, td { padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; }
    th { background: #f1f5f9; font-weight: 700; }
    tr:hover { background: #f8fafc; }
  </style>
</head>
<body class="min-h-screen bg-slate-50">
  <header class="bg-white border-b border-slate-200 shadow-sm">
    <div class="max-w-6xl mx-auto px-4 py-6">
      <h1 class="text-2xl font-bold text-slate-900">Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒÚ¯Ø± Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª ÙˆØ§Ù…</h1>
      <p class="text-sm text-slate-600 mt-1">Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ø¯Ù‚ÛŒÙ‚ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª ÙˆØ§Ù… Ø¨Ø§ Ø¬Ø¯ÙˆÙ„ ØªÙØµÛŒÙ„ÛŒ</p>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8">
    <form id="calculatorForm" class="space-y-6">
      <!-- Ù…Ø¨Ù„Øº ÙˆØ§Ù… -->
      <div class="card p-6">
        <label class="block text-sm font-semibold text-slate-700 mb-2">
          Ù…Ø¨Ù„Øº ÙˆØ§Ù… <span class="text-red-500">*</span>
        </label>
        <input type="text" id="loanAmount" placeholder="Ù…Ø«Ø§Ù„: 330000000" class="input-clean" dir="ltr" />
        <div id="loanAmountDisplay" class="mt-2 text-sm font-semibold text-blue-600" dir="rtl" style="font-family: 'Vazirmatn'; font-feature-settings: 'tnum';"></div>
        <p class="text-xs text-slate-500 mt-2">ğŸ’¡ Ù…Ø¨Ù„Øº Ú©Ù„ ÙˆØ§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</p>
      </div>

      <!-- Ù†Ø±Ø® Ø³ÙˆØ¯ -->
      <div class="card p-6">
        <label class="block text-sm font-semibold text-slate-700 mb-2">
          Ù†Ø±Ø® Ø³ÙˆØ¯ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ (%) <span class="text-red-500">*</span>
        </label>
        <input type="text" id="monthlyRate" placeholder="Ù…Ø«Ø§Ù„: 4.5" class="input-clean" dir="ltr" />
        <p class="text-xs text-slate-500 mt-2">ğŸ’¡ Ù†Ø±Ø® Ø³ÙˆØ¯ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø±ØµØ¯ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡</p>
      </div>

      <!-- Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø³ÙˆØ¯ -->
      <div id="estimatedInterest" class="hidden card p-4 bg-amber-50 border border-amber-200">
        <div class="flex items-center justify-between">
          <span class="text-sm font-semibold text-amber-900">ğŸ’° Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø³ÙˆØ¯ ØªÙ‚Ø±ÛŒØ¨ÛŒ:</span>
          <span id="estimatedInterestAmount" class="text-lg font-bold text-amber-700" dir="rtl" style="font-family: 'Vazirmatn'; font-feature-settings: 'tnum';"></span>
        </div>
        <p class="text-xs text-amber-700 mt-1">Ø§ÛŒÙ† Ù…Ø¨Ù„Øº ØªÙ‚Ø±ÛŒØ¨ÛŒ Ø§Ø³Øª Ùˆ Ù¾Ø³ Ø§Ø² Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ù‚ÛŒÙ‚ Ù…Ù…Ú©Ù† Ø§Ø³Øª ØªØºÛŒÛŒØ± Ú©Ù†Ø¯</p>
      </div>

      <!-- Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ Ù¾ÙˆÙ„ -->
      <div class="card p-6">
        <div class="flex items-center justify-between mb-4">
          <label class="block text-sm font-semibold text-slate-700">
            Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ Ù¾ÙˆÙ„ <span class="text-red-500">*</span>
          </label>
          <button type="button" id="addPrincipalBtn" onclick="addPrincipalRow()" class="btn btn-secondary text-sm py-2 px-4">+ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù†</button>
        </div>
        
        <!-- ØªÙ‚Ø³ÛŒÙ… Ø®ÙˆØ¯Ú©Ø§Ø± Ø§ØµÙ„ Ù¾ÙˆÙ„ -->
        <div class="mb-4 bg-blue-50 p-3 rounded-lg border border-blue-200">
          <label class="flex items-center cursor-pointer">
            <input type="checkbox" id="autoPrincipalMode" onchange="toggleAutoPrincipal()" class="ml-3 w-4 h-4 text-blue-600 rounded" />
            <span class="text-sm font-semibold text-slate-900">ØªÙ‚Ø³ÛŒÙ… Ø®ÙˆØ¯Ú©Ø§Ø± Ø§ØµÙ„ Ù¾ÙˆÙ„</span>
          </label>
          <p class="text-xs text-slate-600 mt-1 mr-7">Ø¨Ø§ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ† Ú¯Ø²ÛŒÙ†Ù‡ØŒ Ø³ÛŒØ³ØªÙ… Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø§ØµÙ„ Ù¾ÙˆÙ„ Ø±Ø§ ØªÙ‚Ø³ÛŒÙ… Ù…ÛŒâ€ŒÚ©Ù†Ø¯</p>
          
          <div id="autoPrincipalOptions" class="hidden mt-4 grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs text-slate-600 mb-1">ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§</label>
              <input type="text" id="numberOfPayments" placeholder="Ù…Ø«Ø§Ù„: 4" class="input-clean" dir="ltr" 
                     oninput="this.value = formatInput(this.value); updateAutoPrincipal();" />
            </div>
            <div>
              <label class="block text-xs text-slate-600 mb-1">ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ (Ø±ÙˆØ²)</label>
              <input type="text" id="paymentInterval" value="30" placeholder="Ù…Ø«Ø§Ù„: 30" class="input-clean" dir="ltr" 
                     oninput="this.value = formatInput(this.value); updateAutoPrincipal();" />
            </div>
          </div>
        </div>
        
        <div id="principalRows" class="space-y-4">
          <div class="flex gap-4">
            <div class="flex-1">
              <label class="block text-xs text-slate-600 mb-1">Ø±ÙˆØ²</label>
              <input type="text" name="principalDay" placeholder="60" class="input-clean" dir="ltr" />
            </div>
            <div class="flex-1">
              <label class="block text-xs text-slate-600 mb-1">Ù…Ø¨Ù„Øº</label>
              <input type="text" name="principalAmount" placeholder="30000000" class="input-clean" dir="ltr" 
                     oninput="this.value = formatInput(this.value); updateTotalPrincipal(); updateEstimatedInterest();" />
            </div>
          </div>
        </div>
        <div id="totalPrincipal" class="mt-4 p-4 bg-slate-50 rounded-lg"></div>
      </div>

      <!-- ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙˆØ¯ -->
      <div class="card p-6">
        <div class="flex items-center justify-between mb-4">
          <label class="block text-sm font-semibold text-slate-700">
            ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙˆØ¯ <span class="text-red-500">*</span>
          </label>
          <button type="button" id="addInterestBtn" onclick="addInterestDateRow()" class="btn btn-secondary text-sm py-2 px-4">+ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù†</button>
        </div>
        
        <!-- ØªÙ‚Ø³ÛŒÙ… Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙˆØ¯ -->
        <div class="mb-4 bg-purple-50 p-3 rounded-lg border border-purple-200">
          <label class="flex items-center cursor-pointer">
            <input type="checkbox" id="autoInterestMode" onchange="toggleAutoInterest()" class="ml-3 w-4 h-4 text-purple-600 rounded" />
            <span class="text-sm font-semibold text-slate-900">ØªÙ‚Ø³ÛŒÙ… Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙˆØ¯</span>
          </label>
          <p class="text-xs text-slate-600 mt-1 mr-7">Ø¨Ø§ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ† Ú¯Ø²ÛŒÙ†Ù‡ØŒ Ø³ÛŒØ³ØªÙ… Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙˆØ¯ Ø±Ø§ ØªÙ‚Ø³ÛŒÙ… Ù…ÛŒâ€ŒÚ©Ù†Ø¯</p>
          
          <div id="autoInterestOptions" class="hidden mt-4 grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs text-slate-600 mb-1">ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§</label>
              <input type="text" id="numberOfInterestPayments" placeholder="Ù…Ø«Ø§Ù„: 2" class="input-clean" dir="ltr" 
                     oninput="this.value = formatInput(this.value); updateAutoInterest();" />
            </div>
            <div>
              <label class="block text-xs text-slate-600 mb-1">ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ (Ø±ÙˆØ²)</label>
              <input type="text" id="interestPaymentInterval" value="30" placeholder="Ù…Ø«Ø§Ù„: 90" class="input-clean" dir="ltr" 
                     oninput="this.value = formatInput(this.value); updateAutoInterest();" />
            </div>
          </div>
        </div>
        
        <div id="interestDateRows" class="space-y-4">
          <div>
            <label class="block text-xs text-slate-600 mb-1">Ø±ÙˆØ²</label>
            <input type="text" name="interestDate" placeholder="180" class="input-clean" dir="ltr" 
                   oninput="updateEstimatedInterest();" />
          </div>
        </div>
      </div>

      <div class="flex justify-center">
        <button type="submit" class="btn btn-primary text-lg py-4 px-8">ğŸ“Š Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª</button>
      </div>
    </form>

    <div id="results" class="hidden mt-8 space-y-6">
      <!-- Ø®Ù„Ø§ØµÙ‡ -->
      <div class="card p-6 bg-gradient-to-l from-blue-50 to-indigo-50">
        <h2 class="text-2xl font-bold text-slate-900 mb-6">ğŸ“Š Ø®Ù„Ø§ØµÙ‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4" id="summaryCards"></div>
      </div>

      <!-- Ø¬Ø¯ÙˆÙ„ ØªÙØµÛŒÙ„ÛŒ -->
      <div class="card p-6">
        <h2 class="text-2xl font-bold text-slate-900 mb-6">ğŸ“‹ Ø¬Ø¯ÙˆÙ„ ØªÙØµÛŒÙ„ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª</h2>
        <div class="overflow-x-auto">
          <table id="scheduleTable">
            <thead>
              <tr>
                <th>Ø±ÙˆØ²</th>
                <th>Ø§ØµÙ„ Ù¾ÙˆÙ„ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ (Ù‚Ø¨Ù„ Ø§Ø² Ù¾Ø±Ø¯Ø§Ø®Øª)</th>
                <th>Ù…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®Øª Ø§ØµÙ„ Ù¾ÙˆÙ„</th>
                <th>Ø³ÙˆØ¯ Ø§Ù†Ø¨Ø§Ø´ØªÙ‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡</th>
                <th>Ù…Ø¨Ù„Øº Ú©Ù„ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Ø¯Ø± Ø§ÛŒÙ† Ø±ÙˆØ²</th>
                <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="scheduleBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script>
    // ØªØ¨Ø¯ÛŒÙ„ Ø§Ø¹Ø¯Ø§Ø¯ ÙØ§Ø±Ø³ÛŒ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ
    function toEnglish(str) {
      const persian = ['Û°', 'Û±', 'Û²', 'Û³', 'Û´', 'Ûµ', 'Û¶', 'Û·', 'Û¸', 'Û¹'];
      const arabic = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
      let result = str;
      persian.forEach((p, i) => result = result.replace(new RegExp(p, 'g'), i));
      arabic.forEach((a, i) => result = result.replace(new RegExp(a, 'g'), i));
      return result;
    }

    // ØªØ¨Ø¯ÛŒÙ„ Ø§Ø¹Ø¯Ø§Ø¯ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ
    function toPersian(num) {
      const persian = ['Û°', 'Û±', 'Û²', 'Û³', 'Û´', 'Ûµ', 'Û¶', 'Û·', 'Û¸', 'Û¹'];
      return num.toString().replace(/\d/g, d => persian[parseInt(d)]);
    }

    // ÙØ±Ù…Øª ØªÙˆÙ…Ø§Ù†
    function formatToman(num) {
      return toPersian(Math.round(num).toLocaleString('en-US')) + ' ØªÙˆÙ…Ø§Ù†';
    }

    // Ù¾Ø§Ø±Ø³ Ú©Ø±Ø¯Ù† Ø¹Ø¯Ø¯
    function parseNumber(str) {
      if (!str) return 0;
      const cleaned = toEnglish(str).replace(/[^\d.]/g, '');
      return parseFloat(cleaned) || 0;
    }

    // ÙØ±Ù…Øª ÙˆØ±ÙˆØ¯ÛŒ
    function formatInput(str) {
      const cleaned = toEnglish(str).replace(/[^\d]/g, '');
      return cleaned.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    // Ù†Ù…Ø§ÛŒØ´ Ù…Ø¨Ù„Øº ÙˆØ§Ù…
    document.getElementById('loanAmount').addEventListener('input', function(e) {
      const value = formatInput(e.target.value);
      e.target.value = value;
      const num = parseNumber(value);
      if (num > 0) {
        document.getElementById('loanAmountDisplay').textContent = formatToman(num);
      } else {
        document.getElementById('loanAmountDisplay').textContent = '';
      }
      updateTotalPrincipal();
      if (document.getElementById('autoPrincipalMode').checked) {
        updateAutoPrincipal();
      }
      updateEstimatedInterest();
    });

    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ø±Ø® Ø³ÙˆØ¯
    document.getElementById('monthlyRate').addEventListener('input', function(e) {
      updateEstimatedInterest();
    });

    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø³ÙˆØ¯
    function updateEstimatedInterest() {
      const loanAmount = parseNumber(document.getElementById('loanAmount').value);
      const monthlyRate = parseNumber(document.getElementById('monthlyRate').value);
      
      if (loanAmount > 0 && monthlyRate > 0) {
        const dailyRate = monthlyRate / 100 / 30;
        const interestDates = Array.from(document.querySelectorAll('[name="interestDate"]'))
          .map(input => parseInt(toEnglish(input.value)) || 0)
          .filter(d => d > 0);
        
        const finalDay = interestDates.length > 0 ? Math.max(...interestDates) : 180;
        
        if (finalDay > 0) {
          let remainingPrincipal = loanAmount;
          let totalAccrued = 0;
          
          const principalRepayments = Array.from(document.querySelectorAll('[name="principalDay"]'))
            .map((dayInput, index) => {
              const day = parseInt(toEnglish(dayInput.value)) || 0;
              const amount = parseNumber(document.querySelectorAll('[name="principalAmount"]')[index].value);
              return { day, amount };
            })
            .filter(pr => pr.day > 0 && pr.amount > 0)
            .sort((a, b) => a.day - b.day);
          
          for (let day = 1; day <= finalDay; day++) {
            const dailyInterest = remainingPrincipal * dailyRate;
            totalAccrued += dailyInterest;
            
            const repayment = principalRepayments.find(pr => pr.day === day);
            if (repayment) {
              remainingPrincipal -= repayment.amount;
            }
          }
          
          document.getElementById('estimatedInterest').classList.remove('hidden');
          document.getElementById('estimatedInterestAmount').textContent = formatToman(totalAccrued);
        }
      } else {
        document.getElementById('estimatedInterest').classList.add('hidden');
      }
    }

    // ØªÙ‚Ø³ÛŒÙ… Ø®ÙˆØ¯Ú©Ø§Ø± Ø§ØµÙ„ Ù¾ÙˆÙ„
    function toggleAutoPrincipal() {
      const isChecked = document.getElementById('autoPrincipalMode').checked;
      const options = document.getElementById('autoPrincipalOptions');
      const addBtn = document.getElementById('addPrincipalBtn');
      const rows = document.getElementById('principalRows');
      
      if (isChecked) {
        options.classList.remove('hidden');
        addBtn.style.display = 'none';
        rows.querySelectorAll('input').forEach(input => input.disabled = true);
        updateAutoPrincipal();
      } else {
        options.classList.add('hidden');
        addBtn.style.display = 'inline-flex';
        rows.querySelectorAll('input').forEach(input => input.disabled = false);
      }
    }

    function updateAutoPrincipal() {
      if (!document.getElementById('autoPrincipalMode').checked) return;
      
      const loanAmount = parseNumber(document.getElementById('loanAmount').value);
      const numPayments = parseInt(toEnglish(document.getElementById('numberOfPayments').value)) || 0;
      const interval = parseInt(toEnglish(document.getElementById('paymentInterval').value)) || 30;
      
      if (loanAmount > 0 && numPayments > 0 && interval > 0) {
        const amountPerPayment = Math.floor(loanAmount / numPayments);
        const remainder = loanAmount - (amountPerPayment * numPayments);
        
        const rows = document.getElementById('principalRows');
        rows.innerHTML = '';
        
        for (let i = 0; i < numPayments; i++) {
          const days = (i + 1) * interval;
          const amount = i === numPayments - 1 ? amountPerPayment + remainder : amountPerPayment;
          
          const div = document.createElement('div');
          div.className = 'flex gap-4';
          div.innerHTML = `
            <div class="flex-1">
              <label class="block text-xs text-slate-600 mb-1">Ø±ÙˆØ²</label>
              <input type="text" name="principalDay" value="${days}" class="input-clean" dir="ltr" disabled />
            </div>
            <div class="flex-1">
              <label class="block text-xs text-slate-600 mb-1">Ù…Ø¨Ù„Øº</label>
              <input type="text" name="principalAmount" value="${formatInput(amount.toString())}" class="input-clean" dir="ltr" disabled />
            </div>
          `;
          rows.appendChild(div);
        }
        
        updateTotalPrincipal();
        updateEstimatedInterest();
      }
    }

    // ØªÙ‚Ø³ÛŒÙ… Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙˆØ¯
    function toggleAutoInterest() {
      const isChecked = document.getElementById('autoInterestMode').checked;
      const options = document.getElementById('autoInterestOptions');
      const addBtn = document.getElementById('addInterestBtn');
      const rows = document.getElementById('interestDateRows');
      
      if (isChecked) {
        options.classList.remove('hidden');
        addBtn.style.display = 'none';
        rows.querySelectorAll('input').forEach(input => input.disabled = true);
        updateAutoInterest();
      } else {
        options.classList.add('hidden');
        addBtn.style.display = 'inline-flex';
        rows.querySelectorAll('input').forEach(input => input.disabled = false);
      }
    }

    function updateAutoInterest() {
      if (!document.getElementById('autoInterestMode').checked) return;
      
      const numPayments = parseInt(toEnglish(document.getElementById('numberOfInterestPayments').value)) || 0;
      const interval = parseInt(toEnglish(document.getElementById('interestPaymentInterval').value)) || 30;
      
      if (numPayments > 0 && interval > 0) {
        const rows = document.getElementById('interestDateRows');
        rows.innerHTML = '';
        
        for (let i = 0; i < numPayments; i++) {
          const days = (i + 1) * interval;
          
          const div = document.createElement('div');
          div.className = 'flex gap-4 items-start';
          div.innerHTML = `
            <div class="flex-1">
              <label class="block text-xs text-slate-600 mb-1">Ø±ÙˆØ²</label>
              <input type="text" name="interestDate" value="${days}" class="input-clean" dir="ltr" disabled />
            </div>
          `;
          rows.appendChild(div);
        }
        
        updateEstimatedInterest();
      }
    }

    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…Ø¬Ù…ÙˆØ¹ Ø§ØµÙ„ Ù¾ÙˆÙ„
    function updateTotalPrincipal() {
      const rows = document.querySelectorAll('[name="principalAmount"]');
      let total = 0;
      rows.forEach(row => total += parseNumber(row.value));
      const loanAmount = parseNumber(document.getElementById('loanAmount').value);
      const display = document.getElementById('totalPrincipal');
      display.innerHTML = `
        <div class="flex items-center justify-between">
          <span class="text-sm font-semibold">Ù…Ø¬Ù…ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ Ù¾ÙˆÙ„:</span>
          <span class="text-lg font-bold ${Math.abs(total - loanAmount) <= 1 ? 'text-green-600' : 'text-red-600'}" dir="rtl" style="font-family: 'Vazirmatn'; font-feature-settings: 'tnum';">
            ${formatToman(total)}
          </span>
        </div>
        ${loanAmount > 0 ? `
          <div class="mt-2 flex items-center justify-between">
            <span class="text-sm text-slate-600">Ù…Ø¨Ù„Øº ÙˆØ§Ù…:</span>
            <span class="text-sm font-semibold" dir="rtl" style="font-family: 'Vazirmatn'; font-feature-settings: 'tnum';">
              ${formatToman(loanAmount)}
            </span>
          </div>
        ` : ''}
        ${Math.abs(total - loanAmount) <= 1 && loanAmount > 0 ? 
          '<p class="text-green-600 text-sm mt-2">âœ“ Ù…Ø¬Ù…ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ Ø¨Ø§ Ù…Ø¨Ù„Øº ÙˆØ§Ù… Ù…Ø·Ø§Ø¨Ù‚Øª Ø¯Ø§Ø±Ø¯</p>' : ''}
      `;
    }

    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø³Ø·Ø± Ù¾Ø±Ø¯Ø§Ø®Øª Ø§ØµÙ„ Ù¾ÙˆÙ„
    function addPrincipalRow() {
      if (document.getElementById('autoPrincipalMode').checked) return;
      const container = document.getElementById('principalRows');
      const div = document.createElement('div');
      div.className = 'flex gap-4';
      div.innerHTML = `
        <div class="flex-1">
          <label class="block text-xs text-slate-600 mb-1">Ø±ÙˆØ²</label>
          <input type="text" name="principalDay" placeholder="60" class="input-clean" dir="ltr" />
        </div>
        <div class="flex-1">
          <label class="block text-xs text-slate-600 mb-1">Ù…Ø¨Ù„Øº</label>
          <input type="text" name="principalAmount" placeholder="30000000" class="input-clean" dir="ltr" 
                 oninput="this.value = formatInput(this.value); updateTotalPrincipal(); updateEstimatedInterest();" />
        </div>
        <button type="button" onclick="this.parentElement.remove(); updateTotalPrincipal(); updateEstimatedInterest();" 
                class="mt-6 text-red-500 hover:text-red-700 font-bold text-xl">Ã—</button>
      `;
      container.appendChild(div);
    }

    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø³Ø·Ø± ØªØ§Ø±ÛŒØ® Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙˆØ¯
    function addInterestDateRow() {
      if (document.getElementById('autoInterestMode').checked) return;
      const container = document.getElementById('interestDateRows');
      const div = document.createElement('div');
      div.className = 'flex gap-4 items-start';
      div.innerHTML = `
        <div class="flex-1">
          <label class="block text-xs text-slate-600 mb-1">Ø±ÙˆØ²</label>
          <input type="text" name="interestDate" placeholder="180" class="input-clean" dir="ltr" 
                 oninput="updateEstimatedInterest();" />
        </div>
        <button type="button" onclick="this.parentElement.remove(); updateEstimatedInterest();" 
                class="mt-6 text-red-500 hover:text-red-700 font-bold text-xl">Ã—</button>
      `;
      container.appendChild(div);
    }

    // Ù…Ø­Ø§Ø³Ø¨Ù‡
    document.getElementById('calculatorForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const loanAmount = parseNumber(document.getElementById('loanAmount').value);
      const monthlyRate = parseNumber(document.getElementById('monthlyRate').value);
      
      if (!loanAmount || !monthlyRate) {
        alert('Ù„Ø·ÙØ§Ù‹ Ù…Ø¨Ù„Øº ÙˆØ§Ù… Ùˆ Ù†Ø±Ø® Ø³ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
        return;
      }

      // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ Ù¾ÙˆÙ„
      const principalRepayments = [];
      document.querySelectorAll('[name="principalDay"]').forEach((dayInput, index) => {
        const day = parseInt(toEnglish(dayInput.value));
        const amount = parseNumber(document.querySelectorAll('[name="principalAmount"]')[index].value);
        if (day && amount) {
          principalRepayments.push({ days: day, amount: amount });
        }
      });

      // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙˆØ¯
      const interestPaymentDates = [];
      document.querySelectorAll('[name="interestDate"]').forEach(input => {
        const day = parseInt(toEnglish(input.value));
        if (day) interestPaymentDates.push(day);
      });

      if (principalRepayments.length === 0 || interestPaymentDates.length === 0) {
        alert('Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ù¾Ø±Ø¯Ø§Ø®Øª Ø§ØµÙ„ Ù¾ÙˆÙ„ Ùˆ ÛŒÚ© ØªØ§Ø±ÛŒØ® Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙˆØ¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
        return;
      }

      // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ n8n
      calculateWithN8N(loanAmount, monthlyRate, principalRepayments, interestPaymentDates);
    });

    // ØªØ§Ø¨Ø¹ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ n8n
    async function calculateWithN8N(loanAmount, monthlyRate, principalRepayments, interestPaymentDates) {
      const submitBtn = document.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡...';

      try {
        const response = await fetch('https://n8nb2wall.darkube.app/webhook/internal-calculator', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            LoanAmount: loanAmount,
            MonthlyInterestRate: monthlyRate,
            PrincipalRepayments: principalRepayments,
            InterestPaymentDates: interestPaymentDates
          })
        });

        if (!response.ok) {
          throw new Error(`Ø®Ø·Ø§ÛŒ HTTP: ${response.status}`);
        }

        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.message || data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡');
        }

        // Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬
        displayResultsFromN8N(data);
      } catch (error) {
        alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±: ' + error.message);
        console.error('Error:', error);
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    }

    // Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬ Ø§Ø² n8n
    function displayResultsFromN8N(data) {
      const schedule = data.schedule || [];
      const summary = data.summary?._raw || data.summary || {};

      // Ø®Ù„Ø§ØµÙ‡
      document.getElementById('summaryCards').innerHTML = `
        <div class="bg-white p-4 rounded-lg border border-blue-100">
          <div class="text-sm text-slate-600 mb-1">Ú©Ù„ Ø³ÙˆØ¯ Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª</div>
          <div class="text-2xl font-bold text-blue-600" dir="rtl" style="font-family: 'Vazirmatn'; font-feature-settings: 'tnum';">
            ${formatToman(summary.totalInterestPaid || 0)}
          </div>
        </div>
        <div class="bg-white p-4 rounded-lg border border-blue-100">
          <div class="text-sm text-slate-600 mb-1">Ú©Ù„ Ù…Ø¨Ù„Øº Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª</div>
          <div class="text-2xl font-bold text-indigo-600" dir="rtl" style="font-family: 'Vazirmatn'; font-feature-settings: 'tnum';">
            ${formatToman(summary.totalPayments || 0)}
          </div>
        </div>
        <div class="bg-white p-4 rounded-lg border border-blue-100">
          <div class="text-sm text-slate-600 mb-1">Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª</div>
          <div class="text-2xl font-bold text-purple-600" dir="rtl" style="font-family: 'Vazirmatn'; font-feature-settings: 'tnum';">
            ${toPersian(summary.finalDay || 0)} Ø±ÙˆØ²
          </div>
        </div>
        <div class="bg-white p-4 rounded-lg border border-blue-100">
          <div class="text-sm text-slate-600 mb-1">Ø§ØµÙ„ Ù¾ÙˆÙ„ Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡</div>
          <div class="text-2xl font-bold text-green-600" dir="rtl" style="font-family: 'Vazirmatn'; font-feature-settings: 'tnum';">
            ${formatToman(summary.totalPrincipalPaid || 0)}
          </div>
        </div>
      `;

      // Ø¬Ø¯ÙˆÙ„ - ÙÙ‚Ø· Ø±ÙˆØ²Ù‡Ø§ÛŒ Ø¨Ø§ Ù¾Ø±Ø¯Ø§Ø®Øª
      const paymentDays = schedule.filter(d => {
        const raw = d._raw || {};
        return (raw.principalPayment > 0 || raw.interestPayment > 0);
      });
      const firstDay = schedule[0];
      const lastDay = schedule[schedule.length - 1];
      const daysToShow = [firstDay, ...paymentDays, lastDay]
        .filter((d, i, arr) => arr.findIndex(x => (x._raw?.day || x.Ø±ÙˆØ²) === (d._raw?.day || d.Ø±ÙˆØ²)) === i)
        .sort((a, b) => (a._raw?.day || a.Ø±ÙˆØ² || 0) - (b._raw?.day || b.Ø±ÙˆØ² || 0));

      const tbody = document.getElementById('scheduleBody');
      tbody.innerHTML = daysToShow.map(day => {
        const raw = day._raw || {};
        const dayNum = raw.day || day.Ø±ÙˆØ² || 0;
        const principalBefore = raw.remainingPrincipalBefore || 0;
        const principalPayment = raw.principalPayment || 0;
        const interestPayment = raw.interestPayment || 0;
        const totalPayment = raw.totalPayment || 0;
        const description = day.ØªÙˆØ¶ÛŒØ­Ø§Øª || 'Ù‡ÛŒÚ† Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯';
        const isPayment = principalPayment > 0 || interestPayment > 0;

        return `
          <tr class="${isPayment ? 'bg-blue-50' : ''}">
            <td class="font-semibold">${toPersian(dayNum)}</td>
            <td dir="ltr" style="font-family: 'Vazirmatn'; font-feature-settings: 'tnum';">
              ${formatToman(principalBefore)}
            </td>
            <td dir="ltr" style="font-family: 'Vazirmatn'; font-feature-settings: 'tnum';">
              ${principalPayment > 0 ? `<span class="font-semibold text-green-600">${formatToman(principalPayment)}</span>` : '<span class="text-slate-400">-</span>'}
            </td>
            <td dir="ltr" style="font-family: 'Vazirmatn'; font-feature-settings: 'tnum';">
              ${interestPayment > 0 ? `<span class="font-semibold text-orange-600">${formatToman(interestPayment)}</span>` : '<span class="text-slate-400">-</span>'}
            </td>
            <td dir="ltr" style="font-family: 'Vazirmatn'; font-feature-settings: 'tnum';">
              ${totalPayment > 0 ? `<span class="font-semibold text-blue-600">${formatToman(totalPayment)}</span>` : '<span class="text-slate-400">-</span>'}
            </td>
            <td class="text-sm text-slate-600">${description}</td>
          </tr>
        `;
      }).join('');

      document.getElementById('results').classList.remove('hidden');
      document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
    }

    // ØªØ§Ø¨Ø¹ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø­Ù„ÛŒ (fallback - Ø§Ú¯Ø± n8n Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†Ø¨ÙˆØ¯)
    function calculateSchedule(loanAmount, monthlyRate, principalRepayments, interestPaymentDates) {
      const dailyRate = monthlyRate / 100 / 30;
      principalRepayments.sort((a, b) => a.days - b.days);
      interestPaymentDates.sort((a, b) => a - b);
      
      const finalDay = Math.max(
        Math.max(...principalRepayments.map(p => p.days)),
        Math.max(...interestPaymentDates)
      );

      let remainingPrincipal = loanAmount;
      let totalAccruedInterest = 0;
      let principalIndex = 0;
      let interestIndex = 0;
      const schedule = [];
      let totalPrincipalPaid = 0;
      let totalInterestPaid = 0;
      let totalPayments = 0;

      for (let day = 1; day <= finalDay; day++) {
        const record = {
          day: day,
          remainingPrincipalBefore: remainingPrincipal,
          principalPayment: 0,
          interestPayment: 0,
          totalPayment: 0,
          description: '',
          remainingPrincipalAfter: remainingPrincipal
        };

        const dailyInterest = remainingPrincipal * dailyRate;
        totalAccruedInterest += dailyInterest;

        // Ù¾Ø±Ø¯Ø§Ø®Øª Ø§ØµÙ„ Ù¾ÙˆÙ„
        if (principalIndex < principalRepayments.length && 
            principalRepayments[principalIndex].days === day) {
          const amount = principalRepayments[principalIndex].amount;
          record.principalPayment = amount;
          remainingPrincipal -= amount;
          totalPrincipalPaid += amount;
          record.remainingPrincipalAfter = remainingPrincipal;
          record.description = 'Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø®Ø´ÛŒ Ø§Ø² Ø§ØµÙ„ ÙˆØ§Ù…';
          principalIndex++;
        }

        // Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙˆØ¯
        if (interestIndex < interestPaymentDates.length && 
            interestPaymentDates[interestIndex] === day) {
          record.interestPayment = totalAccruedInterest;
          totalInterestPaid += totalAccruedInterest;
          totalAccruedInterest = 0;
          if (record.description) record.description += ' + ';
          record.description += 'Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙˆØ¯ Ø§Ù†Ø¨Ø§Ø´ØªÙ‡';
          interestIndex++;
        }

        record.totalPayment = record.principalPayment + record.interestPayment;
        totalPayments += record.totalPayment;

        if (!record.description) {
          record.description = 'Ù‡ÛŒÚ† Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯';
        }

        schedule.push(record);
      }

      // Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬
      displayResults(schedule, {
        totalPrincipalPaid,
        totalInterestPaid,
        totalPayments,
        finalDay
      });
    }

    // Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬
    function displayResults(schedule, summary) {
      // Ø®Ù„Ø§ØµÙ‡
      document.getElementById('summaryCards').innerHTML = `
        <div class="bg-white p-4 rounded-lg border border-blue-100">
          <div class="text-sm text-slate-600 mb-1">Ú©Ù„ Ø³ÙˆØ¯ Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª</div>
          <div class="text-2xl font-bold text-blue-600" dir="rtl" style="font-family: 'Vazirmatn'; font-feature-settings: 'tnum';">
            ${formatToman(summary.totalInterestPaid)}
          </div>
        </div>
        <div class="bg-white p-4 rounded-lg border border-blue-100">
          <div class="text-sm text-slate-600 mb-1">Ú©Ù„ Ù…Ø¨Ù„Øº Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª</div>
          <div class="text-2xl font-bold text-indigo-600" dir="rtl" style="font-family: 'Vazirmatn'; font-feature-settings: 'tnum';">
            ${formatToman(summary.totalPayments)}
          </div>
        </div>
        <div class="bg-white p-4 rounded-lg border border-blue-100">
          <div class="text-sm text-slate-600 mb-1">Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª</div>
          <div class="text-2xl font-bold text-purple-600" dir="rtl" style="font-family: 'Vazirmatn'; font-feature-settings: 'tnum';">
            ${toPersian(summary.finalDay)} Ø±ÙˆØ²
          </div>
        </div>
        <div class="bg-white p-4 rounded-lg border border-blue-100">
          <div class="text-sm text-slate-600 mb-1">Ø§ØµÙ„ Ù¾ÙˆÙ„ Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡</div>
          <div class="text-2xl font-bold text-green-600" dir="rtl" style="font-family: 'Vazirmatn'; font-feature-settings: 'tnum';">
            ${formatToman(summary.totalPrincipalPaid)}
          </div>
        </div>
      `;

      // Ø¬Ø¯ÙˆÙ„ - ÙÙ‚Ø· Ø±ÙˆØ²Ù‡Ø§ÛŒ Ø¨Ø§ Ù¾Ø±Ø¯Ø§Ø®Øª
      const paymentDays = schedule.filter(d => d.principalPayment > 0 || d.interestPayment > 0);
      const firstDay = schedule[0];
      const lastDay = schedule[schedule.length - 1];
      const daysToShow = [firstDay, ...paymentDays, lastDay]
        .filter((d, i, arr) => arr.findIndex(x => x.day === d.day) === i)
        .sort((a, b) => a.day - b.day);

      const tbody = document.getElementById('scheduleBody');
      tbody.innerHTML = daysToShow.map(day => {
        const isPayment = day.principalPayment > 0 || day.interestPayment > 0;
        return `
          <tr class="${isPayment ? 'bg-blue-50' : ''}">
            <td class="font-semibold">${toPersian(day.day)}</td>
            <td dir="ltr" style="font-family: 'Vazirmatn'; font-feature-settings: 'tnum';">
              ${formatToman(day.remainingPrincipalBefore)}
            </td>
            <td dir="ltr" style="font-family: 'Vazirmatn'; font-feature-settings: 'tnum';">
              ${day.principalPayment > 0 ? `<span class="font-semibold text-green-600">${formatToman(day.principalPayment)}</span>` : '<span class="text-slate-400">-</span>'}
            </td>
            <td dir="ltr" style="font-family: 'Vazirmatn'; font-feature-settings: 'tnum';">
              ${day.interestPayment > 0 ? `<span class="font-semibold text-orange-600">${formatToman(day.interestPayment)}</span>` : '<span class="text-slate-400">-</span>'}
            </td>
            <td dir="ltr" style="font-family: 'Vazirmatn'; font-feature-settings: 'tnum';">
              ${day.totalPayment > 0 ? `<span class="font-semibold text-blue-600">${formatToman(day.totalPayment)}</span>` : '<span class="text-slate-400">-</span>'}
            </td>
            <td class="text-sm text-slate-600">${day.description}</td>
          </tr>
        `;
      }).join('');

      document.getElementById('results').classList.remove('hidden');
      document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
    }

    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…Ø¬Ù…ÙˆØ¹ Ù‡Ù†Ú¯Ø§Ù… ØªØºÛŒÛŒØ±
    document.querySelectorAll('[name="principalAmount"]').forEach(input => {
      input.addEventListener('input', function() {
        this.value = formatInput(this.value);
        updateTotalPrincipal();
      });
    });
  </script>
</body>
</html>
