<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒÚ¯Ø± Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª ÙˆØ§Ù… | B2Wall</title>
  <script src="clarity-tracker.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Vazirmatn', system-ui, -apple-system, sans-serif; background: #f8fafc }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 1.25rem; box-shadow: 0 4px 16px rgba(0,0,0,.04) }
    .input-clean { width: 100%; padding: 0.875rem 1rem; border: 2px solid #e2e8f0; border-radius: 0.875rem; font-size: 1.125rem; font-weight: 600; transition: all 0.2s; background: #fff; font-family: 'Vazirmatn', system-ui; font-feature-settings: "tnum"; direction: ltr; text-align: right }
    .input-clean:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37,99,235,.1) }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.875rem 1.5rem; border-radius: 0.875rem; font-weight: 700; transition: all 0.2s; cursor: pointer; border: none; font-size: 1rem }
    .btn-primary { background: #2563eb; color: #fff; box-shadow: 0 4px 12px rgba(37,99,235,.3) }
    .btn-primary:hover:not(:disabled) { background: #1d4ed8; transform: translateY(-1px); box-shadow: 0 6px 16px rgba(37,99,235,.4) }
    .btn-secondary { background: #f1f5f9; color: #334155; border: 2px solid #e2e8f0 }
    .btn-secondary:hover:not(:disabled) { background: #e2e8f0 }
    .btn:disabled { opacity: 0.5; cursor: not-allowed }
  </style>
</head>
<body class="bg-slate-50">
  <div class="min-h-screen">
    <!-- Header -->
    <header class="bg-white border-b border-slate-200 shadow-sm">
      <div class="max-w-6xl mx-auto px-4 py-6">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-slate-900">Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒÚ¯Ø± Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª ÙˆØ§Ù…</h1>
            <p class="text-sm text-slate-600 mt-1">Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ø¯Ù‚ÛŒÙ‚ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª ÙˆØ§Ù… Ø¨Ø§ Ø¬Ø¯ÙˆÙ„ ØªÙØµÛŒÙ„ÛŒ Ø±ÙˆØ² Ø¨Ù‡ Ø±ÙˆØ²</p>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-4 py-8" id="mainContent">
      <!-- Input Form -->
      <form id="loanForm" class="space-y-6">
        <!-- Loan Amount -->
        <div class="card p-6">
          <label class="block text-sm font-semibold text-slate-700 mb-2">Ù…Ø¨Ù„Øº ÙˆØ§Ù… <span class="text-red-500">*</span></label>
          <input type="text" id="loanAmount" class="input-clean w-full" placeholder="Ù…Ø¨Ù„Øº ÙˆØ§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" />
          <div id="loanAmountDisplay" class="mt-2 text-sm font-semibold text-blue-600" style="display: none;"></div>
          <p class="text-xs text-slate-500 mt-2">ğŸ’¡ Ù†Ú©ØªÙ‡: Ù…Ø¨Ù„Øº Ú©Ù„ ÙˆØ§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø¹Ø¯Ø§Ø¯ ÙØ§Ø±Ø³ÛŒ ÛŒØ§ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯)</p>
        </div>

        <!-- Monthly Interest Rate -->
        <div class="card p-6">
          <label class="block text-sm font-semibold text-slate-700 mb-2">Ù†Ø±Ø® Ø³ÙˆØ¯ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ <span class="text-red-500">*</span></label>
          <input type="text" id="monthlyInterestRate" class="input-clean w-full" placeholder="Ù†Ø±Ø® Ø³ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" />
          <p class="text-xs text-slate-500 mt-2">ğŸ’¡ Ù†Ú©ØªÙ‡: Ù†Ø±Ø® Ø³ÙˆØ¯ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø±ØµØ¯ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ (Ù…Ø«Ø§Ù„: 4.5 Ø¨Ø±Ø§ÛŒ 4.5%)</p>
        </div>

        <!-- Principal Repayments -->
        <div class="card p-6">
          <div class="flex items-center justify-between mb-4">
            <label class="block text-sm font-semibold text-slate-700">Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ Ù¾ÙˆÙ„ <span class="text-red-500">*</span></label>
            <button type="button" id="addPrincipalBtn" class="btn btn-secondary text-sm py-2 px-4">+ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù†</button>
          </div>

          <!-- Auto Mode -->
          <div class="mb-4 bg-blue-50 p-3 rounded-lg border border-blue-200">
            <label class="flex items-center cursor-pointer">
              <input type="checkbox" id="autoMode" class="ml-3 w-4 h-4 text-blue-600 rounded" />
              <span class="text-sm font-semibold text-slate-900">ØªÙ‚Ø³ÛŒÙ… Ø®ÙˆØ¯Ú©Ø§Ø± Ø§ØµÙ„ Ù¾ÙˆÙ„</span>
            </label>
            <p class="text-xs text-slate-600 mt-1 mr-7">Ø¨Ø§ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ† Ú¯Ø²ÛŒÙ†Ù‡ØŒ Ø³ÛŒØ³ØªÙ… Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø§ØµÙ„ Ù¾ÙˆÙ„ Ø±Ø§ ØªÙ‚Ø³ÛŒÙ… Ù…ÛŒâ€ŒÚ©Ù†Ø¯</p>
            <div id="autoModeSettings" class="mt-4 grid grid-cols-2 gap-4" style="display: none;">
              <div>
                <label class="block text-xs text-slate-600 mb-1">ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§</label>
                <input type="text" id="numberOfPayments" class="input-clean" placeholder="Ù…Ø«Ø§Ù„: 4" />
              </div>
              <div>
                <label class="block text-xs text-slate-600 mb-1">ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ (Ø±ÙˆØ²)</label>
                <input type="text" id="paymentInterval" class="input-clean" placeholder="Ù…Ø«Ø§Ù„: 30" value="30" />
              </div>
            </div>
          </div>

          <div id="principalRepayments" class="space-y-4"></div>

          <div id="totalPrincipalValidation" class="mt-4 p-4 bg-slate-50 rounded-lg" style="display: none;">
            <div class="flex items-center justify-between">
              <span class="text-sm font-semibold text-slate-700">Ù…Ø¬Ù…ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ Ù¾ÙˆÙ„:</span>
              <span id="totalPrincipalDisplay" class="text-lg font-bold"></span>
            </div>
          </div>
        </div>

        <!-- Interest Payment Dates -->
        <div class="card p-6">
          <div class="flex items-center justify-between mb-4">
            <label class="block text-sm font-semibold text-slate-700">ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙˆØ¯ <span class="text-red-500">*</span></label>
            <button type="button" id="addInterestDateBtn" class="btn btn-secondary text-sm py-2 px-4">+ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù†</button>
          </div>

          <!-- Auto Interest Mode -->
          <div class="mb-4 bg-purple-50 p-3 rounded-lg border border-purple-200">
            <label class="flex items-center cursor-pointer">
              <input type="checkbox" id="autoInterestMode" class="ml-3 w-4 h-4 text-purple-600 rounded" />
              <span class="text-sm font-semibold text-slate-900">ØªÙ‚Ø³ÛŒÙ… Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙˆØ¯</span>
            </label>
            <p class="text-xs text-slate-600 mt-1 mr-7">Ø¨Ø§ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ† Ú¯Ø²ÛŒÙ†Ù‡ØŒ Ø³ÛŒØ³ØªÙ… Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙˆØ¯ Ø±Ø§ ØªÙ‚Ø³ÛŒÙ… Ù…ÛŒâ€ŒÚ©Ù†Ø¯</p>
            <div id="autoInterestSettings" class="mt-4 grid grid-cols-2 gap-4" style="display: none;">
              <div>
                <label class="block text-xs text-slate-600 mb-1">ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§</label>
                <input type="text" id="numberOfInterestPayments" class="input-clean" placeholder="Ù…Ø«Ø§Ù„: 2" />
              </div>
              <div>
                <label class="block text-xs text-slate-600 mb-1">ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ (Ø±ÙˆØ²)</label>
                <input type="text" id="interestPaymentInterval" class="input-clean" placeholder="Ù…Ø«Ø§Ù„: 90" value="30" />
              </div>
            </div>
          </div>

          <div id="interestPaymentDates" class="space-y-4"></div>
          <p class="text-xs text-slate-500 mt-4">ğŸ’¡ Ù†Ú©ØªÙ‡: Ø¯Ø± Ø§ÛŒÙ† Ø±ÙˆØ²Ù‡Ø§ØŒ ØªÙ…Ø§Ù… Ø³ÙˆØ¯ Ø§Ù†Ø¨Ø§Ø´ØªÙ‡ Ø´Ø¯Ù‡ ØªØ§ Ø¢Ù† Ø±ÙˆØ² Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯</p>
        </div>

        <!-- Submit Button -->
        <div class="flex justify-center">
          <button type="submit" id="calculateBtn" class="btn btn-primary text-lg py-4 px-8">
            <span class="mr-2">ğŸ“Š</span> Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª
          </button>
        </div>
      </form>

      <!-- Results Section (hidden initially) -->
      <div id="resultsSection" class="space-y-6" style="display: none;">
        <!-- Summary -->
        <div class="card p-6 bg-gradient-to-l from-blue-50 to-indigo-50 border-2 border-blue-200">
          <h2 class="text-2xl font-bold text-slate-900 mb-6">ğŸ“Š Ø®Ù„Ø§ØµÙ‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="summaryCards"></div>
        </div>

        <!-- Detailed Table -->
        <div class="card p-6">
          <h2 class="text-2xl font-bold text-slate-900 mb-6">ğŸ“‹ Ø¬Ø¯ÙˆÙ„ ØªÙØµÛŒÙ„ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª</h2>
          <div class="overflow-x-auto">
            <table class="w-full border-collapse" id="scheduleTable">
              <thead>
                <tr class="bg-slate-100">
                  <th class="px-4 py-3 text-right text-sm font-semibold text-slate-700 border-b-2 border-slate-200">Ø±ÙˆØ²</th>
                  <th class="px-4 py-3 text-right text-sm font-semibold text-slate-700 border-b-2 border-slate-200">Ø§ØµÙ„ Ù¾ÙˆÙ„ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ (Ù‚Ø¨Ù„ Ø§Ø² Ù¾Ø±Ø¯Ø§Ø®Øª)</th>
                  <th class="px-4 py-3 text-right text-sm font-semibold text-slate-700 border-b-2 border-slate-200">Ù…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®Øª Ø§ØµÙ„ Ù¾ÙˆÙ„</th>
                  <th class="px-4 py-3 text-right text-sm font-semibold text-slate-700 border-b-2 border-slate-200">Ø³ÙˆØ¯ Ø§Ù†Ø¨Ø§Ø´ØªÙ‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡</th>
                  <th class="px-4 py-3 text-right text-sm font-semibold text-slate-700 border-b-2 border-slate-200">Ù…Ø¨Ù„Øº Ú©Ù„ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Ø¯Ø± Ø§ÛŒÙ† Ø±ÙˆØ²</th>
                  <th class="px-4 py-3 text-right text-sm font-semibold text-slate-700 border-b-2 border-slate-200">ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
                </tr>
              </thead>
              <tbody id="scheduleTableBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-center gap-4">
          <button onclick="resetForm()" class="btn btn-secondary">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¬Ø¯ÛŒØ¯</button>
          <button onclick="window.print()" class="btn btn-primary">Ú†Ø§Ù¾ Ú¯Ø²Ø§Ø±Ø´</button>
        </div>
      </div>
    </main>
  </div>

  <script>
    const N8N_WEBHOOK_URL = 'https://n8nb2wall.darkube.app/webhook/internal-calculator';
    let principalRepaymentCount = 0;
    let interestDateCount = 0;

    // Persian to English digit conversion
    function convertPersianToEnglish(str) {
      if (!str) return str;
      const persian = ['Û°', 'Û±', 'Û²', 'Û³', 'Û´', 'Ûµ', 'Û¶', 'Û·', 'Û¸', 'Û¹'];
      const arabic = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
      let result = str.toString();
      persian.forEach((p, i) => result = result.replace(new RegExp(p, 'g'), i));
      arabic.forEach((a, i) => result = result.replace(new RegExp(a, 'g'), i));
      return result;
    }

    function formatNumberPersian(num) {
      if (typeof num !== 'number' || isNaN(num)) return 'Û°';
      const persian = ['Û°', 'Û±', 'Û²', 'Û³', 'Û´', 'Ûµ', 'Û¶', 'Û·', 'Û¸', 'Û¹'];
      return Math.round(num).toLocaleString('en-US').replace(/\d/g, d => persian[parseInt(d)]);
    }

    function formatToman(amount) {
      if (typeof amount !== 'number' || isNaN(amount)) return '0 ØªÙˆÙ…Ø§Ù†';
      return formatNumberPersian(amount) + ' ØªÙˆÙ…Ø§Ù†';
    }

    function parseNumber(value) {
      if (!value) return 0;
      const english = convertPersianToEnglish(value);
      const cleaned = english.replace(/[^\d.]/g, '');
      const parsed = parseFloat(cleaned);
      return isNaN(parsed) ? 0 : parsed;
    }

    function formatInputValue(value) {
      if (!value) return '';
      const english = convertPersianToEnglish(value);
      const numeric = english.replace(/[^\d]/g, '');
      if (!numeric) return '';
      return numeric.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    // Initialize form
    document.addEventListener('DOMContentLoaded', function() {
      addPrincipalRepayment();
      addInterestDate();
      
      // Auto mode toggle
      document.getElementById('autoMode').addEventListener('change', function(e) {
        document.getElementById('autoModeSettings').style.display = e.target.checked ? 'grid' : 'none';
        if (e.target.checked) {
          updateAutoPrincipalRepayments();
        }
      });

      document.getElementById('autoInterestMode').addEventListener('change', function(e) {
        document.getElementById('autoInterestSettings').style.display = e.target.checked ? 'grid' : 'none';
        if (e.target.checked) {
          updateAutoInterestDates();
        }
      });

      // Auto mode inputs
      document.getElementById('numberOfPayments').addEventListener('input', updateAutoPrincipalRepayments);
      document.getElementById('paymentInterval').addEventListener('input', updateAutoPrincipalRepayments);
      document.getElementById('numberOfInterestPayments').addEventListener('input', updateAutoInterestDates);
      document.getElementById('interestPaymentInterval').addEventListener('input', updateAutoInterestDates);
      document.getElementById('loanAmount').addEventListener('input', function() {
        if (document.getElementById('autoMode').checked) {
          updateAutoPrincipalRepayments();
        }
        updateLoanAmountDisplay();
      });

      // Format inputs
      document.getElementById('loanAmount').addEventListener('input', function(e) {
        e.target.value = formatInputValue(e.target.value);
      });

      document.getElementById('monthlyInterestRate').addEventListener('input', function(e) {
        let value = convertPersianToEnglish(e.target.value);
        if (value === '' || /^\d*\.?\d*$/.test(value)) {
          e.target.value = value;
        } else {
          e.target.value = e.target.value.slice(0, -1);
        }
      });

      // Add buttons
      document.getElementById('addPrincipalBtn').addEventListener('click', addPrincipalRepayment);
      document.getElementById('addInterestDateBtn').addEventListener('click', addInterestDate);

      // Form submit
      document.getElementById('loanForm').addEventListener('submit', handleSubmit);
    });

    function updateLoanAmountDisplay() {
      const amount = parseNumber(document.getElementById('loanAmount').value);
      const display = document.getElementById('loanAmountDisplay');
      if (amount > 0) {
        display.textContent = formatToman(amount);
        display.style.display = 'block';
      } else {
        display.style.display = 'none';
      }
    }

    function addPrincipalRepayment() {
      const container = document.getElementById('principalRepayments');
      const index = principalRepaymentCount++;
      const div = document.createElement('div');
      div.className = 'flex gap-4 items-start';
      div.innerHTML = `
        <div class="flex-1">
          <label class="block text-xs text-slate-600 mb-1">Ø±ÙˆØ²</label>
          <input type="text" class="input-clean principal-days" placeholder="Ù…Ø«Ø§Ù„: 60" data-index="${index}" />
        </div>
        <div class="flex-1">
          <label class="block text-xs text-slate-600 mb-1">Ù…Ø¨Ù„Øº</label>
          <input type="text" class="input-clean principal-amount" placeholder="Ù…Ø¨Ù„Øº Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" data-index="${index}" />
          <div class="principal-amount-display mt-1 text-xs font-semibold text-blue-600" style="display: none;"></div>
        </div>
        ${principalRepaymentCount > 1 ? `<button type="button" onclick="removePrincipalRepayment(${index})" class="mt-6 text-red-500 hover:text-red-700 font-bold text-xl">Ã—</button>` : ''}
      `;
      container.appendChild(div);

      // Format amount input
      div.querySelector('.principal-amount').addEventListener('input', function(e) {
        e.target.value = formatInputValue(e.target.value);
        const amount = parseNumber(e.target.value);
        const display = div.querySelector('.principal-amount-display');
        if (amount > 0) {
          display.textContent = formatToman(amount);
          display.style.display = 'block';
        } else {
          display.style.display = 'none';
        }
        updateTotalPrincipal();
      });

      div.querySelector('.principal-days').addEventListener('input', function(e) {
        e.target.value = convertPersianToEnglish(e.target.value).replace(/[^\d]/g, '');
      });
    }

    function removePrincipalRepayment(index) {
      const items = document.querySelectorAll('#principalRepayments > div');
      items.forEach(item => {
        if (item.querySelector(`[data-index="${index}"]`)) {
          item.remove();
        }
      });
      updateTotalPrincipal();
    }

    function addInterestDate() {
      const container = document.getElementById('interestPaymentDates');
      const index = interestDateCount++;
      const div = document.createElement('div');
      div.className = 'flex gap-4 items-start';
      div.innerHTML = `
        <div class="flex-1">
          <label class="block text-xs text-slate-600 mb-1">Ø±ÙˆØ²</label>
          <input type="text" class="input-clean interest-date" placeholder="Ù…Ø«Ø§Ù„: 180" data-index="${index}" />
        </div>
        ${interestDateCount > 1 ? `<button type="button" onclick="removeInterestDate(${index})" class="mt-6 text-red-500 hover:text-red-700 font-bold text-xl">Ã—</button>` : ''}
      `;
      container.appendChild(div);

      div.querySelector('.interest-date').addEventListener('input', function(e) {
        e.target.value = convertPersianToEnglish(e.target.value).replace(/[^\d]/g, '');
      });
    }

    function removeInterestDate(index) {
      const items = document.querySelectorAll('#interestPaymentDates > div');
      items.forEach(item => {
        if (item.querySelector(`[data-index="${index}"]`)) {
          item.remove();
        }
      });
    }

    function updateAutoPrincipalRepayments() {
      if (!document.getElementById('autoMode').checked) return;
      
      const loanAmount = parseNumber(document.getElementById('loanAmount').value);
      const numPayments = parseInt(convertPersianToEnglish(document.getElementById('numberOfPayments').value)) || 0;
      const interval = parseInt(convertPersianToEnglish(document.getElementById('paymentInterval').value)) || 30;

      if (loanAmount > 0 && numPayments > 0 && interval > 0) {
        const container = document.getElementById('principalRepayments');
        container.innerHTML = '';
        principalRepaymentCount = 0;

        const amountPerPayment = Math.floor(loanAmount / numPayments);
        const remainder = loanAmount - (amountPerPayment * numPayments);

        for (let i = 0; i < numPayments; i++) {
          const days = (i + 1) * interval;
          const amount = i === numPayments - 1 ? amountPerPayment + remainder : amountPerPayment;
          addPrincipalRepayment();
          const items = container.querySelectorAll('.principal-days, .principal-amount');
          items[items.length - 2].value = days.toString();
          items[items.length - 1].value = formatInputValue(amount.toString());
          const display = container.lastElementChild.querySelector('.principal-amount-display');
          display.textContent = formatToman(amount);
          display.style.display = 'block';
        }
        updateTotalPrincipal();
      }
    }

    function updateAutoInterestDates() {
      if (!document.getElementById('autoInterestMode').checked) return;
      
      const numPayments = parseInt(convertPersianToEnglish(document.getElementById('numberOfInterestPayments').value)) || 0;
      const interval = parseInt(convertPersianToEnglish(document.getElementById('interestPaymentInterval').value)) || 30;

      if (numPayments > 0 && interval > 0) {
        const container = document.getElementById('interestPaymentDates');
        container.innerHTML = '';
        interestDateCount = 0;

        for (let i = 0; i < numPayments; i++) {
          const days = (i + 1) * interval;
          addInterestDate();
          const input = container.lastElementChild.querySelector('.interest-date');
          input.value = days.toString();
        }
      }
    }

    function updateTotalPrincipal() {
      const amounts = Array.from(document.querySelectorAll('.principal-amount')).map(inp => parseNumber(inp.value));
      const total = amounts.reduce((sum, amt) => sum + amt, 0);
      const loanAmount = parseNumber(document.getElementById('loanAmount').value);
      
      const validation = document.getElementById('totalPrincipalValidation');
      const display = document.getElementById('totalPrincipalDisplay');
      
      if (total > 0 || loanAmount > 0) {
        validation.style.display = 'block';
        display.textContent = formatToman(total);
        display.className = 'text-lg font-bold ' + (Math.abs(total - loanAmount) <= 1 ? 'text-green-600' : 'text-red-600');
      } else {
        validation.style.display = 'none';
      }
    }

    async function handleSubmit(e) {
      e.preventDefault();
      
      const loanAmount = parseNumber(document.getElementById('loanAmount').value);
      const monthlyRate = parseFloat(convertPersianToEnglish(document.getElementById('monthlyInterestRate').value));
      
      const principalRepayments = Array.from(document.querySelectorAll('#principalRepayments > div')).map(div => ({
        days: parseInt(convertPersianToEnglish(div.querySelector('.principal-days').value)) || 0,
        amount: parseNumber(div.querySelector('.principal-amount').value)
      })).filter(pr => pr.days > 0 && pr.amount > 0);

      const interestDates = Array.from(document.querySelectorAll('.interest-date')).map(inp => 
        parseInt(convertPersianToEnglish(inp.value)) || 0
      ).filter(d => d > 0);

      if (!loanAmount || loanAmount <= 0) {
        alert('Ù…Ø¨Ù„Øº ÙˆØ§Ù… Ø¨Ø§ÛŒØ¯ Ù…Ø«Ø¨Øª Ø¨Ø§Ø´Ø¯');
        return;
      }

      if (!monthlyRate || monthlyRate <= 0 || monthlyRate > 100) {
        alert('Ù†Ø±Ø® Ø³ÙˆØ¯ Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† 0 ØªØ§ 100 Ø¯Ø±ØµØ¯ Ø¨Ø§Ø´Ø¯');
        return;
      }

      if (principalRepayments.length === 0) {
        alert('Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ù¾Ø±Ø¯Ø§Ø®Øª Ø§ØµÙ„ Ù¾ÙˆÙ„ Ø¨Ø§ÛŒØ¯ ØªØ¹ÛŒÛŒÙ† Ø´ÙˆØ¯');
        return;
      }

      if (interestDates.length === 0) {
        alert('Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© ØªØ§Ø±ÛŒØ® Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙˆØ¯ Ø¨Ø§ÛŒØ¯ ØªØ¹ÛŒÛŒÙ† Ø´ÙˆØ¯');
        return;
      }

      const inputData = {
        LoanAmount: loanAmount,
        MonthlyInterestRate: monthlyRate,
        PrincipalRepayments: principalRepayments,
        InterestPaymentDates: interestDates
      };

      document.getElementById('calculateBtn').disabled = true;
      document.getElementById('calculateBtn').innerHTML = '<span class="animate-spin mr-2">â³</span> Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡...';

      try {
        const response = await fetch(N8N_WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(inputData)
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.message || data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡');
        }

        displayResults(data);
      } catch (error) {
        alert('Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡: ' + error.message);
        console.error('Error:', error);
      } finally {
        document.getElementById('calculateBtn').disabled = false;
        document.getElementById('calculateBtn').innerHTML = '<span class="mr-2">ğŸ“Š</span> Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª';
      }
    }

    function displayResults(data) {
      document.getElementById('loanForm').style.display = 'none';
      document.getElementById('resultsSection').style.display = 'block';

      const summary = data.summary._raw || {};
      const summaryCards = document.getElementById('summaryCards');
      summaryCards.innerHTML = `
        <div class="bg-white p-4 rounded-lg border border-blue-100">
          <div class="text-sm text-slate-600 mb-1">Ú©Ù„ Ø³ÙˆØ¯ Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª</div>
          <div class="text-2xl font-bold text-blue-600">${formatToman(summary.totalInterestPaid || 0)}</div>
        </div>
        <div class="bg-white p-4 rounded-lg border border-blue-100">
          <div class="text-sm text-slate-600 mb-1">Ú©Ù„ Ù…Ø¨Ù„Øº Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª</div>
          <div class="text-2xl font-bold text-indigo-600">${formatToman(summary.totalPayments || 0)}</div>
        </div>
        <div class="bg-white p-4 rounded-lg border border-blue-100">
          <div class="text-sm text-slate-600 mb-1">Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª</div>
          <div class="text-2xl font-bold text-purple-600">${formatNumberPersian(summary.finalDay || 0)} Ø±ÙˆØ²</div>
        </div>
        <div class="bg-white p-4 rounded-lg border border-blue-100">
          <div class="text-sm text-slate-600 mb-1">Ø§ØµÙ„ Ù¾ÙˆÙ„ Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡</div>
          <div class="text-2xl font-bold text-green-600">${formatToman(summary.totalPrincipalPaid || 0)}</div>
        </div>
      `;

      const schedule = data.schedule || [];
      const paymentDays = schedule.filter(day => {
        const raw = day._raw || {};
        return raw.principalPayment > 0 || raw.interestPayment > 0;
      });

      const firstDay = schedule[0];
      const lastDay = schedule[schedule.length - 1];
      const daysToShow = [firstDay, ...paymentDays, lastDay].filter((day, index, self) => 
        index === self.findIndex(d => d.Ø±ÙˆØ² === day.Ø±ÙˆØ²)
      ).sort((a, b) => a.Ø±ÙˆØ² - b.Ø±ÙˆØ²);

      const tbody = document.getElementById('scheduleTableBody');
      tbody.innerHTML = daysToShow.map(day => {
        const raw = day._raw || {};
        const isPaymentDay = raw.principalPayment > 0 || raw.interestPayment > 0;
        const rowClass = isPaymentDay ? 'bg-blue-50 hover:bg-blue-100' : '';
        return `
          <tr class="${rowClass}">
            <td class="px-4 py-3 text-sm font-semibold text-slate-900 border-b border-slate-200">${day.Ø±ÙˆØ²}</td>
            <td class="px-4 py-3 text-sm text-slate-700 border-b border-slate-200" dir="ltr">${formatToman(raw.remainingPrincipalBefore || 0)}</td>
            <td class="px-4 py-3 text-sm text-slate-700 border-b border-slate-200" dir="ltr">
              ${raw.principalPayment > 0 ? `<span class="font-semibold text-green-600">${formatToman(raw.principalPayment)}</span>` : '<span class="text-slate-400">-</span>'}
            </td>
            <td class="px-4 py-3 text-sm text-slate-700 border-b border-slate-200" dir="ltr">
              ${raw.interestPayment > 0 ? `<span class="font-semibold text-orange-600">${formatToman(raw.interestPayment)}</span>` : '<span class="text-slate-400">-</span>'}
            </td>
            <td class="px-4 py-3 text-sm font-semibold text-slate-900 border-b border-slate-200" dir="ltr">
              ${raw.totalPayment > 0 ? `<span class="text-blue-600">${formatToman(raw.totalPayment)}</span>` : '<span class="text-slate-400">-</span>'}
            </td>
            <td class="px-4 py-3 text-sm text-slate-600 border-b border-slate-200">${day.ØªÙˆØ¶ÛŒØ­Ø§Øª}</td>
          </tr>
        `;
      }).join('');

      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function resetForm() {
      document.getElementById('loanForm').style.display = 'block';
      document.getElementById('resultsSection').style.display = 'none';
      document.getElementById('loanForm').reset();
      document.getElementById('principalRepayments').innerHTML = '';
      document.getElementById('interestPaymentDates').innerHTML = '';
      principalRepaymentCount = 0;
      interestDateCount = 0;
      addPrincipalRepayment();
      addInterestDate();
    }
  </script>
</body>
</html>

