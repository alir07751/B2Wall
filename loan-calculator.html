<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒÚ¯Ø± Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª ÙˆØ§Ù…</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Vazirmatn', 'IRANSans', system-ui, -apple-system, sans-serif; 
      background: #f5f7fa; 
      line-height: 1.6;
      direction: rtl;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }
    .card { 
      background: #fff; 
      border: 1px solid #e2e8f0; 
      border-radius: 1rem; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.06); 
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      transition: box-shadow 0.2s;
    }
    .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .card-header {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid #e2e8f0;
    }
    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #334155;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .input-field {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid #cbd5e1;
      border-radius: 0.75rem;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.2s;
      background: #fff;
      font-family: 'Vazirmatn', system-ui;
      direction: ltr;
      text-align: left;
    }
    .input-field:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .input-field.error {
      border-color: #ef4444;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.2s;
      cursor: pointer;
      border: none;
      font-family: 'Vazirmatn', system-ui;
    }
    .btn-primary {
      background: #3b82f6;
      color: #fff;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }
    .btn-primary:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    .btn-primary:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      transform: none;
    }
    .btn-secondary {
      background: #f1f5f9;
      color: #475569;
      border: 1px solid #e2e8f0;
    }
    .btn-secondary:hover {
      background: #e2e8f0;
    }
    .btn-success {
      background: #10b981;
      color: #fff;
    }
    .btn-success:hover {
      background: #059669;
    }
    .btn-danger {
      background: #ef4444;
      color: #fff;
    }
    .btn-danger:hover {
      background: #dc2626;
    }
    .label {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      color: #475569;
      margin-bottom: 0.5rem;
    }
    .label-required::after {
      content: ' *';
      color: #ef4444;
    }
    .help-text {
      font-size: 0.8rem;
      color: #64748b;
      margin-top: 0.5rem;
      line-height: 1.5;
    }
    .error-text {
      font-size: 0.8rem;
      color: #ef4444;
      margin-top: 0.25rem;
    }
    .toggle-switch {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem;
      background: #f8fafc;
      border-radius: 0.75rem;
      border: 1px solid #e2e8f0;
      cursor: pointer;
      transition: all 0.2s;
    }
    .toggle-switch:hover {
      background: #f1f5f9;
    }
    .toggle-switch input[type="checkbox"] {
      width: 2.5rem;
      height: 1.5rem;
      cursor: pointer;
    }
    .module-content {
      margin-top: 1rem;
      padding: 1rem;
      background: #fafbfc;
      border-radius: 0.75rem;
      border: 1px solid #e2e8f0;
    }
    .module-content.hidden {
      display: none;
    }
    .auto-split-section {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .auto-split-controls {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 1rem;
      align-items: end;
      margin-top: 1rem;
    }
    @media (max-width: 768px) {
      .auto-split-controls {
        grid-template-columns: 1fr;
      }
    }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 0.9rem;
    }
    th {
      background: #f1f5f9;
      font-weight: 700;
      padding: 1rem;
      text-align: right;
      border-bottom: 2px solid #e2e8f0;
      color: #334155;
      white-space: nowrap;
    }
    td {
      padding: 0.875rem 1rem;
      text-align: right;
      border-bottom: 1px solid #e5e7eb;
      color: #475569;
    }
    tr:hover {
      background: #f8fafc;
    }
    .summary-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      padding: 1.5rem;
      border-radius: 1rem;
      margin-bottom: 1rem;
    }
    .summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    .summary-item:last-child {
      border-bottom: none;
    }
    .summary-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    .summary-value {
      font-size: 1.25rem;
      font-weight: 700;
      font-family: 'Vazirmatn', system-ui;
      font-feature-settings: 'tnum';
    }
    .loading {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid #fff;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .row-item {
      display: flex;
      gap: 1rem;
      align-items: flex-start;
      margin-bottom: 1rem;
      padding: 1rem;
      background: #fafbfc;
      border-radius: 0.75rem;
      border: 1px solid #e2e8f0;
    }
    .row-item > div {
      flex: 1;
    }
    .remove-btn {
      background: none;
      border: none;
      color: #ef4444;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.5rem;
      transition: all 0.2s;
    }
    .remove-btn:hover {
      background: #fee2e2;
    }
    .persian-number {
      font-family: 'Vazirmatn', system-ui;
      font-feature-settings: 'tnum';
      direction: rtl;
    }
    .divider {
      height: 1px;
      background: #e2e8f0;
      margin: 1.5rem 0;
    }
    .error-banner {
      position: fixed;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: #fee2e2;
      border: 2px solid #ef4444;
      border-radius: 0.75rem;
      padding: 1rem 1.5rem;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
      z-index: 1000;
      max-width: 90%;
      display: flex;
      align-items: center;
      gap: 1rem;
      animation: slideDown 0.3s ease-out;
    }
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }
    .error-banner.hidden {
      display: none;
    }
    .error-banner-close {
      background: none;
      border: none;
      color: #dc2626;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.5rem;
      transition: background 0.2s;
    }
    .error-banner-close:hover {
      background: rgba(220, 38, 38, 0.1);
    }
  </style>
</head>
<body>
  <header class="bg-white border-b border-slate-200 shadow-sm">
    <div class="container">
      <h1 class="text-2xl font-bold text-slate-900">Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒÚ¯Ø± Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª ÙˆØ§Ù…</h1>
      <p class="text-sm text-slate-600 mt-1">Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ø¯Ù‚ÛŒÙ‚ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª ÙˆØ§Ù… Ø¨Ø§ Ø¬Ø¯ÙˆÙ„ ØªÙØµÛŒÙ„ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡</p>
    </div>
  </header>

  <main class="container">
    <form id="calculatorForm">
      <!-- Ø¨Ø®Ø´ Û±: Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ§Ù… -->
      <div class="card">
        <div class="card-header">ğŸ“‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ§Ù…</div>
        
        <div class="mb-4">
          <label for="loanAmount" class="label label-required">Ù…Ø¨Ù„Øº ÙˆØ§Ù… (ØªÙˆÙ…Ø§Ù†)</label>
          <input type="text" id="loanAmount" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 330000000" 
                 oninput="LoanModule.updateAmountDisplay()" />
          <div id="loanAmountDisplay" class="help-text persian-number text-blue-600 font-semibold"></div>
          <div class="help-text">ğŸ’¡ Ù…Ø¨Ù„Øº Ú©Ù„ ÙˆØ§Ù… Ø±Ø§ Ø¨Ù‡ ØªÙˆÙ…Ø§Ù† ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯. Ø§Ø¹Ø¯Ø§Ø¯ Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.</div>
      </div>

        <div class="mb-4">
          <label for="monthlyRate" class="label label-required">Ù†Ø±Ø® Ø³ÙˆØ¯ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ (%)</label>
          <input type="text" id="monthlyRate" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 4.5" 
                 oninput="LoanModule.validateRate()" />
          <div id="monthlyRateError" class="error-text"></div>
          <div class="help-text">ğŸ’¡ Ù†Ø±Ø® Ø³ÙˆØ¯ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ Ø¨Ø±Ø­Ø³Ø¨ Ø¯Ø±ØµØ¯ ÙˆØ§Ø±Ø¯ Ø´ÙˆØ¯ (Ù…Ø«Ù„Ø§Ù‹ Û´.Ûµ Ø¨Ø±Ø§ÛŒ Û´.ÛµÙª)</div>
        </div>
      </div>

      <!-- Ø¨Ø®Ø´ Û²: Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª Ø§ØµÙ„ -->
      <div class="card">
        <div class="card-header">ğŸ“… Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª Ø§ØµÙ„ Ù¾ÙˆÙ„</div>
        
        <div class="auto-split-section">
          <label class="toggle-switch">
            <input type="checkbox" id="autoPrincipalMode" onchange="PrincipalModule.toggleAuto()" />
            <span class="font-semibold text-slate-900">ØªÙ‚Ø³ÛŒÙ… Ø®ÙˆØ¯Ú©Ø§Ø± Ø§ØµÙ„ Ù¾ÙˆÙ„</span>
          </label>
          <div class="help-text mr-7 mt-2">Ø¨Ø§ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ† Ú¯Ø²ÛŒÙ†Ù‡ØŒ Ø³ÛŒØ³ØªÙ… Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø§ØµÙ„ Ù¾ÙˆÙ„ Ø±Ø§ ØªÙ‚Ø³ÛŒÙ… Ù…ÛŒâ€ŒÚ©Ù†Ø¯</div>
          
          <div id="autoPrincipalOptions" class="hidden mt-4">
            <div class="auto-split-controls">
            <div>
                <label class="label">Ø±ÙˆØ´ ØªÙ‚Ø³ÛŒÙ…</label>
                <select id="principalSplitMethod" class="input-field">
                  <option value="equal">ØªÙ‚Ø³ÛŒÙ… Ù…Ø³Ø§ÙˆÛŒ</option>
                  <option value="interval">ØªÙ‚Ø³ÛŒÙ… Ø¨Ø± Ø§Ø³Ø§Ø³ ÙØ§ØµÙ„Ù‡ Ø²Ù…Ø§Ù†ÛŒ</option>
                </select>
                <div class="help-text">Ø±ÙˆØ´ ØªÙ‚Ø³ÛŒÙ… Ø®ÙˆØ¯Ú©Ø§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>
              </div>
              <div id="principalIntervalContainer">
                <label class="label">ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ (Ø±ÙˆØ²)</label>
                <input type="text" id="principalPaymentInterval" class="input-field" value="30" placeholder="Ù…Ø«Ø§Ù„: 30" 
                       oninput="this.value = formatInteger(this.value)" />
                <div class="help-text">ÙØ§ØµÙ„Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ø¨ÛŒÙ† Ù‡Ø± Ù¾Ø±Ø¯Ø§Ø®Øª</div>
            </div>
            <div>
                <label class="label">ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§</label>
                <input type="text" id="numberOfPayments" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 4" 
                       oninput="this.value = formatInteger(this.value)" />
                <div class="help-text">ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ Ù¾ÙˆÙ„</div>
              </div>
            </div>
            <button type="button" onclick="PrincipalModule.calculateAuto()" class="btn btn-primary mt-4">
              ğŸ§® Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø±
            </button>
            </div>
          </div>

        <div id="principalRows" class="space-y-3"></div>
        
        <button type="button" onclick="PrincipalModule.addRow()" class="btn btn-secondary mt-3">
          â• Ø§ÙØ²ÙˆØ¯Ù† Ø±Ø¯ÛŒÙ Ù¾Ø±Ø¯Ø§Ø®Øª
        </button>
        
        <div id="totalPrincipal" class="mt-4 p-4 bg-slate-50 rounded-lg"></div>
        </div>
        
      <!-- Ø¨Ø®Ø´ Û³: ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙˆØ¯ -->
      <div class="card">
        <div class="card-header">ğŸ“† ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙˆØ¯</div>
        
        <div class="auto-split-section">
          <label class="toggle-switch">
            <input type="checkbox" id="autoInterestMode" onchange="InterestModule.toggleAuto()" />
            <span class="font-semibold text-slate-900">ØªÙ‚Ø³ÛŒÙ… Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙˆØ¯</span>
          </label>
          <div class="help-text mr-7 mt-2">Ø¨Ø§ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ† Ú¯Ø²ÛŒÙ†Ù‡ØŒ Ø³ÛŒØ³ØªÙ… Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙˆØ¯ Ø±Ø§ ØªÙ‚Ø³ÛŒÙ… Ù…ÛŒâ€ŒÚ©Ù†Ø¯</div>
          
          <div id="autoInterestOptions" class="hidden mt-4">
            <div class="auto-split-controls">
              <div>
                <label class="label">Ø±ÙˆØ´ ØªÙ‚Ø³ÛŒÙ…</label>
                <select id="interestSplitMethod" class="input-field">
                  <option value="equal">ØªÙ‚Ø³ÛŒÙ… Ù…Ø³Ø§ÙˆÛŒ</option>
                  <option value="interval">ØªÙ‚Ø³ÛŒÙ… Ø¨Ø± Ø§Ø³Ø§Ø³ ÙØ§ØµÙ„Ù‡ Ø²Ù…Ø§Ù†ÛŒ</option>
                </select>
                <div class="help-text">Ø±ÙˆØ´ ØªÙ‚Ø³ÛŒÙ… Ø®ÙˆØ¯Ú©Ø§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>
            </div>
              <div id="interestIntervalContainer">
                <label class="label">ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ (Ø±ÙˆØ²)</label>
                <input type="text" id="interestPaymentInterval" class="input-field" value="90" placeholder="Ù…Ø«Ø§Ù„: 90" 
                       oninput="this.value = formatInteger(this.value)" />
                <div class="help-text">ÙØ§ØµÙ„Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ø¨ÛŒÙ† Ù‡Ø± Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙˆØ¯</div>
            </div>
              <div>
                <label class="label">ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§</label>
                <input type="text" id="numberOfInterestPayments" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 2" 
                       oninput="this.value = formatInteger(this.value)" />
                <div class="help-text">ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ø³ÙˆØ¯</div>
          </div>
        </div>
            <button type="button" onclick="InterestModule.calculateAuto()" class="btn btn-primary mt-4">
              ğŸ§® Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø±
            </button>
        </div>
      </div>

        <div id="interestDateRows" class="space-y-3"></div>
        
        <button type="button" onclick="InterestModule.addRow()" class="btn btn-secondary mt-3">
          â• Ø§ÙØ²ÙˆØ¯Ù† ØªØ§Ø±ÛŒØ® Ù¾Ø±Ø¯Ø§Ø®Øª
        </button>
        </div>
        
      <!-- Ø¨Ø®Ø´ Û´: Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ -->
      <div class="card">
        <div class="card-header">âš™ï¸ Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ø®ØªÛŒØ§Ø±ÛŒ</div>
        
        <!-- Ù…Ø§Ú˜ÙˆÙ„ Ú©Ø§Ø±Ù…Ø²Ø¯ -->
        <div class="mb-4">
          <label class="toggle-switch">
            <input type="checkbox" id="feeModuleEnabled" onchange="FeeModule.toggle()" />
            <span class="font-semibold text-slate-900">ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù…Ø§Ú˜ÙˆÙ„ Ú©Ø§Ø±Ù…Ø²Ø¯</span>
          </label>
          <div id="feeModuleContent" class="module-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="label">Ù†ÙˆØ¹ Ú©Ø§Ø±Ù…Ø²Ø¯</label>
                <select id="feeMode" class="input-field" onchange="FeeModule.updateDisplay()">
                  <option value="percentage">Ø¯Ø±ØµØ¯ÛŒ Ø§Ø² Ø§ØµÙ„ ÙˆØ§Ù…</option>
                  <option value="fixed">Ù…Ø¨Ù„Øº Ø«Ø§Ø¨Øª</option>
                </select>
            </div>
              <div id="feeRateContainer">
                <label class="label">Ù†Ø±Ø® Ú©Ø§Ø±Ù…Ø²Ø¯ (%)</label>
                <input type="text" id="feeRate" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 2" 
                       oninput="this.value = formatDecimal(this.value); FeeModule.updateDisplay()" />
            </div>
              <div id="feeAmountContainer" class="hidden">
                <label class="label">Ù…Ø¨Ù„Øº Ú©Ø§Ø±Ù…Ø²Ø¯ (ØªÙˆÙ…Ø§Ù†)</label>
                <input type="text" id="feeAmount" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 1000000" 
                       oninput="this.value = formatNumber(this.value); FeeModule.updateDisplay()" />
          </div>
        </div>
            <div id="feeDisplay" class="mt-4 p-3 bg-blue-50 rounded-lg hidden">
              <div class="text-sm font-semibold text-slate-700">Ù…Ø¨Ù„Øº Ú©Ø§Ø±Ù…Ø²Ø¯:</div>
              <div id="feeAmountDisplay" class="text-lg font-bold text-blue-700 persian-number"></div>
          </div>
        </div>
      </div>

        <div class="divider"></div>

        <!-- Ù…Ø§Ú˜ÙˆÙ„ Ø¶Ù…Ø§Ù†Øª -->
        <div class="mb-4">
          <label class="toggle-switch">
            <input type="checkbox" id="guaranteeModuleEnabled" onchange="GuaranteeModule.toggle()" />
            <span class="font-semibold text-slate-900">ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù…Ø§Ú˜ÙˆÙ„ Ø¶Ù…Ø§Ù†Øª</span>
          </label>
          <div id="guaranteeModuleContent" class="module-content hidden">
          <div>
              <label class="label">Ù†Ø±Ø® Ù‡Ø²ÛŒÙ†Ù‡ Ø¶Ù…Ø§Ù†Øª Ø§Ø² Ø§ØµÙ„ ÙˆØ§Ù… (%)</label>
              <input type="text" id="guaranteeRate" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 1.5" 
                     oninput="this.value = formatDecimal(this.value); GuaranteeModule.updateDisplay()" />
              <div class="help-text">Ø¯Ø±ØµØ¯ÛŒ Ø§Ø² Ù…Ø¨Ù„Øº Ø§ØµÙ„ÛŒ ÙˆØ§Ù… Ú©Ù‡ Ø¨Ù‡â€ŒØ¹Ù†ÙˆØ§Ù† Ù‡Ø²ÛŒÙ†Ù‡ Ø¶Ù…Ø§Ù†Øª Ù„Ø­Ø§Ø¸ Ù…ÛŒâ€ŒØ´ÙˆØ¯</div>
            </div>
            <div id="guaranteeDisplay" class="mt-4 p-3 bg-green-50 rounded-lg hidden">
              <div class="text-sm font-semibold text-slate-700">Ù…Ø¨Ù„Øº Ø¶Ù…Ø§Ù†Øª:</div>
              <div id="guaranteeAmountDisplay" class="text-lg font-bold text-green-700 persian-number"></div>
          </div>
        </div>
      </div>

        <div class="divider"></div>

        <!-- Ù…Ø§Ú˜ÙˆÙ„ Ù…Ø§Ù„ÛŒØ§Øª -->
        <div class="mb-4">
          <label class="toggle-switch">
            <input type="checkbox" id="taxModuleEnabled" onchange="TaxModule.toggle()" />
            <span class="font-semibold text-slate-900">ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù…Ø§Ú˜ÙˆÙ„ Ù…Ø§Ù„ÛŒØ§Øª</span>
          </label>
          <div id="taxModuleContent" class="module-content hidden">
            <div class="help-text mb-4">Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù…Ø§Ù„ÛŒØ§Øªâ€ŒÙ‡Ø§ÛŒÛŒ Ø±Ø§ Ú©Ù‡ Ø¯Ø±ØµØ¯ÛŒ Ø§Ø² Â«Ø³ÙˆØ¯ ÙˆØ§Ù…Â»ØŒ Â«Ù‡Ø²ÛŒÙ†Ù‡ Ú©Ø§Ø±Ù…Ø²Ø¯Â» ÛŒØ§ Â«Ù‡Ø²ÛŒÙ†Ù‡ Ø¶Ù…Ø§Ù†ØªÂ» Ù‡Ø³ØªÙ†Ø¯ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.</div>
            <div id="taxRows" class="space-y-3"></div>
            <button type="button" onclick="TaxModule.addRow()" class="btn btn-secondary mt-3">
              â• Ø§ÙØ²ÙˆØ¯Ù† Ø±Ø¯ÛŒÙ Ù…Ø§Ù„ÛŒØ§Øª
            </button>
            <div id="totalTaxes" class="mt-4 p-4 bg-slate-50 rounded-lg"></div>
        </div>
      </div>

        <div class="divider"></div>

        <!-- Ù…Ø§Ú˜ÙˆÙ„ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ -->
        <div class="mb-4">
          <label class="toggle-switch">
            <input type="checkbox" id="costScheduleModuleEnabled" onchange="CostScheduleModule.toggle()" />
            <span class="font-semibold text-slate-900">ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ ØªÙ‚Ø³ÛŒÙ… Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</span>
          </label>
          <div id="costScheduleModuleContent" class="module-content hidden">
            <div class="help-text mb-4">
              Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ ÛŒÚ©â€ŒØ¨Ø§Ø±Ù‡ (Ú©Ø§Ø±Ù…Ø²Ø¯ØŒ Ø¶Ù…Ø§Ù†Øª Ùˆ Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø§Ù„ÛŒØ§Øªâ€ŒÙ‡Ø§) Ø±Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¯Ø± ÛŒÚ© ÛŒØ§ Ú†Ù†Ø¯ Ø±ÙˆØ² Ø§Ø² Ø¯ÙˆØ±Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ù†ÛŒØ¯. Ù…Ø¬Ù…ÙˆØ¹ Ø¯Ø±ØµØ¯Ù‡Ø§ Ø¨Ø§ÛŒØ¯ Û±Û°Û°Ùª Ø¨Ø§Ø´Ø¯.
        </div>
            
            <!-- Auto-Split Section for Cost Schedule -->
            <div class="auto-split-section">
              <label class="toggle-switch">
                <input type="checkbox" id="autoCostScheduleMode" onchange="CostScheduleModule.toggleAutoSplit()" />
                <span class="font-semibold text-slate-900">ØªÙ‚Ø³ÛŒÙ… Ø®ÙˆØ¯Ú©Ø§Ø± Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</span>
              </label>
              <div class="help-text mr-7 mt-2">Ø¨Ø§ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ† Ú¯Ø²ÛŒÙ†Ù‡ØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± ØªÙ‚Ø³ÛŒÙ… Ú©Ù†ÛŒØ¯</div>
              
              <div id="autoCostScheduleOptions" class="hidden mt-4">
                <div class="auto-split-controls">
            <div>
                    <label class="label">Ø±ÙˆØ´ ØªÙ‚Ø³ÛŒÙ… Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</label>
                    <select id="costSplitMethod" class="input-field">
                      <option value="equal">ØªÙ‚Ø³ÛŒÙ… Ù…Ø³Ø§ÙˆÛŒ</option>
                      <option value="weighted">ØªÙ‚Ø³ÛŒÙ… Ù…ØªÙ†Ø§Ø³Ø¨ Ø¨Ø§ Ø±ÙˆØ²</option>
                      <option value="normalize">ØªÙ‚Ø³ÛŒÙ… Ø¯Ø±ØµØ¯ÛŒ (Ù¾ÛŒØ´Ø±ÙØªÙ‡)</option>
              </select>
                    <div class="help-text">Ø±ÙˆØ´ ØªÙ‚Ø³ÛŒÙ… Ø®ÙˆØ¯Ú©Ø§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>
            </div>
            </div>
                <button type="button" onclick="CostScheduleModule.calculateAuto()" class="btn btn-primary mt-4">
                  ğŸ§® Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø±
                </button>
            </div>
      </div>

            <div id="costScheduleRows" class="space-y-3 mt-4"></div>
            <button type="button" onclick="CostScheduleModule.addRow()" class="btn btn-secondary mt-3">
              â• Ø§ÙØ²ÙˆØ¯Ù† Ø±Ø¯ÛŒÙ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ
            </button>
            <div id="costScheduleTotal" class="mt-4 p-4 bg-slate-50 rounded-lg"></div>
        </div>
            </div>
      </div>

      <!-- Ø¯Ú©Ù…Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ -->
      <div class="card">
        <button type="submit" id="submitBtn" class="btn btn-primary w-full py-4 text-lg">
          ğŸ§® Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª
        </button>
      </div>
    </form>

    <!-- Ø¨Ø®Ø´ Ù†ØªØ§ÛŒØ¬ -->
    <div id="results" class="hidden">
      <div class="card">
        <div class="card-header">ğŸ“Š Ø®Ù„Ø§ØµÙ‡ Ù†ØªØ§ÛŒØ¬</div>
        <div id="summaryCards" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        
        <div class="mt-6 flex gap-3">
          <button type="button" onclick="ResultsModule.copyJSON()" class="btn btn-success">
            ğŸ“‹ Ú©Ù¾ÛŒ Ù†ØªØ§ÛŒØ¬ (JSON)
          </button>
          <button type="button" onclick="ResultsModule.downloadJSON()" class="btn btn-success">
            ğŸ’¾ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ JSON
          </button>
          <button type="button" onclick="resetForm()" class="btn btn-secondary">
            ğŸ”„ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¬Ø¯Ø¯
          </button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">ğŸ“‹ Ø¬Ø¯ÙˆÙ„ ØªÙØµÛŒÙ„ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª</div>
        <div class="overflow-x-auto">
          <table id="scheduleTable">
            <thead>
              <tr>
                <th>Ø±ÙˆØ²</th>
                <th>Ø§ØµÙ„ Ù¾ÙˆÙ„ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ (Ù‚Ø¨Ù„)</th>
                <th>Ù¾Ø±Ø¯Ø§Ø®Øª Ø§ØµÙ„ Ù¾ÙˆÙ„</th>
                <th>Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙˆØ¯</th>
                <th>Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</th>
                <th>Ú©Ù„ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ</th>
                <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="scheduleBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script>
    // ============================================================================
    // UTILITY FUNCTIONS (Shared utilities - no changes)
    // ============================================================================

    function toEnglish(str) {
      if (!str) return '';
      const persian = ['Û°', 'Û±', 'Û²', 'Û³', 'Û´', 'Ûµ', 'Û¶', 'Û·', 'Û¸', 'Û¹'];
      const arabic = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
      let result = str.toString();
      persian.forEach((p, i) => result = result.replace(new RegExp(p, 'g'), i));
      arabic.forEach((a, i) => result = result.replace(new RegExp(a, 'g'), i));
      return result;
    }

    function toPersian(num) {
      const persian = ['Û°', 'Û±', 'Û²', 'Û³', 'Û´', 'Ûµ', 'Û¶', 'Û·', 'Û¸', 'Û¹'];
      return num.toString().replace(/\d/g, d => persian[parseInt(d)]);
    }

    function formatToman(num) {
      if (typeof num !== 'number' || isNaN(num)) return 'Û° ØªÙˆÙ…Ø§Ù†';
      const rounded = Math.round(num);
      const formatted = rounded.toLocaleString('en-US');
      return toPersian(formatted) + ' ØªÙˆÙ…Ø§Ù†';
    }

    function parseNumber(str) {
      if (!str) return 0;
      const cleaned = toEnglish(str).replace(/[^\d.]/g, '');
      return parseFloat(cleaned) || 0;
    }

    function formatNumber(str) {
      const cleaned = toEnglish(str).replace(/[^\d]/g, '');
      return cleaned.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function formatInteger(str) {
      const cleaned = toEnglish(str).replace(/[^\d]/g, '');
      return cleaned;
    }

    function formatDecimal(str) {
      let cleaned = toEnglish(str).replace(/[^\d.]/g, '');
      const parts = cleaned.split('.');
      if (parts.length > 2) {
        cleaned = parts[0] + '.' + parts.slice(1).join('');
      }
      const [intPart, decPart] = cleaned.split('.');
      const groupedInt = (intPart || '').replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      return decPart !== undefined ? `${groupedInt}.${decPart}` : groupedInt;
    }

    // ============================================================================
    // AUTOSPLIT MODULE (Unified)
    // ============================================================================

    const AutoSplit = {
      /**
       * Equal distribution: divide 100% equally among all days
       */
      equalSplit(days) {
        if (!Array.isArray(days) || days.length === 0) return [];
        const percent = 100 / days.length;
        return days.map(() => percent);
      },

      /**
       * Weighted by day: distribute based on day values (proportional)
       */
      weightedSplit(days) {
        if (!Array.isArray(days) || days.length === 0) return [];
        const total = days.reduce((sum, day) => sum + day, 0);
        if (total === 0) return this.equalSplit(days);
        return days.map(day => (day / total) * 100);
      },

      /**
       * Normalize entered percentages: scale to sum to 100%
       */
      normalizeSplit(entries) {
        if (!Array.isArray(entries) || entries.length === 0) return [];
        const sum = entries.reduce((s, e) => s + (e.percent || 0), 0);
        if (sum === 0) return this.equalSplit(entries.map(e => e.day));
        const scale = 100 / sum;
        return entries.map(e => (e.percent || 0) * scale);
      },

      /**
       * Apply calculated percentages to rows
       */
      applyToRows(containerSelector, percentages, dayInputName, percentInputName) {
        const rows = document.querySelectorAll(containerSelector + ' .row-item');
        if (rows.length !== percentages.length) {
          console.error('Row count mismatch');
          return false;
        }

        rows.forEach((row, index) => {
          const percentInput = row.querySelector(`[name="${percentInputName}"]`);
          if (percentInput) {
            const percent = percentages[index];
            percentInput.value = percent.toFixed(2);
            // Trigger input event to format
            percentInput.dispatchEvent(new Event('input'));
          }
        });

        return true;
      }
    };

    // ============================================================================
    // BASE COMPONENT CLASS (Optional helper for shared functionality)
    // ============================================================================

    class BaseComponent {
      constructor(id) {
        this.id = id;
        this.element = document.getElementById(id);
      }

      getElement(selector) {
        return this.element ? this.element.querySelector(selector) : null;
      }

      getElements(selector) {
        return this.element ? Array.from(this.element.querySelectorAll(selector)) : [];
      }
    }

    // ============================================================================
    // COMPONENT CLASSES
    // ============================================================================

    class LoanInputComponent extends BaseComponent {
      constructor() {
        super('calculatorForm');
        this.loanAmountEl = document.getElementById('loanAmount');
        this.monthlyRateEl = document.getElementById('monthlyRate');
        this.loanAmountDisplayEl = document.getElementById('loanAmountDisplay');
        this.monthlyRateErrorEl = document.getElementById('monthlyRateError');
      }

      render() {
        // HTML is already rendered, just bind events
        this.bindEvents();
      }

      bindEvents() {
        if (this.loanAmountEl) {
          this.loanAmountEl.addEventListener('input', () => this.updateAmountDisplay());
        }
        if (this.monthlyRateEl) {
          this.monthlyRateEl.addEventListener('input', () => this.validateRate());
        }
      }

      updateAmountDisplay() {
        const value = this.loanAmountEl.value;
        const num = parseNumber(value);
        if (this.loanAmountDisplayEl) {
          if (num > 0) {
            this.loanAmountDisplayEl.textContent = formatToman(num);
          } else {
            this.loanAmountDisplayEl.textContent = '';
          }
        }
        // Notify other components
        if (window.appController) {
          window.appController.notifyLoanAmountChange();
        }
      }

      validateRate() {
        const value = this.monthlyRateEl.value;
        const num = parseNumber(value);
        
        if (this.monthlyRateErrorEl && this.monthlyRateEl) {
          if (value && (num <= 0 || num > 100)) {
            this.monthlyRateErrorEl.textContent = 'Ù†Ø±Ø® Ø³ÙˆØ¯ Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† Û° ØªØ§ Û±Û°Û° Ø¯Ø±ØµØ¯ Ø¨Ø§Ø´Ø¯';
            this.monthlyRateEl.classList.add('error');
          } else {
            this.monthlyRateErrorEl.textContent = '';
            this.monthlyRateEl.classList.remove('error');
          }
        }
      }

      getData() {
        const amount = parseNumber(this.loanAmountEl?.value || '');
        const monthlyRate = parseNumber(this.monthlyRateEl?.value || '');
        
        if (amount <= 0 || monthlyRate <= 0 || monthlyRate > 100) {
          return null;
        }
        
        return { amount, monthlyInterestRate: monthlyRate };
      }

      setData(data) {
        if (data && data.amount) {
          if (this.loanAmountEl) this.loanAmountEl.value = formatNumber(data.amount.toString());
        }
        if (data && data.monthlyInterestRate) {
          if (this.monthlyRateEl) this.monthlyRateEl.value = formatDecimal(data.monthlyInterestRate.toString());
        }
        this.updateAmountDisplay();
        this.validateRate();
      }

      reset() {
        if (this.loanAmountEl) this.loanAmountEl.value = '';
        if (this.monthlyRateEl) this.monthlyRateEl.value = '';
        if (this.loanAmountDisplayEl) this.loanAmountDisplayEl.textContent = '';
        if (this.monthlyRateErrorEl) this.monthlyRateErrorEl.textContent = '';
        if (this.monthlyRateEl) this.monthlyRateEl.classList.remove('error');
      }

      validate() {
        const config = this.getData();
        if (!config) {
          alert('Ù„Ø·ÙØ§Ù‹ Ù…Ø¨Ù„Øº ÙˆØ§Ù… Ùˆ Ù†Ø±Ø® Ø³ÙˆØ¯ Ø±Ø§ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
          return false;
        }
        return true;
      }
    }

    // ============================================================================
    // LEGACY MODULE WRAPPERS (Temporary - will be replaced by components)
    // ============================================================================

    // ============================================================================
    // LOAN MODULE (Legacy - will be removed)
    // ============================================================================

    const LoanModule = {
      updateAmountDisplay() {
        const value = document.getElementById('loanAmount').value;
        const num = parseNumber(value);
        const display = document.getElementById('loanAmountDisplay');
        if (num > 0) {
          display.textContent = formatToman(num);
        } else {
          display.textContent = '';
        }
        FeeModule.updateDisplay();
        GuaranteeModule.updateDisplay();
      },

      validateRate() {
        const value = document.getElementById('monthlyRate').value;
        const num = parseNumber(value);
        const errorEl = document.getElementById('monthlyRateError');
        const inputEl = document.getElementById('monthlyRate');
        
        if (value && (num <= 0 || num > 100)) {
          errorEl.textContent = 'Ù†Ø±Ø® Ø³ÙˆØ¯ Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† Û° ØªØ§ Û±Û°Û° Ø¯Ø±ØµØ¯ Ø¨Ø§Ø´Ø¯';
          inputEl.classList.add('error');
        } else {
          errorEl.textContent = '';
          inputEl.classList.remove('error');
        }
      },

      getConfig() {
        const amount = parseNumber(document.getElementById('loanAmount').value);
        const monthlyRate = parseNumber(document.getElementById('monthlyRate').value);
        
        if (amount <= 0 || monthlyRate <= 0 || monthlyRate > 100) {
          return null;
        }
        
        return { amount, monthlyInterestRate: monthlyRate };
      },

      validate() {
        const config = this.getConfig();
        if (!config) {
          alert('Ù„Ø·ÙØ§Ù‹ Ù…Ø¨Ù„Øº ÙˆØ§Ù… Ùˆ Ù†Ø±Ø® Ø³ÙˆØ¯ Ø±Ø§ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
          return false;
        }
        return true;
      }
    };

    // ============================================================================
    // PRINCIPAL MODULE
    // ============================================================================

    const PrincipalModule = {
      init() {
        this.addRow();
      },

      toggleAuto() {
      const isChecked = document.getElementById('autoPrincipalMode').checked;
      const options = document.getElementById('autoPrincipalOptions');
      const rows = document.getElementById('principalRows');
      
      if (isChecked) {
        options.classList.remove('hidden');
          rows.innerHTML = '';
      } else {
        options.classList.add('hidden');
          if (rows.children.length === 0) {
            this.addRow();
          }
        }
      },

      calculateAuto() {
        if (!document.getElementById('autoPrincipalMode').checked) return;
        
        const method = document.getElementById('principalSplitMethod').value;
        const numPayments = parseInt(formatInteger(document.getElementById('numberOfPayments').value)) || 0;
        const interval = parseInt(formatInteger(document.getElementById('principalPaymentInterval').value)) || 30;
        
        if (numPayments <= 0) {
          alert('ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ø¨Ø²Ø±Ú¯â€ŒØªØ± Ø§Ø² ØµÙØ± Ø¨Ø§Ø´Ø¯');
          return;
        }
        
        // For interval mode: simple calculation, no dependencies
        if (method === 'interval') {
          if (interval <= 0) {
            alert('ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ø¨Ø²Ø±Ú¯â€ŒØªØ± Ø§Ø² ØµÙØ± Ø¨Ø§Ø´Ø¯');
            return;
          }
          
          // Generate days: day = (i + 1) * interval
          const rows = document.getElementById('principalRows');
          rows.innerHTML = '';
          
          const loanAmount = parseNumber(document.getElementById('loanAmount').value);
          const amountPerPayment = loanAmount > 0 ? Math.floor(loanAmount / numPayments) : 0;
          const remainder = loanAmount > 0 ? loanAmount - (amountPerPayment * numPayments) : 0;
          
          for (let i = 0; i < numPayments; i++) {
            const days = (i + 1) * interval;
            const amount = i === numPayments - 1 ? amountPerPayment + remainder : amountPerPayment;
            
            const div = document.createElement('div');
            div.className = 'row-item';
            div.innerHTML = `
              <div>
                <label class="label">Ø±ÙˆØ²</label>
                <input type="text" name="principalDay" class="input-field" value="${days}" />
                <div class="help-text">Ø±ÙˆØ² Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ² Ø§Ø² Ø´Ø±ÙˆØ¹ ÙˆØ§Ù… ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
              </div>
              <div>
                <label class="label">Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</label>
                <input type="text" name="principalAmount" class="input-field" value="${formatNumber(amount.toString())}" 
                       oninput="this.value = formatNumber(this.value); PrincipalModule.updateTotal()" />
              </div>
              <button type="button" onclick="this.parentElement.remove(); PrincipalModule.updateTotal()" class="remove-btn">Ã—</button>
            `;
            rows.appendChild(div);
          }
          
          this.updateTotal();
          return;
        }
        
        // For equal mode: require totalLoanDuration
        if (method === 'equal') {
          // Try to derive totalLoanDuration from interest payment dates
          const interestDates = [];
          document.querySelectorAll('[name="interestDate"]').forEach(input => {
            const day = parseInt(toEnglish(input.value));
            if (day > 0) interestDates.push(day);
          });
          
          let totalLoanDuration = 0;
          if (interestDates.length > 0) {
            totalLoanDuration = Math.max(...interestDates);
          }
          
          if (totalLoanDuration <= 0) {
            alert('Ø¨Ø±Ø§ÛŒ ØªÙ‚Ø³ÛŒÙ… Ù…Ø³Ø§ÙˆÛŒØŒ Ù„Ø·ÙØ§Ù‹ Ù…Ø¯Øª Ú©Ù„ ÙˆØ§Ù… Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯');
            return;
          }
          
          const rows = document.getElementById('principalRows');
          rows.innerHTML = '';
          
          const loanAmount = parseNumber(document.getElementById('loanAmount').value);
          const amountPerPayment = loanAmount > 0 ? Math.floor(loanAmount / numPayments) : 0;
          const remainder = loanAmount > 0 ? loanAmount - (amountPerPayment * numPayments) : 0;
          const daysPerPayment = totalLoanDuration / numPayments;
          
          for (let i = 0; i < numPayments; i++) {
            const days = Math.round((i + 1) * daysPerPayment);
            const amount = i === numPayments - 1 ? amountPerPayment + remainder : amountPerPayment;
            
            const div = document.createElement('div');
            div.className = 'row-item';
            div.innerHTML = `
              <div>
                <label class="label">Ø±ÙˆØ²</label>
                <input type="text" name="principalDay" class="input-field" value="${days}" />
                <div class="help-text">Ø±ÙˆØ² Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ² Ø§Ø² Ø´Ø±ÙˆØ¹ ÙˆØ§Ù… ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
              </div>
              <div>
                <label class="label">Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</label>
                <input type="text" name="principalAmount" class="input-field" value="${formatNumber(amount.toString())}" 
                       oninput="this.value = formatNumber(this.value); PrincipalModule.updateTotal()" />
              </div>
              <button type="button" onclick="this.parentElement.remove(); PrincipalModule.updateTotal()" class="remove-btn">Ã—</button>
            `;
            rows.appendChild(div);
          }
          
          this.updateTotal();
        }
      },

      addRow() {
        if (document.getElementById('autoPrincipalMode').checked) return;
        const container = document.getElementById('principalRows');
        const div = document.createElement('div');
        div.className = 'row-item';
        div.innerHTML = `
          <div>
            <label class="label">Ø±ÙˆØ²</label>
            <input type="text" name="principalDay" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 60" />
            <div class="help-text">Ø±ÙˆØ² Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ² Ø§Ø² Ø´Ø±ÙˆØ¹ ÙˆØ§Ù… ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
          </div>
          <div>
            <label class="label">Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</label>
            <input type="text" name="principalAmount" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 30000000" 
                   oninput="this.value = formatNumber(this.value); PrincipalModule.updateTotal()" />
          </div>
          <button type="button" onclick="this.parentElement.remove(); PrincipalModule.updateTotal()" class="remove-btn">Ã—</button>
        `;
        container.appendChild(div);
      },

      updateTotal() {
      const rows = document.querySelectorAll('[name="principalAmount"]');
      let total = 0;
      rows.forEach(row => total += parseNumber(row.value));
      const loanAmount = parseNumber(document.getElementById('loanAmount').value);
      const display = document.getElementById('totalPrincipal');
        
      display.innerHTML = `
        <div class="flex items-center justify-between">
            <span class="font-semibold">Ù…Ø¬Ù…ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ Ù¾ÙˆÙ„:</span>
            <span class="text-lg font-bold ${Math.abs(total - loanAmount) <= 1 ? 'text-green-600' : 'text-red-600'} persian-number">
            ${formatToman(total)}
          </span>
        </div>
        ${loanAmount > 0 ? `
          <div class="mt-2 flex items-center justify-between">
            <span class="text-sm text-slate-600">Ù…Ø¨Ù„Øº ÙˆØ§Ù…:</span>
              <span class="text-sm font-semibold persian-number">${formatToman(loanAmount)}</span>
          </div>
        ` : ''}
        ${Math.abs(total - loanAmount) <= 1 && loanAmount > 0 ? 
          '<p class="text-green-600 text-sm mt-2">âœ“ Ù…Ø¬Ù…ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ Ø¨Ø§ Ù…Ø¨Ù„Øº ÙˆØ§Ù… Ù…Ø·Ø§Ø¨Ù‚Øª Ø¯Ø§Ø±Ø¯</p>' : ''}
      `;
      },

      getConfig() {
        const repayments = [];
        document.querySelectorAll('[name="principalDay"]').forEach((dayInput, index) => {
          const day = parseInt(toEnglish(dayInput.value));
          const amount = parseNumber(document.querySelectorAll('[name="principalAmount"]')[index].value);
          if (day > 0 && amount > 0) {
            repayments.push({ days: day, amount: amount });
          }
        });
        return repayments;
      },

      validate() {
        const repayments = this.getConfig();
        if (repayments.length === 0) {
          alert('Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ù¾Ø±Ø¯Ø§Ø®Øª Ø§ØµÙ„ Ù¾ÙˆÙ„ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
          return false;
        }
        return true;
      }
    };

    // ============================================================================
    // INTEREST MODULE
    // ============================================================================

    const InterestModule = {
      init() {
        this.addRow();
      },

      toggleAuto() {
      const isChecked = document.getElementById('autoInterestMode').checked;
      const options = document.getElementById('autoInterestOptions');
      const rows = document.getElementById('interestDateRows');
      
      if (isChecked) {
        options.classList.remove('hidden');
          rows.innerHTML = '';
      } else {
        options.classList.add('hidden');
          if (rows.children.length === 0) {
            this.addRow();
          }
        }
      },

      calculateAuto() {
        if (!document.getElementById('autoInterestMode').checked) return;
        
        const method = document.getElementById('interestSplitMethod').value;
        const numPayments = parseInt(formatInteger(document.getElementById('numberOfInterestPayments').value)) || 0;
        const interval = parseInt(formatInteger(document.getElementById('interestPaymentInterval').value)) || 90;
        
        if (numPayments <= 0) {
          alert('ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ø¨Ø²Ø±Ú¯â€ŒØªØ± Ø§Ø² ØµÙØ± Ø¨Ø§Ø´Ø¯');
          return;
        }
        
        // For interval mode: simple calculation, no dependencies
        if (method === 'interval') {
          if (interval <= 0) {
            alert('ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ø¨Ø²Ø±Ú¯â€ŒØªØ± Ø§Ø² ØµÙØ± Ø¨Ø§Ø´Ø¯');
            return;
          }
          
          // Generate days: day = (i + 1) * interval
          const rows = document.getElementById('interestDateRows');
          rows.innerHTML = '';
          
          for (let i = 0; i < numPayments; i++) {
            const days = (i + 1) * interval;
            
            const div = document.createElement('div');
            div.className = 'row-item';
            div.innerHTML = `
              <div>
                <label class="label">Ø±ÙˆØ²</label>
                <input type="text" name="interestDate" class="input-field" value="${days}" />
                <div class="help-text">Ø±ÙˆØ² Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ² Ø§Ø² Ø´Ø±ÙˆØ¹ ÙˆØ§Ù… ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
              </div>
              <button type="button" onclick="this.parentElement.remove()" class="remove-btn">Ã—</button>
            `;
            rows.appendChild(div);
          }
          return;
        }
        
        // For equal mode: require totalLoanDuration
        if (method === 'equal') {
          // Try to derive totalLoanDuration from principal repayment days
          const principalDays = [];
          document.querySelectorAll('[name="principalDay"]').forEach(input => {
            const day = parseInt(toEnglish(input.value));
            if (day > 0) principalDays.push(day);
          });
          
          let totalLoanDuration = 0;
          if (principalDays.length > 0) {
            totalLoanDuration = Math.max(...principalDays);
          }
          
          if (totalLoanDuration <= 0) {
            alert('Ø¨Ø±Ø§ÛŒ ØªÙ‚Ø³ÛŒÙ… Ù…Ø³Ø§ÙˆÛŒØŒ Ù„Ø·ÙØ§Ù‹ Ù…Ø¯Øª Ú©Ù„ ÙˆØ§Ù… Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯');
            return;
          }
          
          const rows = document.getElementById('interestDateRows');
          rows.innerHTML = '';
          
          const daysPerPayment = totalLoanDuration / numPayments;
          
          for (let i = 0; i < numPayments; i++) {
            const days = Math.round((i + 1) * daysPerPayment);
            
            const div = document.createElement('div');
            div.className = 'row-item';
            div.innerHTML = `
              <div>
                <label class="label">Ø±ÙˆØ²</label>
                <input type="text" name="interestDate" class="input-field" value="${days}" />
                <div class="help-text">Ø±ÙˆØ² Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ² Ø§Ø² Ø´Ø±ÙˆØ¹ ÙˆØ§Ù… ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
              </div>
              <button type="button" onclick="this.parentElement.remove()" class="remove-btn">Ã—</button>
            `;
            rows.appendChild(div);
          }
        }
      },

      addRow() {
        if (document.getElementById('autoInterestMode').checked) return;
        const container = document.getElementById('interestDateRows');
        const div = document.createElement('div');
        div.className = 'row-item';
        div.innerHTML = `
          <div>
            <label class="label">Ø±ÙˆØ²</label>
            <input type="text" name="interestDate" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 180" />
            <div class="help-text">Ø±ÙˆØ² Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ² Ø§Ø² Ø´Ø±ÙˆØ¹ ÙˆØ§Ù… ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
          </div>
          <button type="button" onclick="this.parentElement.remove()" class="remove-btn">Ã—</button>
        `;
        container.appendChild(div);
      },

      getConfig() {
        const dates = [];
        document.querySelectorAll('[name="interestDate"]').forEach(input => {
          const day = parseInt(toEnglish(input.value));
          if (day > 0) dates.push(day);
        });
        return dates;
      },

      validate() {
        const dates = this.getConfig();
        if (dates.length === 0) {
          alert('Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© ØªØ§Ø±ÛŒØ® Ù¾Ø±Ø¯Ø§Ø®Øª Ø³ÙˆØ¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
          return false;
        }
        return true;
      }
    };

    // ============================================================================
    // FEE MODULE
    // ============================================================================

    const FeeModule = {
      toggle() {
        const isEnabled = document.getElementById('feeModuleEnabled').checked;
        const content = document.getElementById('feeModuleContent');
        if (isEnabled) {
          content.classList.remove('hidden');
        } else {
          content.classList.add('hidden');
        }
      },

      updateDisplay() {
        const mode = document.getElementById('feeMode').value;
        const loanAmount = parseNumber(document.getElementById('loanAmount').value);
        
        document.getElementById('feeRateContainer').classList.toggle('hidden', mode !== 'percentage');
        document.getElementById('feeAmountContainer').classList.toggle('hidden', mode !== 'fixed');
        
        const config = this.getConfig();
        const display = document.getElementById('feeDisplay');
        
        if (!config || loanAmount <= 0) {
          display.classList.add('hidden');
          return;
        }
        
        let feeAmount = 0;
        if (config.mode === 'percentage') {
          feeAmount = loanAmount * (config.rate / 100);
        } else if (config.mode === 'fixed') {
          feeAmount = config.amount;
        }
        
        document.getElementById('feeAmountDisplay').textContent = formatToman(feeAmount);
        display.classList.remove('hidden');
        TaxModule.updateAll();
      },

      getConfig() {
        if (!document.getElementById('feeModuleEnabled').checked) {
          return null;
        }
        
        const mode = document.getElementById('feeMode').value;
        if (mode === 'percentage') {
          const rate = parseNumber(document.getElementById('feeRate').value);
          if (rate > 0) {
            return { mode, rate };
          }
        } else if (mode === 'fixed') {
          const amount = parseNumber(document.getElementById('feeAmount').value);
          if (amount > 0) {
            return { mode, amount };
          }
        }
        return null;
      },

      clear() {
        document.getElementById('feeModuleEnabled').checked = false;
        document.getElementById('feeMode').value = 'percentage';
        document.getElementById('feeRate').value = '';
        document.getElementById('feeAmount').value = '';
        this.toggle();
      }
    };

    // ============================================================================
    // GUARANTEE MODULE
    // ============================================================================

    const GuaranteeModule = {
      toggle() {
        const isEnabled = document.getElementById('guaranteeModuleEnabled').checked;
        const content = document.getElementById('guaranteeModuleContent');
        if (isEnabled) {
          content.classList.remove('hidden');
        } else {
          content.classList.add('hidden');
        }
      },

      updateDisplay() {
        const loanAmount = parseNumber(document.getElementById('loanAmount').value);
        const config = this.getConfig();
        const display = document.getElementById('guaranteeDisplay');
        
        if (!config || loanAmount <= 0) {
          display.classList.add('hidden');
          return;
        }
        
        const guaranteeAmount = loanAmount * (config.rate / 100);
        document.getElementById('guaranteeAmountDisplay').textContent = formatToman(guaranteeAmount);
        display.classList.remove('hidden');
        TaxModule.updateAll();
      },

      getConfig() {
        if (!document.getElementById('guaranteeModuleEnabled').checked) {
          return null;
        }
        
        const rate = parseNumber(document.getElementById('guaranteeRate').value);
        if (rate > 0) {
          return { rate };
        }
        return null;
      },

      clear() {
        document.getElementById('guaranteeModuleEnabled').checked = false;
        document.getElementById('guaranteeRate').value = '';
        this.toggle();
      }
    };

    // ============================================================================
    // TAX MODULE
    // ============================================================================

    const TaxModule = {
      toggle() {
        const isEnabled = document.getElementById('taxModuleEnabled').checked;
        const content = document.getElementById('taxModuleContent');
        if (isEnabled) {
          content.classList.remove('hidden');
          if (document.getElementById('taxRows').children.length === 0) {
            this.addRow();
          }
        } else {
          content.classList.add('hidden');
        }
      },

      addRow() {
      const container = document.getElementById('taxRows');
        const div = document.createElement('div');
        div.className = 'row-item';
        div.innerHTML = `
        <div>
            <label class="label">Ù¾Ø§ÛŒÙ‡ Ù…Ø­Ø§Ø³Ø¨Ù‡</label>
            <select name="taxBase" class="input-field" onchange="TaxModule.updateAll()">
            <option value="interest">Ø³ÙˆØ¯ ÙˆØ§Ù…</option>
            <option value="fees">Ù‡Ø²ÛŒÙ†Ù‡ Ú©Ø§Ø±Ù…Ø²Ø¯</option>
            <option value="guarantee">Ù‡Ø²ÛŒÙ†Ù‡ Ø¶Ù…Ø§Ù†Øª</option>
          </select>
        </div>
        <div>
            <label class="label">Ù†Ø±Ø® Ù…Ø§Ù„ÛŒØ§Øª (%)</label>
            <input type="text" name="taxRate" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 9" 
                   oninput="this.value = formatDecimal(this.value); TaxModule.updateAll()" />
        </div>
        <div class="self-end">
          <div class="text-xs text-slate-600 mb-1">Ù…Ø¨Ù„Øº Ù…Ø§Ù„ÛŒØ§Øª</div>
            <div class="font-bold text-blue-700 tax-amount persian-number">Û° ØªÙˆÙ…Ø§Ù†</div>
        </div>
          <button type="button" onclick="this.parentElement.remove(); TaxModule.updateAll()" class="remove-btn">Ã—</button>
        `;
        container.appendChild(div);
        this.updateAll();
      },

      /**
       * Estimate interest based on loan parameters
       * Returns estimated interest amount or null if cannot estimate
       */
      estimateInterest() {
      const loanAmount = parseNumber(document.getElementById('loanAmount').value);
        const monthlyRate = parseNumber(document.getElementById('monthlyRate').value);
        
        if (loanAmount <= 0 || monthlyRate <= 0) {
          return null;
        }
        
        // Get interest payment dates
        const interestDates = [];
        document.querySelectorAll('[name="interestDate"]').forEach(input => {
          const day = parseInt(toEnglish(input.value));
          if (day > 0) interestDates.push(day);
        });
        
        if (interestDates.length === 0) {
          return null;
        }
        
        // Get principal repayments
        const principalRepayments = [];
        document.querySelectorAll('[name="principalDay"]').forEach((dayInput, index) => {
          const day = parseInt(toEnglish(dayInput.value));
          const amount = parseNumber(document.querySelectorAll('[name="principalAmount"]')[index].value);
          if (day > 0 && amount > 0) {
            principalRepayments.push({ day, amount });
          }
        });
        
        // Sort by day
        principalRepayments.sort((a, b) => a.day - b.day);
        interestDates.sort((a, b) => a - b);
        
        const finalDay = Math.max(
          principalRepayments.length > 0 ? Math.max(...principalRepayments.map(pr => pr.day)) : 0,
          interestDates.length > 0 ? Math.max(...interestDates) : 0
        );
        
        if (finalDay <= 0) {
          return null;
        }
        
        // Calculate estimated interest (simple interest, non-compounding)
        const dailyRate = monthlyRate / 100 / 30;
        let remainingPrincipal = loanAmount;
        let totalAccruedInterest = 0;
        let principalIndex = 0;
        
        for (let day = 1; day <= finalDay; day++) {
          const dailyInterest = remainingPrincipal * dailyRate;
          totalAccruedInterest += dailyInterest;
          
          // Check for principal repayment
          if (principalIndex < principalRepayments.length && 
              principalRepayments[principalIndex].day === day) {
            remainingPrincipal -= principalRepayments[principalIndex].amount;
            principalIndex++;
          }
        }
        
        return totalAccruedInterest;
      },

      /**
       * Get real interest from backend calculation result
       * Returns interest amount or null if not available
       */
      getRealInterest() {
        if (!window.lastCalculationResult) {
          return null;
        }
        
        // Safely access summary with null checks
        const summary = window.lastCalculationResult.summary;
        if (!summary || typeof summary !== 'object') {
          return null;
        }
        
        const realInterest = summary.totalInterestPaid;
        if (typeof realInterest === 'number' && realInterest > 0) {
          return realInterest;
        }
        
        return null;
      },

      updateAll() {
      const loanAmount = parseNumber(document.getElementById('loanAmount').value);
        const feeConfig = FeeModule.getConfig();
        const guaranteeConfig = GuaranteeModule.getConfig();
        
        let feeAmount = 0;
        if (feeConfig) {
          if (feeConfig.mode === 'percentage') {
            feeAmount = loanAmount * (feeConfig.rate / 100);
          } else if (feeConfig.mode === 'fixed') {
            feeAmount = feeConfig.amount;
          }
        }
        
        let guaranteeAmount = 0;
        if (guaranteeConfig) {
          guaranteeAmount = loanAmount * (guaranteeConfig.rate / 100);
        }
        
        // Get real interest if available, otherwise try to estimate
        const realInterest = this.getRealInterest();
        const estimatedInterest = realInterest === null ? this.estimateInterest() : null;
        const interestAmount = realInterest !== null ? realInterest : (estimatedInterest !== null ? estimatedInterest : 0);
        const isInterestEstimated = realInterest === null && estimatedInterest !== null;
        const isInterestUnknown = realInterest === null && estimatedInterest === null;
        
        const baseValues = {
          interest: interestAmount,
          fees: feeAmount,
          guarantee: guaranteeAmount
        };
        
        let total = 0;
        document.querySelectorAll('#taxRows .row-item').forEach(row => {
      const baseSel = row.querySelector('[name="taxBase"]');
      const rateInput = row.querySelector('[name="taxRate"]');
      const amountEl = row.querySelector('.tax-amount');
          
      if (!baseSel || !rateInput || !amountEl) return;
          
      const base = baseSel.value;
      const rate = parseNumber(rateInput.value);
          
          // Handle interest base specially
          if (base === 'interest') {
            if (isInterestUnknown) {
              // Show placeholder when interest is completely unknown
              amountEl.textContent = 'Ø¨Ø³ØªÙ‡ Ø¨Ù‡ Ø³ÙˆØ¯ Ù†Ù‡Ø§ÛŒÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯';
              amountEl.className = 'font-bold text-slate-400 italic persian-number';
              return; // Don't add to total
            } else if (isInterestEstimated && rate > 0) {
              // Show estimated value
              const estimatedTax = estimatedInterest * (rate / 100);
              amountEl.textContent = `Ø­Ø¯ÙˆØ¯ÛŒ: ${formatToman(estimatedTax)}`;
              amountEl.className = 'font-bold text-amber-500 persian-number';
              total += estimatedTax; // Add estimated to total
              return;
            } else if (realInterest !== null && rate > 0) {
              // Show real value
              const taxAmount = realInterest * (rate / 100);
              amountEl.textContent = formatToman(taxAmount);
              amountEl.className = 'font-bold text-blue-700 persian-number';
              total += taxAmount;
              return;
            } else {
              // Rate is 0 or invalid
              amountEl.textContent = formatToman(0);
              amountEl.className = 'font-bold text-blue-700 persian-number';
              return;
            }
          }
          
          // Handle fees and guarantee (always known)
          let baseAmount = baseValues[base] || 0;
          const taxAmount = baseAmount * (rate / 100);
          amountEl.textContent = formatToman(taxAmount || 0);
          amountEl.className = 'font-bold text-blue-700 persian-number';
          total += taxAmount;
        });
        
      const totalBox = document.getElementById('totalTaxes');
      if (totalBox) {
          // Check if any tax is estimated
          const hasEstimatedTax = Array.from(document.querySelectorAll('#taxRows .row-item')).some(row => {
            const baseSel = row.querySelector('[name="taxBase"]');
            return baseSel && baseSel.value === 'interest' && isInterestEstimated;
          });
          
          if (total > 0 || hasEstimatedTax) {
            const totalClass = hasEstimatedTax ? 'text-amber-500' : 'text-blue-700';
        totalBox.innerHTML = `
          <div class="flex items-center justify-between">
                <span class="font-semibold">${hasEstimatedTax ? 'Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø§Ù„ÛŒØ§Øªâ€ŒÙ‡Ø§ (Ø­Ø¯ÙˆØ¯ÛŒ):' : 'Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø§Ù„ÛŒØ§Øªâ€ŒÙ‡Ø§:'}</span>
                <span class="text-lg font-bold ${totalClass} persian-number">${formatToman(total)}</span>
          </div>
        `;
          } else {
            totalBox.innerHTML = '';
          }
        }
      },

      getConfig() {
        if (!document.getElementById('taxModuleEnabled').checked) {
          return null;
        }
        
        const taxes = [];
        document.querySelectorAll('#taxRows .row-item').forEach(row => {
          const base = row.querySelector('[name="taxBase"]').value;
          const rate = parseNumber(row.querySelector('[name="taxRate"]').value);
          if (base && rate > 0) {
            taxes.push({ base, rate });
          }
        });
        
        return taxes.length > 0 ? taxes : null;
      },

      clear() {
        document.getElementById('taxModuleEnabled').checked = false;
        document.getElementById('taxRows').innerHTML = '';
        document.getElementById('totalTaxes').innerHTML = '';
        this.toggle();
      }
    };

    // ============================================================================
    // COST SCHEDULE MODULE
    // ============================================================================

    const CostScheduleModule = {
      toggle() {
        const isEnabled = document.getElementById('costScheduleModuleEnabled').checked;
        const content = document.getElementById('costScheduleModuleContent');
        if (isEnabled) {
          content.classList.remove('hidden');
          if (document.getElementById('costScheduleRows').children.length === 0) {
            this.addRow();
          }
        } else {
          content.classList.add('hidden');
        }
      },

      toggleAutoSplit() {
        const isEnabled = document.getElementById('autoCostScheduleMode').checked;
        const options = document.getElementById('autoCostScheduleOptions');
        if (isEnabled) {
          options.classList.remove('hidden');
        } else {
          options.classList.add('hidden');
        }
      },

      calculateAuto() {
        if (!document.getElementById('autoCostScheduleMode').checked) return;
        
        const method = document.getElementById('costSplitMethod').value;
        const rows = document.querySelectorAll('#costScheduleRows .row-item');
        
        if (rows.length === 0) {
          alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ÛŒ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯');
        return;
      }

        // Collect days and existing percentages
        const entries = [];
        let hasInvalidDay = false;
        
        rows.forEach(row => {
          const dayInput = row.querySelector('[name="costDay"]');
          const percentInput = row.querySelector('[name="costPercent"]');
        const day = parseInt(toEnglish(dayInput.value));
          const percent = parseNumber(percentInput.value);
          
          if (day <= 0) {
            hasInvalidDay = true;
            dayInput.classList.add('error');
          } else {
            dayInput.classList.remove('error');
          }
          
          entries.push({ day, percent });
        });
        
        if (hasInvalidDay) {
          alert('Ø±ÙˆØ² Ø¨Ø§ÛŒØ¯ Ø¨Ø²Ø±Ú¯â€ŒØªØ± Ø§Ø² ØµÙØ± Ø¨Ø§Ø´Ø¯');
          return;
        }
        
        // Calculate percentages based on method
        let percentages = [];
        const days = entries.map(e => e.day);
        
        if (method === 'equal') {
          percentages = AutoSplit.equalSplit(days);
        } else if (method === 'weighted') {
          percentages = AutoSplit.weightedSplit(days);
        } else if (method === 'normalize') {
          percentages = AutoSplit.normalizeSplit(entries);
        }
        
        // Apply to rows
        AutoSplit.applyToRows('#costScheduleRows', percentages, 'costDay', 'costPercent');
        
        // Update total display
        this.updateTotal();
      },

      addRow() {
        const container = document.getElementById('costScheduleRows');
        const div = document.createElement('div');
        div.className = 'row-item';
        div.innerHTML = `
          <div>
            <label class="label">Ø±ÙˆØ² Ù¾Ø±Ø¯Ø§Ø®Øª</label>
            <input type="text" name="costDay" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 30" 
                   oninput="this.value = formatInteger(this.value); CostScheduleModule.updateTotal()" />
            <div class="help-text">Ø±ÙˆØ² Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ² Ø§Ø² Ø´Ø±ÙˆØ¹ ÙˆØ§Ù… ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
          </div>
          <div>
            <label class="label">Ø³Ù‡Ù… Ø§Ø² Ú©Ù„ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ (%)</label>
            <input type="text" name="costPercent" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 100" 
                   oninput="this.value = formatDecimal(this.value); CostScheduleModule.updateTotal()" />
            <div class="help-text">Ø¯Ø±ØµØ¯ Ø³Ù‡Ù… Ø§ÛŒÙ† Ø±ÙˆØ² Ø§Ø² Ú©Ù„ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</div>
          </div>
          <button type="button" onclick="this.parentElement.remove(); CostScheduleModule.updateTotal()" class="remove-btn">Ã—</button>
        `;
        container.appendChild(div);
        this.updateTotal();
      },

      updateTotal() {
        const rows = document.querySelectorAll('[name="costPercent"]');
        let total = 0;
        rows.forEach(row => total += parseNumber(row.value));
        
        const display = document.getElementById('costScheduleTotal');
        const isValid = Math.abs(total - 100) < 0.01;
        
        display.innerHTML = `
          <div class="flex items-center justify-between">
            <span class="font-semibold">Ù…Ø¬Ù…ÙˆØ¹ Ø¯Ø±ØµØ¯Ù‡Ø§:</span>
            <span class="text-lg font-bold ${isValid ? 'text-green-600' : 'text-red-600'} persian-number">
              ${total.toFixed(2)}%
            </span>
          </div>
          ${isValid ? 
            '<p class="text-green-600 text-sm mt-2">âœ“ Ù…Ø¬Ù…ÙˆØ¹ Ø¯Ø±ØµØ¯Ù‡Ø§ Ø¨Ø±Ø§Ø¨Ø± Û±Û°Û°Ùª Ø§Ø³Øª</p>' : 
            '<p class="text-red-600 text-sm mt-2">âš  Ù…Ø¬Ù…ÙˆØ¹ Ø¯Ø±ØµØ¯Ù‡Ø§ Ø¨Ø§ÛŒØ¯ Ø¨Ø±Ø§Ø¨Ø± Û±Û°Û°Ùª Ø¨Ø§Ø´Ø¯</p>'}
        `;
      },

      getConfig() {
        if (!document.getElementById('costScheduleModuleEnabled').checked) {
          return null;
        }
        
        const schedule = [];
        document.querySelectorAll('[name="costDay"]').forEach((dayInput, index) => {
          const day = parseInt(toEnglish(dayInput.value));
          const percent = parseNumber(document.querySelectorAll('[name="costPercent"]')[index].value);
          if (day > 0 && percent >= 0) {
            schedule.push({ day, percent });
          }
        });
        
        return schedule.length > 0 ? schedule : null;
      },

      clear() {
        document.getElementById('costScheduleModuleEnabled').checked = false;
        document.getElementById('autoCostScheduleMode').checked = false;
        document.getElementById('costScheduleRows').innerHTML = '';
        document.getElementById('costScheduleTotal').innerHTML = '';
        this.toggle();
        this.toggleAutoSplit();
      }
    };

    // ============================================================================
    // RESULTS MODULE (Modernized & Optimized)
    // ============================================================================

    const ResultsModule = {
      // ============================================================================
      // HELPER FORMATTERS
      // ============================================================================
      helpers: {
        /**
         * Convert English digits to Persian
         */
        persianNumber(n) {
          if (typeof n !== 'number' && typeof n !== 'string') return 'Û°';
          const persian = ['Û°', 'Û±', 'Û²', 'Û³', 'Û´', 'Ûµ', 'Û¶', 'Û·', 'Û¸', 'Û¹'];
          return n.toString().replace(/\d/g, d => persian[parseInt(d)]);
        },

        /**
         * Format currency with Persian digits and commas
         * Returns: "Û±Û²Û³Ù¬Û´ÛµÛ¶ ØªÙˆÙ…Ø§Ù†"
         */
        formatCurrency(n) {
          const num = Number(n) || 0;
          const rounded = Math.round(num);
          const formatted = rounded.toLocaleString('en-US');
          return this.persianNumber(formatted) + ' ØªÙˆÙ…Ø§Ù†';
        },

        /**
         * Format percentage with Persian digits
         * Returns: "Û±Û°Ùª"
         */
        formatPercent(n) {
          const num = Number(n) || 0;
          return this.persianNumber(num.toFixed(2)) + 'Ùª';
        },

        /**
         * Format day number
         * Returns: "Ø±ÙˆØ² Û±Û²Û³"
         */
        formatDay(n) {
          const num = Number(n) || 0;
          return 'Ø±ÙˆØ² ' + this.persianNumber(num);
        }
      },

      // ============================================================================
      // MAIN DISPLAY FUNCTION
      // ============================================================================
      display(data) {
        try {
          // Defensive root logic - never throws
          if (!data || typeof data !== 'object') {
            console.warn('Invalid data structure in ResultsModule.display()', data);
            this.showNoResult();
            return;
          }

          // Safe fallback structure
          const safeSummary = {
            totalInterestPaid: data.summary?.totalInterestPaid ?? 0,
            totalPrincipal: data.summary?.totalPrincipal ?? 0,
            totalTaxes: data.modules?.taxes?.totalTaxes ?? 0,
            totalUpfrontFees: (data.modules?.fee?.feeAmount ?? 0) + (data.modules?.guarantee?.guaranteeAmount ?? 0),
            finalDay: data.summary?.finalDay ?? 0
          };

          const safeModules = {
            fee: data.modules?.fee ?? { feeAmount: 0 },
            guarantee: data.modules?.guarantee ?? { guaranteeAmount: 0 },
            taxes: data.modules?.taxes ?? { totalTaxes: 0, breakdown: [] },
            costSchedule: Array.isArray(data.modules?.costSchedule) ? data.modules.costSchedule : []
          };

          const safeSchedule = Array.isArray(data.schedule) ? data.schedule : [];

          // Check for no-result state
          const hasAnyData = safeSummary.totalInterestPaid > 0 || 
                           safeSummary.totalPrincipal > 0 || 
                           safeSummary.totalTaxes > 0 || 
                           safeSummary.totalUpfrontFees > 0 ||
                           safeSchedule.length > 0;

          if (!hasAnyData && !data.summary) {
            this.showNoResult();
            return;
          }

          // Render all sections
          this.renderSummary(safeSummary, data.summary);
          this.renderModules(safeModules);
          this.renderSchedule(safeSchedule);

          // Store result safely
          window.lastCalculationResult = data;

          // Update tax module with real interest values (if available)
          try {
            if (typeof TaxModule !== 'undefined' && TaxModule.updateAll) {
              TaxModule.updateAll();
            }
          } catch (e) {
            console.warn('Failed to update tax module:', e);
          }

          // Show results section
          const resultsEl = document.getElementById('results');
          if (resultsEl) {
            resultsEl.classList.remove('hidden');
            resultsEl.scrollIntoView({ behavior: 'smooth' });
          }

        } catch (error) {
          console.error('Error in ResultsModule.display():', error);
          this.showNoResult();
        }
      },

      // ============================================================================
      // SUMMARY SECTION RENDERING
      // ============================================================================
      renderSummary(summary, originalSummary) {
        const summaryCards = document.getElementById('summaryCards');
        if (!summaryCards) return;

        // Check if summary is completely missing
        if (!originalSummary || typeof originalSummary !== 'object') {
          summaryCards.innerHTML = `
            <div class="summary-card">
              <div class="text-center py-4 text-white opacity-90">
                <div class="text-lg font-semibold">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®Ù„Ø§ØµÙ‡ Ù‡Ù†ÙˆØ² Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>
              </div>
            </div>
          `;
          return;
        }

        // Render summary with all fields
        summaryCards.innerHTML = `
          <div class="summary-card">
            <div class="summary-item">
              <span class="summary-label">Ø¬Ù…Ø¹ Ú©Ù„ Ø³ÙˆØ¯ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ</span>
              <span class="summary-value persian-number">${this.helpers.formatCurrency(summary.totalInterestPaid)}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Ø¬Ù…Ø¹ Ú©Ù„ Ú©Ø§Ø±Ù…Ø²Ø¯Ù‡Ø§</span>
              <span class="summary-value persian-number">${this.helpers.formatCurrency(summary.totalUpfrontFees)}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Ø¬Ù…Ø¹ Ú©Ù„ Ù…Ø§Ù„ÛŒØ§Øªâ€ŒÙ‡Ø§</span>
              <span class="summary-value persian-number">${this.helpers.formatCurrency(summary.totalTaxes)}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Ù…Ø¬Ù…ÙˆØ¹ Ú©Ù„ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ ÛŒÚ©â€ŒØ¨Ø§Ø±Ù‡</span>
              <span class="summary-value persian-number">${this.helpers.formatCurrency(summary.totalUpfrontFees + summary.totalTaxes)}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Ø±ÙˆØ² Ù†Ù‡Ø§ÛŒÛŒ ØªØ³ÙˆÛŒÙ‡</span>
              <span class="summary-value persian-number">${summary.finalDay > 0 ? this.helpers.formatDay(summary.finalDay) : 'â€”'}</span>
            </div>
          </div>
        `;
      },

      // ============================================================================
      // MODULES DISPLAY RENDERING
      // ============================================================================
      renderModules(modules) {
        // This section can be extended to show module details
        // For now, modules are shown in summary section
        // Fee, guarantee, and taxes are already displayed in summary
        // Cost schedule is handled separately in renderSchedule
      },

      // ============================================================================
      // COST SCHEDULE SECTION (if needed in separate section)
      // ============================================================================
      renderCostSchedule(costSchedule) {
        if (!Array.isArray(costSchedule) || costSchedule.length === 0) {
          return '<div class="text-center py-4 text-slate-500">Ø¨Ø±Ø§ÛŒ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ ÛŒÚ©â€ŒØ¨Ø§Ø±Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ§ÛŒ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';
        }

        return costSchedule.map(item => {
          const day = Number(item.day || item.days || 0);
          const percent = Number(item.percent || item.share || 0);
          const amount = Number(item.amount || 0);

          return `
            <div class="p-4 bg-slate-50 rounded-lg mb-3">
              <div class="flex items-center justify-between">
                <span class="font-semibold">${this.helpers.formatDay(day)}</span>
                ${percent > 0 ? `<span class="text-blue-600 persian-number">${this.helpers.formatPercent(percent)}</span>` : ''}
              </div>
              ${amount > 0 ? `<div class="mt-2 text-sm text-slate-600 persian-number">Ù…Ø¨Ù„Øº: ${this.helpers.formatCurrency(amount)}</div>` : ''}
            </div>
          `;
        }).join('');
      },

      // ============================================================================
      // PAYMENT SCHEDULE TABLE RENDERING
      // ============================================================================
      renderSchedule(schedule) {
        const tbody = document.getElementById('scheduleBody');
        if (!tbody) return;

        // Handle empty schedule
        if (!Array.isArray(schedule) || schedule.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" class="text-center py-12 text-slate-500">
                <div class="text-xl font-semibold mb-3">Ù‡Ù†ÙˆØ² Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>
                <div class="text-base">Ø§Ø¨ØªØ¯Ø§ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯</div>
              </td>
            </tr>
          `;
          return;
        }

        // Filter payment days safely
        const paymentDays = schedule.filter(d => {
          if (!d || typeof d !== 'object') return false;
          const raw = d._raw || {};
          const principalPayment = Number(raw.principalPayment || 0);
          const interestPayment = Number(raw.interestPayment || 0);
          const costPayment = Number(raw.costPayment || 0);
          return (principalPayment > 0 || interestPayment > 0 || costPayment > 0);
        });

        // Get first and last day safely
        const firstDay = schedule[0] || null;
        const lastDay = schedule[schedule.length - 1] || null;

        // Build days to show with deduplication
        const daysToShow = [firstDay, ...paymentDays, lastDay]
          .filter(d => d !== null && d !== undefined && typeof d === 'object')
          .filter((d, i, arr) => {
            const dayNum = this.getDayNumber(d);
            return arr.findIndex(x => this.getDayNumber(x) === dayNum) === i;
          })
          .sort((a, b) => this.getDayNumber(a) - this.getDayNumber(b));

        // Render schedule rows
        tbody.innerHTML = daysToShow.map(day => this.renderScheduleRow(day)).join('');
      },

      /**
       * Extract day number from schedule entry
       */
      getDayNumber(day) {
        if (!day || typeof day !== 'object') return 0;
        const raw = day._raw || {};
        return Number(raw.day || day.Ø±ÙˆØ² || 0);
      },

      /**
       * Render a single schedule row
       */
      renderScheduleRow(day) {
        if (!day || typeof day !== 'object') return '';

        const raw = day._raw || {};
        const dayNum = Number(raw.day || day.Ø±ÙˆØ² || 0);
        const principalBefore = Number(raw.remainingPrincipalBefore || 0);
        const principalPayment = Number(raw.principalPayment || 0);
        const interestPayment = Number(raw.interestPayment || 0);
        const costPayment = Number(raw.costPayment || 0);
        const totalPayment = Number(raw.totalPayment || 0);
        const description = (typeof day.ØªÙˆØ¶ÛŒØ­Ø§Øª === 'string' && day.ØªÙˆØ¶ÛŒØ­Ø§Øª.trim()) ? day.ØªÙˆØ¶ÛŒØ­Ø§Øª : 'â€”';
        const isPayment = principalPayment > 0 || interestPayment > 0 || costPayment > 0;

        return `
          <tr class="${isPayment ? 'bg-blue-50' : ''}">
            <td class="font-semibold persian-number">${this.helpers.persianNumber(dayNum)}</td>
            <td class="persian-number">${this.helpers.formatCurrency(principalBefore)}</td>
            <td class="persian-number">${principalPayment > 0 ? `<span class="font-semibold text-green-600">${this.helpers.formatCurrency(principalPayment)}</span>` : '<span class="text-slate-400">-</span>'}</td>
            <td class="persian-number">${interestPayment > 0 ? `<span class="font-semibold text-orange-600">${this.helpers.formatCurrency(interestPayment)}</span>` : '<span class="text-slate-400">-</span>'}</td>
            <td class="persian-number">${costPayment > 0 ? `<span class="font-semibold text-amber-600">${this.helpers.formatCurrency(costPayment)}</span>` : '<span class="text-slate-400">-</span>'}</td>
            <td class="persian-number">${totalPayment > 0 ? `<span class="font-semibold text-blue-600">${this.helpers.formatCurrency(totalPayment)}</span>` : '<span class="text-slate-400">-</span>'}</td>
            <td class="text-sm text-slate-600">${description}</td>
          </tr>
        `;
      },

      /**
       * Show no-result state
       */
      showNoResult() {
        const summaryCards = document.getElementById('summaryCards');
        const tbody = document.getElementById('scheduleBody');

        if (summaryCards) {
          summaryCards.innerHTML = `
            <div class="summary-card">
              <div class="text-center py-8 text-white opacity-90">
                <div class="text-xl font-semibold mb-2">Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>
                <div class="text-base opacity-80">Ù„Ø·ÙØ§Ù‹ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯</div>
              </div>
            </div>
          `;
        }

        if (tbody) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" class="text-center py-12 text-slate-500">
                <div class="text-xl font-semibold mb-3">Ù‡Ù†ÙˆØ² Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>
                <div class="text-base">Ø§Ø¨ØªØ¯Ø§ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯</div>
              </td>
            </tr>
          `;
        }

        const resultsEl = document.getElementById('results');
        if (resultsEl) {
          resultsEl.classList.remove('hidden');
        }
      },

      copyJSON() {
        if (!window.lastCalculationResult) {
          alert('Ù‡ÛŒÚ† Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
          return;
        }
        
        const json = JSON.stringify(window.lastCalculationResult, null, 2);
        navigator.clipboard.writeText(json).then(() => {
          alert('Ù†ØªØ§ÛŒØ¬ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ú©Ù¾ÛŒ Ø´Ø¯');
        }).catch(() => {
          alert('Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† Ù†ØªØ§ÛŒØ¬');
        });
      },

      downloadJSON() {
        if (!window.lastCalculationResult) {
          alert('Ù‡ÛŒÚ† Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
          return;
        }
        
        const json = JSON.stringify(window.lastCalculationResult, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `loan-calculation-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
    };

    // ============================================================================
    // ERROR BANNER MANAGEMENT
    // ============================================================================

    const ErrorBanner = {
      getBanner() {
        let banner = document.getElementById('errorBanner');
        if (!banner) {
          banner = document.createElement('div');
          banner.id = 'errorBanner';
          banner.className = 'error-banner hidden';
          banner.innerHTML = `
            <div class="flex-1">
              <div class="font-semibold text-red-800" id="errorBannerMessage"></div>
            </div>
            <button type="button" class="error-banner-close" onclick="ErrorBanner.hide()">Ã—</button>
          `;
          document.body.appendChild(banner);
        }
        return banner;
      },

      show(message) {
        const banner = this.getBanner();
        const messageEl = document.getElementById('errorBannerMessage');
        if (messageEl) {
          messageEl.textContent = message;
        }
        banner.classList.remove('hidden');
        
        // Auto-hide after 10 seconds
        setTimeout(() => {
          this.hide();
        }, 10000);
      },

      hide() {
        const banner = document.getElementById('errorBanner');
        if (banner) {
          banner.classList.add('hidden');
        }
      }
    };

    // ============================================================================
    // FORM SUBMISSION
    // ============================================================================

    document.getElementById('calculatorForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // Hide any previous error banner
      ErrorBanner.hide();
      
      if (!LoanModule.validate()) return;
      if (!PrincipalModule.validate()) return;
      if (!InterestModule.validate()) return;
      
      const loanConfig = LoanModule.getConfig();
      const principalRepayments = PrincipalModule.getConfig();
      const interestPaymentDates = InterestModule.getConfig();
      
      const payload = {
        Loan: {
          amount: loanConfig.amount,
          monthlyInterestRate: loanConfig.monthlyInterestRate,
          principalRepayments: principalRepayments,
          interestPaymentDates: interestPaymentDates
        },
        Modules: {}
      };
      
      const feeConfig = FeeModule.getConfig();
      if (feeConfig) {
        payload.Modules.fee = feeConfig;
      }
      
      const guaranteeConfig = GuaranteeModule.getConfig();
      if (guaranteeConfig) {
        payload.Modules.guarantee = guaranteeConfig;
      }
      
      const taxConfig = TaxModule.getConfig();
      if (taxConfig) {
        payload.Modules.taxes = taxConfig;
      }
      
      const costScheduleConfig = CostScheduleModule.getConfig();
      if (costScheduleConfig) {
        payload.Modules.costSchedule = costScheduleConfig;
      }
      
      const submitBtn = document.getElementById('submitBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading"></span> Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡...';
      
      try {
        // Fetch with timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
        
        let response;
        try {
          response = await fetch('https://n8nb2wall.darkube.app/webhook/calculate', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
            signal: controller.signal
          });
        } catch (fetchError) {
          clearTimeout(timeoutId);
          if (fetchError.name === 'AbortError') {
            throw new Error('Timeout: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ Ø·ÙˆÙ„ Ú©Ø´ÛŒØ¯');
          }
          throw fetchError;
        }
        
        clearTimeout(timeoutId);
        
        // Handle HTTP errors
        if (!response.ok) {
          const errorText = await response.text().catch(() => '');
          console.error('HTTP Error:', response.status, errorText);
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        // Parse JSON response safely
        let data;
        try {
          const responseText = await response.text();
          if (!responseText || responseText.trim() === '') {
            throw new Error('Ù¾Ø§Ø³Ø® Ø®Ø§Ù„ÛŒ Ø§Ø² Ø³Ø±ÙˆØ± Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯');
          }
          data = JSON.parse(responseText);
        } catch (parseError) {
          console.error('JSON Parse Error:', parseError);
          throw new Error('Ù¾Ø§Ø³Ø® Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø² Ø³Ø±ÙˆØ± Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯');
        }
        
        // Validate response structure
        if (!data || typeof data !== 'object') {
          console.error('Invalid response structure:', data);
          throw new Error('Ø³Ø§Ø®ØªØ§Ø± Ù¾Ø§Ø³Ø® Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
        }
        
        // Handle backend errors (success: false)
        if (data.success === false) {
          const errorMessage = data.message || data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡';
          console.error('Backend Error:', errorMessage, data);
          throw new Error(errorMessage);
        }
        
        // Validate critical data exists (gracefully handle missing data)
        if (!data.schedule || !Array.isArray(data.schedule)) {
          console.warn('Missing or invalid schedule in response:', data);
          // Continue - ResultsModule.display() will handle empty schedule
        }
        
        if (!data.summary) {
          console.warn('Missing summary in response:', data);
          // Continue - ResultsModule.display() will handle null summary
        }
        
        // Display results (ResultsModule.display() handles all edge cases)
        ResultsModule.display(data);
        
      } catch (error) {
        // Log technical details to console only
        console.error('Calculation Error:', {
          error: error,
          message: error.message,
          stack: error.stack,
          payload: payload
        });
        
        // Show user-friendly error message
        const userMessage = 'Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯Ù‡. Ù„Ø·ÙØ§Ù‹ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.';
        ErrorBanner.show(userMessage);
        
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    });

    // ============================================================================
    // APP CONTROLLER (Single Global - Orchestrates all components)
    // ============================================================================

    class AppController {
      constructor() {
        this.components = {
          loanInput: new LoanInputComponent(),
          // Additional components will be added here:
          // principalSchedule: new PrincipalScheduleComponent(),
          // interestSchedule: new InterestScheduleComponent(),
          // feeModule: new FeeModuleComponent(),
          // guaranteeModule: new GuaranteeModuleComponent(),
          // taxModule: new TaxModuleComponent(),
          // costSchedule: new CostScheduleComponent(),
          // results: new ResultsComponent()
        };
        this.lastCalculationResult = null;
        this.init();
      }

      init() {
        // Render all components
        Object.values(this.components).forEach(component => {
          if (component && typeof component.render === 'function') {
            component.render();
          }
        });

        // Bind form submission
        const form = document.getElementById('calculatorForm');
        if (form) {
          form.addEventListener('submit', (e) => this.handleSubmit(e));
        }

        // Initialize legacy modules for backward compatibility
        if (typeof PrincipalModule !== 'undefined' && PrincipalModule.init) {
          PrincipalModule.init();
        }
        if (typeof InterestModule !== 'undefined' && InterestModule.init) {
          InterestModule.init();
        }
      }

      notifyLoanAmountChange() {
        // Notify dependent components when loan amount changes
        if (this.components.feeModule && typeof this.components.feeModule.updateDisplay === 'function') {
          this.components.feeModule.updateDisplay();
        }
        if (this.components.guaranteeModule && typeof this.components.guaranteeModule.updateDisplay === 'function') {
          this.components.guaranteeModule.updateDisplay();
        }
      }

      async handleSubmit(e) {
        e.preventDefault();
        
        // Validate using components
        if (!this.components.loanInput.validate()) return;
        if (typeof PrincipalModule !== 'undefined' && !PrincipalModule.validate()) return;
        if (typeof InterestModule !== 'undefined' && !InterestModule.validate()) return;
        
        // Collect data from components
        const loanConfig = this.components.loanInput.getData();
        const principalRepayments = typeof PrincipalModule !== 'undefined' ? PrincipalModule.getConfig() : [];
        const interestPaymentDates = typeof InterestModule !== 'undefined' ? InterestModule.getConfig() : [];
        
        const payload = {
          Loan: {
            amount: loanConfig.amount,
            monthlyInterestRate: loanConfig.monthlyInterestRate,
            principalRepayments: principalRepayments,
            interestPaymentDates: interestPaymentDates
          },
          Modules: {}
        };
        
        // Collect module configs (using legacy modules for now)
        if (typeof FeeModule !== 'undefined') {
          const feeConfig = FeeModule.getConfig();
          if (feeConfig) payload.Modules.fee = feeConfig;
        }
        
        if (typeof GuaranteeModule !== 'undefined') {
          const guaranteeConfig = GuaranteeModule.getConfig();
          if (guaranteeConfig) payload.Modules.guarantee = guaranteeConfig;
        }
        
        if (typeof TaxModule !== 'undefined') {
          const taxConfig = TaxModule.getConfig();
          if (taxConfig) payload.Modules.taxes = taxConfig;
        }
        
        if (typeof CostScheduleModule !== 'undefined') {
          const costScheduleConfig = CostScheduleModule.getConfig();
          if (costScheduleConfig) payload.Modules.costSchedule = costScheduleConfig;
        }
        
        // Submit to backend (using existing fetch logic)
        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="loading"></span> Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡...';
        
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 30000);
          
          let response;
          try {
            response = await fetch('https://n8nb2wall.darkube.app/webhook/calculate', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
              signal: controller.signal
            });
          } catch (fetchError) {
            clearTimeout(timeoutId);
            if (fetchError.name === 'AbortError') {
              throw new Error('Timeout: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ Ø·ÙˆÙ„ Ú©Ø´ÛŒØ¯');
            }
            throw fetchError;
          }
          
          clearTimeout(timeoutId);
          
          if (!response.ok) {
            const errorText = await response.text().catch(() => '');
            console.error('HTTP Error:', response.status, errorText);
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          let data;
          try {
            const responseText = await response.text();
            if (!responseText || responseText.trim() === '') {
              throw new Error('Ù¾Ø§Ø³Ø® Ø®Ø§Ù„ÛŒ Ø§Ø² Ø³Ø±ÙˆØ± Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯');
            }
            data = JSON.parse(responseText);
          } catch (parseError) {
            console.error('JSON Parse Error:', parseError);
            throw new Error('Ù¾Ø§Ø³Ø® Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø² Ø³Ø±ÙˆØ± Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯');
          }
          
          if (!data || typeof data !== 'object') {
            console.error('Invalid response structure:', data);
            throw new Error('Ø³Ø§Ø®ØªØ§Ø± Ù¾Ø§Ø³Ø® Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
          }
          
          if (data.success === false) {
            const errorMessage = data.message || data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡';
            console.error('Backend Error:', errorMessage, data);
            throw new Error(errorMessage);
          }
          
          // Display results
          if (typeof ResultsModule !== 'undefined') {
            ResultsModule.display(data);
          }
          
        } catch (error) {
          console.error('Calculation Error:', {
            error: error,
            message: error.message,
            stack: error.stack,
            payload: payload
          });
          
          const userMessage = 'Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯Ù‡. Ù„Ø·ÙØ§Ù‹ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.';
          if (typeof ErrorBanner !== 'undefined') {
            ErrorBanner.show(userMessage);
          } else {
            alert(userMessage);
          }
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      }

      reset() {
        // Reset all components
        Object.values(this.components).forEach(component => {
          if (component && typeof component.reset === 'function') {
            component.reset();
          }
        });
        
        // Reset legacy modules
        if (typeof PrincipalModule !== 'undefined' && PrincipalModule.init) {
          PrincipalModule.init();
        }
        if (typeof InterestModule !== 'undefined' && InterestModule.init) {
          InterestModule.init();
        }
        if (typeof FeeModule !== 'undefined' && FeeModule.clear) {
          FeeModule.clear();
        }
        if (typeof GuaranteeModule !== 'undefined' && GuaranteeModule.clear) {
          GuaranteeModule.clear();
        }
        if (typeof TaxModule !== 'undefined' && TaxModule.clear) {
          TaxModule.clear();
        }
        if (typeof CostScheduleModule !== 'undefined' && CostScheduleModule.clear) {
          CostScheduleModule.clear();
        }
        
        // Reset form
        const form = document.getElementById('calculatorForm');
        if (form) form.reset();
        
        const resultsEl = document.getElementById('results');
        if (resultsEl) resultsEl.classList.add('hidden');
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }

    // ============================================================================
    // INITIALIZATION
    // ============================================================================

    function resetForm() {
      if (window.appController) {
        window.appController.reset();
      } else {
        // Fallback to legacy reset
        document.getElementById('calculatorForm').reset();
        document.getElementById('loanAmountDisplay').textContent = '';
        document.getElementById('totalPrincipal').innerHTML = '';
        document.getElementById('results').classList.add('hidden');
        
        if (typeof PrincipalModule !== 'undefined' && PrincipalModule.init) {
          PrincipalModule.init();
        }
        if (typeof InterestModule !== 'undefined' && InterestModule.init) {
          InterestModule.init();
        }
        if (typeof FeeModule !== 'undefined' && FeeModule.clear) {
          FeeModule.clear();
        }
        if (typeof GuaranteeModule !== 'undefined' && GuaranteeModule.clear) {
          GuaranteeModule.clear();
        }
        if (typeof TaxModule !== 'undefined' && TaxModule.clear) {
          TaxModule.clear();
        }
        if (typeof CostScheduleModule !== 'undefined' && CostScheduleModule.clear) {
          CostScheduleModule.clear();
        }
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }

    // Initialize AppController as the single global
    document.addEventListener('DOMContentLoaded', function() {
      window.appController = new AppController();
    });
  </script>
</body>
</html>
