
<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ویترین پروژه‌ها</title>
  <meta name="description" content="نمایش پروژه‌ها با دریافت مستقیم از Google Sheets (بدون نیاز به ویرایش فایل JSON)">
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family:'Vazirmatn',system-ui,-apple-system,"Segoe UI",Roboto,"Noto Naskh Arabic",sans-serif}
    .badge{font-size:12px; font-weight:700; padding:.25rem .5rem; border-radius:9999px; border:1px solid}
    .badge-open{background:#eff6ff; color:#1d4ed8; border-color:#bfdbfe}
    .badge-completed{background:#ecfdf5; color:#047857; border-color:#a7f3d0}
    .badge-coming_soon{background:#fffbeb; color:#b45309; border-color:#fde68a}
    .skeleton{background:linear-gradient(90deg,#e5e7eb,#f3f4f6,#e5e7eb); background-size:200% 100%; animation:shimmer 1.2s infinite linear}
    @keyframes shimmer{from{background-position:200% 0}to{background-position:-200% 0}}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="max-w-6xl mx-auto px-4 py-6">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <h1 class="text-2xl md:text-3xl font-bold">ویترین پروژه‌ها</h1>
      <span class="px-2 py-0.5 rounded-full text-xs bg-emerald-50 text-emerald-700 border border-emerald-200">منبع: Google Sheets</span>
    </div>

    <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-3">
      <div class="flex items-center gap-2 text-sm">
        <span class="px-2 py-0.5 rounded-full text-xs bg-slate-100 text-slate-700 border border-slate-200">مجموع: <b id="count" class="mx-1">۰</b> پروژه</span>
      </div>
      <div class="sm:col-span-2 flex flex-wrap items-center justify-end gap-2">
        <input id="q" type="search" placeholder="جستجو در عنوان..." class="px-3 py-2 rounded-xl border border-slate-300 w-full sm:w-64">
        <select id="filter-status" class="px-3 py-2 rounded-xl border border-slate-300">
          <option value="all">همه وضعیت‌ها</option>
          <option value="open">در حال جذب</option>
          <option value="completed">تکمیل شده</option>
          <option value="coming_soon">به‌زودی</option>
        </select>
        <select id="sort-by" class="px-3 py-2 rounded-xl border border-slate-300">
          <option value="id_desc">مرتب‌سازی: جدیدترین</option>
          <option value="id_asc">قدیمی‌تر</option>
          <option value="raised_desc">تأمین‌شده (زیاد → کم)</option>
          <option value="raised_asc">تأمین‌شده (کم → زیاد)</option>
        </select>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-24">
    <div id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
      <!-- skeletons -->
      <div class="rounded-2xl border border-slate-200 bg-white overflow-hidden">
        <div class="h-40 skeleton"></div>
        <div class="p-3 space-y-2">
          <div class="h-5 w-3/4 skeleton rounded"></div>
          <div class="h-4 w-1/2 skeleton rounded"></div>
          <div class="h-3 w-full skeleton rounded"></div>
        </div>
      </div>
      <div class="rounded-2xl border border-slate-200 bg-white overflow-hidden">
        <div class="h-40 skeleton"></div>
        <div class="p-3 space-y-2">
          <div class="h-5 w-3/4 skeleton rounded"></div>
          <div class="h-4 w-1/2 skeleton rounded"></div>
          <div class="h-3 w-full skeleton rounded"></div>
        </div>
      </div>
      <div class="rounded-2xl border border-slate-200 bg-white overflow-hidden">
        <div class="h-40 skeleton"></div>
        <div class="p-3 space-y-2">
          <div class="h-5 w-3/4 skeleton rounded"></div>
          <div class="h-4 w-1/2 skeleton rounded"></div>
          <div class="h-3 w-full skeleton rounded"></div>
        </div>
      </div>
    </div>

    <p id="empty" class="hidden mt-8 text-center text-slate-500">موردی یافت نشد.</p>
  </main>

  <footer class="max-w-6xl mx-auto px-4 pb-8 text-xs text-slate-400">
    <p>این صفحه داده‌ها را مستقیماً از Google Sheets می‌خواند. اگر API در دسترس نبود، می‌توانید به صورت موقت از <code>data.json</code> استفاده کنید.</p>
  </footer>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyr5xE9Zt9L5P4_JrZ84pGUmDBAQPt6S06zDCxSmLKVxOLjr6NktDhK65rTzsF4oxM/exec";
    const fa = new Intl.NumberFormat('fa-IR');
    const fmt = n => n==null ? '—' : fa.format(n);

    const state = { items: [], filter: { q:'', status:'all', sort:'id_desc' } };

    function badge(status) {
      if (status === 'completed') return '<span class="badge badge-completed">تکمیل شده</span>';
      if (status === 'coming_soon') return '<span class="badge badge-coming_soon">به‌زودی</span>';
      return '<span class="badge badge-open">در حال جذب</span>';
    }

    function progress(raised, required) {
      if (!required || required <= 0) return 0;
      const p = Math.max(0, Math.min(100, Math.round((raised||0) * 100 / required)));
      return p;
    }

    function card(p) {
      const img = p.image ? `<img src="${p.image}" alt="" loading="lazy" class="w-full h-40 object-cover">` : `<div class="w-full h-40 bg-slate-100"></div>`;
      const pct = (typeof p.expected_profit_pct === 'number') ? (p.expected_profit_pct>1?p.expected_profit_pct:p.expected_profit_pct*100) : null;
      const prg = progress(p.capital_raised, p.capital_required);
      const owner = p.owner && p.owner.name ? `<span class="text-xs text-slate-500">مالک: ${p.owner.name}</span>` : '';
      return `
        <div class="rounded-2xl border border-slate-200 bg-white overflow-hidden hover:shadow-md transition">
          ${img}
          <div class="p-3 space-y-2">
            <div class="flex items-center justify-between gap-2">
              <h3 class="font-bold line-clamp-1">${p.title || '—'}</h3>
              <div>${badge(p.status)}</div>
            </div>
            <div class="text-sm text-slate-600 grid grid-cols-2 gap-x-3">
              <div>موردنیاز: <b class="text-slate-800">${fmt(p.capital_required)}</b></div>
              <div>تأمین‌شده: <b class="text-slate-800">${fmt(p.capital_raised)}</b></div>
              <div>مدت: <b class="text-slate-800">${p.tenor_months ?? '—'}</b> ماه</div>
              <div>سود: <b class="text-slate-800">${pct!=null?('%'+(+pct.toFixed(2))):'—'}</b></div>
            </div>
            <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
              <div class="h-full bg-blue-600" style="width: ${prg}%"></div>
            </div>
            ${owner}
          </div>
        </div>`;
    }

    function applyFilterSort(items) {
      const {q,status,sort} = state.filter;
      let list = items;
      if (q) list = list.filter(p => (p.title||'').includes(q));
      if (status !== 'all') list = list.filter(p => (p.status||'') === status);
      if (sort === 'id_desc') list = list.slice().sort((a,b) => (b.id||0) - (a.id||0));
      else if (sort === 'id_asc') list = list.slice().sort((a,b) => (a.id||0) - (b.id||0));
      else if (sort === 'raised_desc') list = list.slice().sort((a,b)=> (b.capital_raised||0)-(a.capital_raised||0));
      else if (sort === 'raised_asc') list = list.slice().sort((a,b)=> (a.capital_raised||0)-(b.capital_raised||0));
      return list;
    }

    function render() {
      const grid = document.getElementById('grid');
      const empty = document.getElementById('empty');
      const list = applyFilterSort(state.items);
      document.getElementById('count').textContent = state.items.length.toLocaleString('fa-IR');
      if (!list.length) {
        grid.innerHTML = '';
        empty.classList.remove('hidden');
        return;
      }
      empty.classList.add('hidden');
      grid.innerHTML = list.map(card).join('');
    }

    async function loadFromAPI() {
      const res = await fetch(API_URL + '?action=list', { cache:'no-store' });
      const data = await res.json();
      return Array.isArray(data) ? data : (data.projects || []);
    }

    async function loadData() {
      try {
        const data = await loadFromAPI();
        return data;
      } catch (e) {
        console.warn('API error, fallback to data.json', e);
        try {
          const res = await fetch('data.json?v=' + Date.now(), {cache:'no-store'});
          return res.json();
        } catch (e2) {
          return [];
        }
      }
    }

    document.getElementById('q').addEventListener('input', e=>{ state.filter.q = e.target.value.trim(); render(); });
    document.getElementById('filter-status').addEventListener('change', e=>{ state.filter.status = e.target.value; render(); });
    document.getElementById('sort-by').addEventListener('change', e=>{ state.filter.sort = e.target.value; render(); });

    (async ()=>{
      state.items = await loadData();
      render();
    })();
  </script>
</body>
</html>
