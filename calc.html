<!DOCTYPE html>

<html lang="fa" dir="rtl">

<head>

    <meta charset="UTF-8">

    <title>B2Wall – ماشین حساب سرمایه‌گذاری</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">

    

    <style>

        body {

            font-family: sans-serif;

            background: #f6f6f6;

            padding: 30px;

        }

        .container {

            max-width: 700px;

            background: #fff;

            padding: 25px;

            border-radius: 12px;

            margin: 0 auto;

            box-shadow: 0 10px 30px rgba(0,0,0,0.07);

        }

        .hidden { display:none; }

        .loading { color: #777; margin-top: 10px; }

        .result-box {

            background: #f0f0f0;

            padding: 15px;

            border-radius: 10px;

            margin-top: 20px;

        }

    </style>

</head>



<body>

<div class="container">



    <h2>ماشین حساب سرمایه‌گذاری</h2>



    <!-- فرم ورودی -->

    <div id="form-section">

        <label>نام مشتری:</label>

        <input id="name" type="text"><br><br>



        <label>شماره تماس:</label>

        <input id="phone" type="text"><br><br>



        <button id="calculate-btn">محاسبه</button>



        <div id="calc-status" class="loading"></div>

    </div>



    <!-- نمایش نتیجه -->

    <div id="result-section" class="hidden">

        <h3>نتیجه محاسبه</h3>

        <div id="summary-box" class="result-box"></div>



        <h4>لینک اشتراک‌گذاری</h4>

        <div id="share-box" class="result-box"></div>

    </div>



</div>



<script>



// =========================

// ابزارهای کاربردی

// =========================



function getQueryParam(key) {

    const params = new URLSearchParams(window.location.search);

    return params.get(key);

}



// =========================

// حالت ۱ – لود نتیجه با shareId

// =========================



async function loadSharedCalculation(shareId) {

    document.getElementById("form-section").classList.add("hidden");

    document.getElementById("result-section").classList.remove("hidden");



    const summaryBox = document.getElementById("summary-box");

    summaryBox.innerHTML = "<p class='loading'>در حال دریافت اطلاعات...</p>";



    try {

        const res = await fetch(

            "https://n8nb2wall.darkube.app/webhook/WF-GetCalculationById?shareId=" + shareId

        );

        const data = await res.json();



        if (!data.success || !data.record) {

            summaryBox.innerHTML = "<p>هیچ نتیجه‌ای برای این لینک پیدا نشد.</p>";

            return;

        }



        const result = data.record.result_payload;



        summaryBox.innerHTML = `

            <p>مجموع کل پرداخت‌ها: <b>${result.summary.totalPaymentsSum.toLocaleString()}</b></p>

            <p>تعداد اقساط: <b>${result.summary.numberOfPayments}</b></p>

            <p>آخرین روز: <b>${result.summary.finalDay}</b></p>

        `;



        document.getElementById("share-box").innerHTML = `

            <p>این لینک را می‌توانید با دیگران به اشتراک بگذارید:</p>

            <a href="https://b2wall.darkube.app/calc.html?shareId=${shareId}">

                https://b2wall.darkube.app/calc.html?shareId=${shareId}

            </a>

        `;



    } catch (err) {

        summaryBox.innerHTML = "<p>خطا در دریافت اطلاعات.</p>";

        console.error(err);

    }

}



// =========================

// حالت ۲ – ارسال محاسبه جدید

// =========================



document.getElementById("calculate-btn").addEventListener("click", async () => {

    const name = document.getElementById("name").value.trim();

    const phone = document.getElementById("phone").value.trim();

    const status = document.getElementById("calc-status");



    if (!name || !phone) {

        alert("لطفاً نام و شماره تماس را وارد کنید.");

        return;

    }



    status.innerHTML = "در حال محاسبه...";

    

    try {

        const res = await fetch("https://n8nb2wall.darkube.app/webhook/save-calculation", {

            method: "POST",

            headers: { "Content-Type": "application/json" },

            body: JSON.stringify({

                customer_name: name,

                customer_phone: phone,

                input_payload: window.currentInputs || {},

                result_payload: window.currentResults || {}

            })

        });



        const data = await res.json();



        document.getElementById("form-section").classList.add("hidden");

        document.getElementById("result-section").classList.remove("hidden");



        document.getElementById("summary-box").innerHTML =

            "<p>محاسبه ذخیره شد.</p>";



        document.getElementById("share-box").innerHTML = `

            <p>لینک اشتراک‌گذاری:</p>

            <a href="${data.share_url}">${data.share_url}</a>

        `;



    } catch (err) {

        status.innerHTML = "خطای ارتباط با سرور.";

        console.error(err);

    }

});



// =========================

// اجرای اولیه پس از لود صفحه

// =========================



window.addEventListener("DOMContentLoaded", () => {

    const shareId = getQueryParam("shareId");

    if (shareId) {

        loadSharedCalculation(shareId);

    }

});



</script>



</body>

</html>

