<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>محاسبه‌گر هوشمند تأمین مالی | B2Wall</title>
<script src="clarity-tracker.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<style>
body{ font-family:'Vazirmatn',system-ui; background:#f8fafc }
.card{ background:#fff; border:1px solid #e5e7eb; border-radius:1.25rem; box-shadow:0 4px 16px rgba(0,0,0,.04) }
.input-clean{ width:100%; padding:.875rem 1rem; border:2px solid #e2e8f0; border-radius:.875rem; font-size:1.125rem; font-weight:600; transition:all .2s }
.input-clean:focus{ outline:none; border-color:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,.1) }
.btn{ display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.875rem 1.5rem; border-radius:.875rem; font-weight:700; transition:all .2s; cursor:pointer }
.btn-primary{ background:#2563eb; color:#fff; box-shadow:0 4px 12px rgba(37,99,235,.3) }
.btn-primary:hover{ background:#1d4ed8; transform:translateY(-1px); box-shadow:0 6px 16px rgba(37,99,235,.4) }
.btn-secondary{ background:#f1f5f9; color:#334155; border:2px solid #e2e8f0 }
.btn-secondary:hover{ background:#e2e8f0 }
.badge{ display:inline-flex; align-items:center; gap:.375rem; padding:.25rem .625rem; border-radius:9999px; font-size:.75rem; font-weight:600 }
.badge-green{ background:#dcfce7; color:#166534 }
.badge-blue{ background:#dbeafe; color:#1e40af }
.badge-purple{ background:#f3e8ff; color:#6b21a8 }
.plan-card{ position:relative; padding:1.5rem; border-radius:1rem; border:2px solid #e5e7eb; transition:all .2s; cursor:pointer }
.plan-card:hover{ border-color:#2563eb; box-shadow:0 8px 24px rgba(37,99,235,.15) }
.plan-card.selected{ border-color:#2563eb; background:#eff6ff }
.plan-card .check{ position:absolute; top:1rem; left:1rem; width:24px; height:24px; border-radius:50%; border:2px solid #cbd5e1; background:#fff; opacity:0; transition:all .2s }
.plan-card.selected .check{ opacity:1; border-color:#2563eb; background:#2563eb }
.plan-card.selected .check::after{ content:'✓'; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#fff; font-size:.75rem; font-weight:700 }
.shimmer{ background:linear-gradient(90deg,#f1f5f9 25%,#e2e8f0 50%,#f1f5f9 75%); background-size:200% 100%; animation:shimmer 1.5s infinite }
@keyframes shimmer{ 0%{background-position:200% 0} 100%{background-position:-200% 0} }
.comparison-table{ width:100%; border-collapse:separate; border-spacing:0 .5rem }
.comparison-table th{ padding:.75rem 1rem; text-align:right; font-size:.8rem; color:#64748b; font-weight:600 }
.comparison-table td{ padding:1rem; background:#fff; border-top:1px solid #f1f5f9; border-bottom:1px solid #f1f5f9; font-weight:600 }
.comparison-table td:first-child{ border-right:1px solid #f1f5f9; border-radius:0 .75rem .75rem 0 }
.comparison-table td:last-child{ border-left:1px solid #f1f5f9; border-radius:.75rem 0 0 .75rem }
.chart-bar{ height:8px; background:#2563eb; border-radius:9999px; transition:width .5s ease }
</style>
</head>
<body class="bg-slate-50">

<!-- Header -->
<header class="bg-white border-b border-slate-200">
<div class="max-w-5xl mx-auto px-4 py-5 flex items-center justify-between">
<div>
<h1 class="text-xl font-bold text-slate-900">محاسبه‌گر هوشمند تأمین مالی</h1>
<p class="text-sm text-slate-600 mt-1">بهترین گزینه رو با یک کلیک پیدا کن</p>
</div>
<a href="index.html" class="text-sm text-blue-600 hover:text-blue-700 font-semibold">← بازگشت</a>
</div>
</header>

<main class="max-w-5xl mx-auto px-4 py-8">

<!-- Step 1: Input Form -->
<section id="inputSection" class="card p-6 mb-6">
<div class="flex items-center gap-3 mb-6">
<div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
<span class="text-blue-600 font-bold text-lg">۱</span>
</div>
<div>
<h2 class="text-lg font-bold text-slate-900">شرایط خودت رو وارد کن</h2>
<p class="text-sm text-slate-600">فقط ۳ مورد ساده، بقیه‌ش با ماست</p>
</div>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
<div>
<label class="block text-sm font-semibold text-slate-700 mb-2">مبلغ موردنیاز (میلیون تومان)</label>
<input 
  type="text" 
  id="amount" 
  class="input-clean" 
  placeholder="مثلاً ۵۰۰"
  value="500"
/>
</div>
<div>
<label class="block text-sm font-semibold text-slate-700 mb-2">مدت بازپرداخت (ماه)</label>
<select id="duration" class="input-clean">
<option value="12">۱۲ ماه (۱ سال)</option>
<option value="24" selected>۲۴ ماه (۲ سال)</option>
<option value="36">۳۶ ماه (۳ سال)</option>
<option value="48">۴۸ ماه (۴ سال)</option>
<option value="60">۶۰ ماه (۵ سال)</option>
</select>
</div>
<div>
<label class="block text-sm font-semibold text-slate-700 mb-2">درآمد ماهانه (میلیون تومان)</label>
<input 
  type="text" 
  id="income" 
  class="input-clean" 
  placeholder="مثلاً ۲۰"
  value="20"
/>
</div>
</div>

<button id="calculateBtn" class="btn btn-primary w-full md:w-auto">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
</svg>
محاسبه بهترین گزینه‌ها
</button>
</section>

<!-- Step 2: Loading -->
<section id="loadingSection" class="hidden card p-8 mb-6">
<div class="text-center">
<div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
<h3 class="text-lg font-bold text-slate-900 mb-2">در حال بررسی گزینه‌ها...</h3>
<p class="text-sm text-slate-600">لحظه‌ای صبر کن، داریم بهترین پیشنهادها رو پیدا می‌کنیم</p>
</div>
</section>

<!-- Step 3: Results -->
<section id="resultsSection" class="hidden">
<!-- Quick Stats -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
<div class="card p-4">
<div class="flex items-center justify-between">
<div>
<p class="text-xs text-slate-600 font-semibold mb-1">کمترین قسط ماهانه</p>
<p class="text-2xl font-bold text-slate-900" id="statMinInstallment">-</p>
</div>
<div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center">
<svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
</svg>
</div>
</div>
</div>
<div class="card p-4">
<div class="flex items-center justify-between">
<div>
<p class="text-xs text-slate-600 font-semibold mb-1">کمترین هزینه کل</p>
<p class="text-2xl font-bold text-slate-900" id="statMinTotal">-</p>
</div>
<div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
<svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
</svg>
</div>
</div>
</div>
<div class="card p-4">
<div class="flex items-center justify-between">
<div>
<p class="text-xs text-slate-600 font-semibold mb-1">تعداد گزینه‌های مناسب</p>
<p class="text-2xl font-bold text-slate-900" id="statCount">-</p>
</div>
<div class="w-12 h-12 rounded-full bg-purple-100 flex items-center justify-center">
<svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
</svg>
</div>
</div>
</div>
</div>

<!-- Plans Grid -->
<div class="mb-6">
<div class="flex items-center justify-between mb-4">
<h2 class="text-lg font-bold text-slate-900">گزینه‌های پیشنهادی</h2>
<button id="compareBtn" class="btn btn-secondary text-sm" disabled>
مقایسه انتخاب‌شده‌ها (<span id="compareCount">0</span>)
</button>
</div>
<div id="plansGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
<!-- Plans will be inserted here -->
</div>
</div>

<!-- Comparison Modal -->
<div id="comparisonModal" class="hidden card p-6">
<div class="flex items-center justify-between mb-6">
<h3 class="text-xl font-bold text-slate-900">مقایسه گزینه‌ها</h3>
<button id="closeComparison" class="text-slate-400 hover:text-slate-600">
<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
</svg>
</button>
</div>
<div id="comparisonContent" class="overflow-x-auto">
<!-- Comparison table will be inserted here -->
</div>
</div>

</section>

</main>

<script type="module">
// Configuration
const N8N_CALCULATE_URL = 'https://n8nb2wall.darkube.app/webhook/calculate-financing';

// Utilities
const $ = (s) => document.querySelector(s);
const $$ = (s) => Array.from(document.querySelectorAll(s));
const fa2en = (s) => String(s).replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d));
const en2fa = (s) => String(s).replace(/[0-9]/g, d => '۰۱۲۳۴۵۶۷۸۹'[d]);
const formatNumber = (n) => en2fa(Number(n).toLocaleString('fa-IR'));

let allPlans = [];
let selectedPlans = new Set();

// Calculate Handler
$('#calculateBtn').addEventListener('click', async () => {
  const amount = Number(fa2en($('#amount').value));
  const duration = Number($('#duration').value);
  const income = Number(fa2en($('#income').value));

  if (!amount || !duration || !income) {
    alert('لطفاً همه فیلدها رو پر کن');
    return;
  }

  // Show loading
  $('#inputSection').classList.add('hidden');
  $('#loadingSection').classList.remove('hidden');

  try {
    const response = await fetch(N8N_CALCULATE_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ amount, duration, income })
    });

    if (!response.ok) {
      throw new Error('خطا در دریافت اطلاعات');
    }

    const data = await response.json();
    allPlans = data.plans || [];

    // Show results
    $('#loadingSection').classList.add('hidden');
    $('#resultsSection').classList.remove('hidden');
    
    renderResults(allPlans);
  } catch (error) {
    console.error('Error:', error);
    $('#loadingSection').classList.add('hidden');
    $('#inputSection').classList.remove('hidden');
    alert('خطا در محاسبه. لطفاً دوباره تلاش کن.');
  }
});

// Render Results
function renderResults(plans) {
  // Update stats
  const minInstallment = Math.min(...plans.map(p => p.monthly_installment));
  const minTotal = Math.min(...plans.map(p => p.total_payment));
  
  $('#statMinInstallment').textContent = formatNumber(minInstallment) + ' تومان';
  $('#statMinTotal').textContent = formatNumber(minTotal) + ' تومان';
  $('#statCount').textContent = en2fa(plans.length);

  // Render plans
  const grid = $('#plansGrid');
  grid.innerHTML = plans.map((plan, idx) => `
    <div class="plan-card" data-plan-id="${plan.id}" onclick="togglePlan('${plan.id}')">
      <div class="check"></div>
      
      ${plan.recommended ? '<span class="badge badge-green mb-3">پیشنهاد ما ✨</span>' : ''}
      
      <div class="flex items-start justify-between mb-3">
        <div>
          <h3 class="text-lg font-bold text-slate-900">${plan.provider}</h3>
          <p class="text-sm text-slate-600">${plan.plan_name}</p>
        </div>
        <span class="badge badge-blue">${en2fa(plan.interest_rate)}٪ سود</span>
      </div>

      <div class="space-y-2 mb-4">
        <div class="flex justify-between items-center">
          <span class="text-sm text-slate-600">قسط ماهانه</span>
          <span class="text-lg font-bold text-slate-900">${formatNumber(plan.monthly_installment)} تومان</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-sm text-slate-600">مجموع پرداختی</span>
          <span class="text-base font-semibold text-slate-700">${formatNumber(plan.total_payment)} تومان</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-sm text-slate-600">سود کل</span>
          <span class="text-base font-semibold text-orange-600">${formatNumber(plan.total_interest)} تومان</span>
        </div>
      </div>

      <div class="pt-3 border-t border-slate-100">
        <div class="flex items-center gap-2 text-xs text-slate-600">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <span>${plan.approval_time}</span>
        </div>
      </div>
    </div>
  `).join('');
}

// Toggle Plan Selection
window.togglePlan = function(planId) {
  const card = $(`.plan-card[data-plan-id="${planId}"]`);
  card.classList.toggle('selected');
  
  if (selectedPlans.has(planId)) {
    selectedPlans.delete(planId);
  } else {
    selectedPlans.add(planId);
  }
  
  updateCompareButton();
};

// Update Compare Button
function updateCompareButton() {
  const count = selectedPlans.size;
  $('#compareCount').textContent = en2fa(count);
  $('#compareBtn').disabled = count < 2;
  $('#compareBtn').classList.toggle('opacity-50', count < 2);
}

// Show Comparison
$('#compareBtn').addEventListener('click', () => {
  const selected = allPlans.filter(p => selectedPlans.has(p.id));
  
  const html = `
    <table class="comparison-table">
      <thead>
        <tr>
          <th>ویژگی</th>
          ${selected.map(p => `<th class="text-center">${p.provider}<br><span class="text-xs font-normal">${p.plan_name}</span></th>`).join('')}
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="font-semibold">قسط ماهانه</td>
          ${selected.map(p => `<td class="text-center">${formatNumber(p.monthly_installment)} تومان</td>`).join('')}
        </tr>
        <tr>
          <td class="font-semibold">نرخ سود</td>
          ${selected.map(p => `<td class="text-center">${en2fa(p.interest_rate)}٪</td>`).join('')}
        </tr>
        <tr>
          <td class="font-semibold">مجموع پرداختی</td>
          ${selected.map(p => `<td class="text-center">${formatNumber(p.total_payment)} تومان</td>`).join('')}
        </tr>
        <tr>
          <td class="font-semibold">سود کل</td>
          ${selected.map(p => `<td class="text-center text-orange-600">${formatNumber(p.total_interest)} تومان</td>`).join('')}
        </tr>
        <tr>
          <td class="font-semibold">زمان تایید</td>
          ${selected.map(p => `<td class="text-center">${p.approval_time}</td>`).join('')}
        </tr>
        <tr>
          <td class="font-semibold">ضمانت</td>
          ${selected.map(p => `<td class="text-center text-sm">${p.collateral_required}</td>`).join('')}
        </tr>
      </tbody>
    </table>
  `;
  
  $('#comparisonContent').innerHTML = html;
  $('#comparisonModal').classList.remove('hidden');
});

$('#closeComparison').addEventListener('click', () => {
  $('#comparisonModal').classList.add('hidden');
});

// Input formatters
$('#amount').addEventListener('blur', (e) => {
  const val = fa2en(e.target.value).replace(/[^0-9]/g, '');
  e.target.value = val ? formatNumber(val) : '';
});

$('#income').addEventListener('blur', (e) => {
  const val = fa2en(e.target.value).replace(/[^0-9]/g, '');
  e.target.value = val ? formatNumber(val) : '';
});
</script>

</body>
</html>
