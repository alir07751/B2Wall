<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒÚ¯Ø± Ø¯Ø§Ø®Ù„ÛŒ ØªØ£Ù…ÛŒÙ† Ù…Ø§Ù„ÛŒ | B2Wall Internal Tool</title>
<script src="clarity-tracker.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<style>
body{ font-family:'Vazirmatn',system-ui; background:#0f172a }
.card{ background:#1e293b; border:1px solid #334155; border-radius:1rem; box-shadow:0 4px 24px rgba(0,0,0,.3) }
.input-field{ width:100%; padding:.875rem 1rem; background:#0f172a; border:2px solid #334155; border-radius:.75rem; color:#e2e8f0; font-size:1rem; font-weight:600; transition:all .2s; direction:ltr; text-align:right }
.input-field:focus{ outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.1) }
.btn{ padding:.75rem 1.25rem; border-radius:.75rem; font-weight:700; transition:all .2s; cursor:pointer }
.btn-primary{ background:#3b82f6; color:#fff }
.btn-primary:hover{ background:#2563eb; transform:translateY(-1px) }
.result-box{ background:#0f172a; border:2px solid #334155; border-radius:.75rem; padding:1rem }
.badge{ display:inline-flex; align-items:center; gap:.25rem; padding:.25rem .625rem; border-radius:9999px; font-size:.75rem; font-weight:600 }
.badge-success{ background:#10b981; color:#fff }
.badge-warning{ background:#f59e0b; color:#fff }
.badge-info{ background:#06b6d4; color:#fff }
label{ color:#94a3b8; font-size:.875rem; font-weight:600; margin-bottom:.5rem; display:block }
.divider{ height:1px; background:#334155; margin:1.5rem 0 }
</style>
</head>
<body>

<div class="min-h-screen py-8 px-4">
<div class="max-w-6xl mx-auto">
  
  <!-- Header -->
  <div class="card p-6 mb-6">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-white mb-1">ğŸ§® Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒÚ¯Ø± Ø¯Ø§Ø®Ù„ÛŒ ØªØ£Ù…ÛŒÙ† Ù…Ø§Ù„ÛŒ</h1>
        <p class="text-slate-400 text-sm">Ø§Ø¨Ø²Ø§Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø± Ùˆ Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÙ¾Ø°ÛŒØ±</p>
      </div>
      <span class="badge badge-warning">Internal Tool</span>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    
    <!-- Input Section -->
    <div class="card p-6">
      <h2 class="text-xl font-bold text-white mb-4">ğŸ“Š ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§</h2>
      
      <div class="space-y-4">
        <div>
          <label>Ù…Ø¨Ù„Øº ÙØ§Ú©ØªÙˆØ±</label>
          <input type="text" id="invoiceAmount" class="input-field" placeholder="Ù…Ø«Ø§Ù„: ÛµÛ°Û°ØŒÛ°Û°Û°ØŒÛ°Û°Û°" value=""/>
          <p id="invoiceAmountDisplay" class="text-xs text-slate-500 mt-1" style="display: none;"></p>
        </div>

        <div>
          <label>Ø¢ÛŒØ§ Ú©Ø§Ù„Ø§ Ø¬Ø²Ùˆ Ù…ÙˆØ§Ø±Ø¯ Ù…Ø¹Ø§Ù Ø§Ø² Ù…Ø§Ù„ÛŒØ§Øª Ø§Ø³ØªØŸ</label>
          <select id="isTaxExempt" class="input-field">
            <option value="no">Ø®ÛŒØ±ØŒ Ù…Ø´Ù…ÙˆÙ„ Ù…Ø§Ù„ÛŒØ§Øª Ø§Ø³Øª</option>
            <option value="yes">Ø¨Ù„Ù‡ØŒ Ù…Ø¹Ø§Ù Ø§Ø² Ù…Ø§Ù„ÛŒØ§Øª Ø§Ø³Øª</option>
          </select>
          <div class="mt-2 p-3 bg-slate-900 rounded-lg border border-slate-700">
            <p class="text-xs text-slate-400 leading-relaxed">
              ğŸ’¡ <strong class="text-slate-300">Ø±Ø§Ù‡Ù†Ù…Ø§:</strong> Ú©Ø§Ù„Ø§Ù‡Ø§ÛŒ Ù…Ø¹Ø§Ù Ø§Ø² Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø§Ù…Ù„ Ù…Ø­ØµÙˆÙ„Ø§Øª Ú©Ø´Ø§ÙˆØ±Ø²ÛŒ ÙØ±Ø¢ÙˆØ±ÛŒ Ù†Ø´Ø¯Ù‡ØŒ Ø¯Ø§Ù… Ùˆ Ø·ÛŒÙˆØ± Ø²Ù†Ø¯Ù‡ØŒ Ø¢Ø¨Ø²ÛŒØ§Ù†ØŒ Ø§Ù†ÙˆØ§Ø¹ Ø¯Ø§Ø±Ùˆ Ùˆ ÙˆØ§Ú©Ø³Ù†ØŒ Ù„ÙˆØ§Ø²Ù… Ù…ØµØ±ÙÛŒ Ø¯Ø±Ù…Ø§Ù†ÛŒØŒ ÙØ±Ø´ Ø¯Ø³ØªØ¨Ø§ÙØŒ Ù…Ø­ØµÙˆÙ„Ø§Øª Ù„Ø¨Ù†ÛŒ (Ø´ÛŒØ±ØŒ Ù¾Ù†ÛŒØ±ØŒ Ù…Ø§Ø³Øª)ØŒ Ø¢Ø±Ø¯ØŒ Ù†Ø§Ù† Ùˆ ØªØ¬Ù‡ÛŒØ²Ø§Øª Ø¯ÙØ§Ø¹ÛŒ Ø§Ø³Øª.
            </p>
          </div>
        </div>

        <div id="vatQuestionSection">
          <label>Ø¢ÛŒØ§ ÙØ§Ú©ØªÙˆØ± Ø´Ø§Ù…Ù„ Û±Û°Ùª Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡ Ø§Ø³ØªØŸ</label>
          <select id="hasVAT" class="input-field">
            <option value="yes">Ø¨Ù„Ù‡ØŒ Ø´Ø§Ù…Ù„ Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡ Ø§Ø³Øª</option>
            <option value="no">Ø®ÛŒØ±ØŒ Ø¨Ø¯ÙˆÙ† Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡</option>
          </select>
        </div>

        <div>
          <label>Ù…Ø¯Øª Ø²Ù…Ø§Ù† (Ù…Ø§Ù‡)</label>
          <input type="number" id="duration" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 12" value="12" min="1" max="60"/>
        </div>

        <div>
          <label>Ø¯Ø±ØµØ¯ Ø³ÙˆØ¯ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ (%)</label>
          <input type="number" id="monthlyRate" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 4.5" value="4.5" step="0.1" min="0" max="100"/>
          <p class="text-xs text-slate-500 mt-1">Ø¯Ø±ØµØ¯ Ø³ÙˆØ¯ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: 4.5 Ø¨Ù‡ Ù…Ø¹Ù†Ø§ÛŒ 4.5% Ù…Ø§Ù‡Ø§Ù†Ù‡)</p>
        </div>

        <div>
          <label>Ù†ÙˆØ¹ Ù¾Ù„Ù† ØªØ§Ù…ÛŒÙ† Ù…Ø§Ù„ÛŒ</label>
          <select id="plan" class="input-field">
            <option value="PLAN1" selected>Ù¾Ù„Ù† Û±: Ø§ØµÙ„ + Ø³ÙˆØ¯ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡</option>
            <option value="PLAN2">Ù¾Ù„Ù† Û²: Ø³ÙˆØ¯ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ + Ø§ØµÙ„ Ø¯Ø± Ø§Ù†ØªÙ‡Ø§</option>
            <option value="PLAN3">Ù¾Ù„Ù† Û³: Ø§ØµÙ„ + Ø³ÙˆØ¯ Ø¯Ø± Ø§Ù†ØªÙ‡Ø§</option>
          </select>
          <p class="text-xs text-slate-500 mt-1">Ù†ÙˆØ¹ Ù¾Ù„Ù† Ù†Ø­ÙˆÙ‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù‚Ø³Ø§Ø· Ø±Ø§ Ù…Ø´Ø®Øµ Ù…ÛŒâ€ŒÚ©Ù†Ø¯</p>
        </div>

        <div>
          <label>Ú©Ø§Ø±Ù…Ø²Ø¯ Ù¾Ù„ØªÙØ±Ù… (Û° ØªØ§ ÛµÙª Ø§Ø² Ù…Ø¨Ù„Øº ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡)</label>
          <input type="number" id="platformFee" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 2" value="2" step="0.5" min="0" max="5"/>
        </div>

        <div>
          <label>Ø¯Ø±ØµØ¯ Ø±ÙˆÚ©Ø´ Ø¶Ù…Ø§Ù†Øª (Û° ØªØ§ ÛµÙª Ø§Ø² Ù…Ø¨Ù„Øº ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡)</label>
          <input type="number" id="collateralCover" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 3" value="3" step="0.5" min="0" max="5"/>
        </div>

        <div class="divider"></div>

        <button id="calculateBtn" class="btn btn-primary w-full">
          Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ù† ğŸš€
        </button>
      </div>
    </div>

    <!-- Results Section -->
    <div class="card p-6">
      <h2 class="text-xl font-bold text-white mb-4">ğŸ“ˆ Ù†ØªØ§ÛŒØ¬ Ù…Ø­Ø§Ø³Ø¨Ø§Øª</h2>
      
      <div id="results" class="space-y-6">
        
        <!-- Investor (Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±) -->
        <div>
          <div class="flex items-center gap-2 mb-3">
            <span class="badge badge-success">Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±</span>
            <h3 class="text-lg font-bold text-slate-300">Ú©Ø³ÛŒ Ú©Ù‡ Ø³Ø±Ù…Ø§ÛŒÙ‡ Ù…ÛŒâ€ŒØ¯Ù‡</h3>
          </div>
          
          <div class="space-y-3">
            <div class="result-box">
              <p class="text-slate-400 text-sm mb-1">Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø§ÙˆÙ„ÛŒÙ‡</p>
              <p class="text-2xl font-bold text-white" id="investorInitial">-</p>
            </div>
            
            <div class="result-box">
              <p class="text-slate-400 text-sm mb-1">Ø¯Ø±ÛŒØ§ÙØªÛŒ Ù…Ø§Ù‡Ø§Ù†Ù‡</p>
              <p class="text-xl font-bold text-green-400" id="investorMonthly">-</p>
            </div>
            
            <div class="result-box">
              <p class="text-slate-400 text-sm mb-1">Ø³ÙˆØ¯ Ø¯Ø±ÛŒØ§ÙØªÛŒ Ù…Ø§Ù‡Ø§Ù†Ù‡</p>
              <p class="text-lg font-bold text-green-300" id="investorMonthlyProfit">-</p>
            </div>
            
            <div class="result-box">
              <p class="text-slate-400 text-sm mb-1">Ø³ÙˆØ¯ Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø³Ø§Ù„Ø§Ù†Ù‡</p>
              <p class="text-lg font-bold text-green-200" id="investorAnnualProfit">-</p>
            </div>
            
            <div class="result-box">
              <p class="text-slate-400 text-sm mb-1">Ù…Ø¬Ù…ÙˆØ¹ Ø¯Ø±ÛŒØ§ÙØªÛŒ</p>
              <p class="text-xl font-bold text-emerald-400" id="investorTotal">-</p>
            </div>
            
            <div class="result-box">
              <p class="text-slate-400 text-sm mb-1">Ø³ÙˆØ¯ Ø®Ø§Ù„Øµ</p>
              <p class="text-lg font-bold text-green-500" id="investorProfit">-</p>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- Recipient (Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÙ¾Ø°ÛŒØ±) -->
        <div>
          <div class="flex items-center gap-2 mb-3">
            <span class="badge badge-warning">Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÙ¾Ø°ÛŒØ±</span>
            <h3 class="text-lg font-bold text-slate-300">Ú©Ø³ÛŒ Ú©Ù‡ ØªØ§Ù…ÛŒÙ† Ù…Ø§Ù„ÛŒ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ù‡</h3>
          </div>
          
          <div class="space-y-3">
            <div class="result-box">
              <p class="text-slate-400 text-sm mb-1">Ø¯Ø±ÛŒØ§ÙØªÛŒ Ù†Ù‚Ø¯ÛŒ</p>
              <p class="text-2xl font-bold text-white" id="recipientCash">-</p>
            </div>
            
            <div class="result-box">
              <p class="text-slate-400 text-sm mb-1">Ù‚Ø³Ø· Ù…Ø§Ù‡Ø§Ù†Ù‡</p>
              <p class="text-xl font-bold text-orange-400" id="recipientMonthly">-</p>
            </div>
            
            <div class="result-box">
              <p class="text-slate-400 text-sm mb-1">Ø³ÙˆØ¯ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Ù…Ø§Ù‡Ø§Ù†Ù‡</p>
              <p class="text-lg font-bold text-orange-300" id="recipientMonthlyProfit">-</p>
            </div>
            
            <div class="result-box">
              <p class="text-slate-400 text-sm mb-1">Ø³ÙˆØ¯ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Ø³Ø§Ù„Ø§Ù†Ù‡</p>
              <p class="text-lg font-bold text-orange-200" id="recipientAnnualProfit">-</p>
            </div>
            
            <div class="result-box">
              <p class="text-slate-400 text-sm mb-1">Ù…Ø¬Ù…ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ</p>
              <p class="text-xl font-bold text-red-400" id="recipientTotal">-</p>
            </div>
            
            <div class="result-box">
              <p class="text-slate-400 text-sm mb-1">Ù‡Ø²ÛŒÙ†Ù‡ Ú©Ù„ ØªØ§Ù…ÛŒÙ† Ù…Ø§Ù„ÛŒ</p>
              <p class="text-lg font-bold text-rose-500" id="recipientCost">-</p>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- B2Wall Platform -->
        <div>
          <div class="flex items-center gap-2 mb-3">
            <span class="badge badge-info">B2Wall</span>
            <h3 class="text-lg font-bold text-slate-300">Ø¯Ø±Ø¢Ù…Ø¯ Ù¾Ù„ØªÙØ±Ù…</h3>
          </div>
          
          <div class="space-y-3">
            <div class="result-box">
              <p class="text-slate-400 text-sm mb-1">Ú©Ø§Ø±Ù…Ø²Ø¯ Ù¾Ù„ØªÙØ±Ù…</p>
              <p class="text-xl font-bold text-cyan-400" id="platformFeeAmount">-</p>
            </div>
            
            <div class="result-box">
              <p class="text-slate-400 text-sm mb-1">Ù…Ø§Ù„ÛŒØ§Øª Ú©Ø§Ø±Ù…Ø²Ø¯ Ù¾Ù„ØªÙØ±Ù… (Û±Û°Ùª)</p>
              <p class="text-lg font-bold text-cyan-300" id="platformFeeVat">-</p>
            </div>
            
            <div class="result-box">
              <p class="text-slate-400 text-sm mb-1">Ø±ÙˆÚ©Ø´ Ø¶Ù…Ø§Ù†Øª</p>
              <p class="text-xl font-bold text-purple-400" id="collateralAmount">-</p>
            </div>
            
            <div class="result-box">
              <p class="text-slate-400 text-sm mb-1">Ù…Ø§Ù„ÛŒØ§Øª Ø±ÙˆÚ©Ø´ Ø¶Ù…Ø§Ù†Øª (Û±Û°Ùª)</p>
              <p class="text-lg font-bold text-purple-300" id="collateralVat">-</p>
            </div>
            
            <div class="result-box">
              <p class="text-slate-400 text-sm mb-1">Ù…Ø¬Ù…ÙˆØ¹ Ø¯Ø±Ø¢Ù…Ø¯</p>
              <p class="text-xl font-bold text-blue-400" id="platformTotal">-</p>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>

  <!-- Monthly Installments Table (Only for Plan 1) -->
  <div class="card p-6 mt-6" id="installmentsTableCard" style="display:none;">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-bold text-white">ğŸ“Š Ø¬Ø¯ÙˆÙ„ Ø§Ù‚Ø³Ø§Ø· Ù…Ø§Ù‡Ø§Ù†Ù‡ (Ù¾Ù„Ù† Û±)</h2>
      <button id="downloadPdfBtn" class="btn btn-primary">
        ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF
      </button>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm" id="installmentsTable">
        <thead>
          <tr class="bg-slate-800 border-b border-slate-700">
            <th class="px-4 py-3 text-right text-slate-300 font-bold">Ù…Ø§Ù‡</th>
            <th class="px-4 py-3 text-right text-slate-300 font-bold">Ù…Ø§Ù†Ø¯Ù‡ Ø¨Ø¯Ù‡ÛŒ</th>
            <th class="px-4 py-3 text-right text-slate-300 font-bold">Ø³ÙˆØ¯ Ù¾Ø±ÙˆÚ˜Ù‡</th>
            <th class="px-4 py-3 text-right text-slate-300 font-bold">Ø§ØµÙ„ Ù¾ÙˆÙ„</th>
            <th class="px-4 py-3 text-right text-slate-300 font-bold">Ø³ÙˆØ¯ Ø´Ø±Ú©Øª</th>
            <th class="px-4 py-3 text-right text-slate-300 font-bold">Ù…Ø§Ù„ÛŒØ§Øª Ø³ÙˆØ¯Ù‡Ø§</th>
            <th class="px-4 py-3 text-right text-slate-300 font-bold">Ú©Ù„ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª</th>
            <th class="px-4 py-3 text-right text-slate-300 font-bold">Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±</th>
          </tr>
        </thead>
        <tbody id="installmentsTableBody">
        </tbody>
      </table>
    </div>
  </div>

  <!-- Summary Card -->
  <div class="card p-6 mt-6" id="summaryCard" style="display:none;">
    <h2 class="text-xl font-bold text-white mb-4">ğŸ“‹ Ø®Ù„Ø§ØµÙ‡ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</h2>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="result-box text-center">
        <p class="text-slate-400 text-sm mb-1">Ù¾Ù„Ù†</p>
        <p class="text-2xl font-bold text-white" id="summaryPlan">-</p>
      </div>
      <div class="result-box text-center">
        <p class="text-slate-400 text-sm mb-1">ØªØ¹Ø¯Ø§Ø¯ Ø§Ù‚Ø³Ø§Ø·</p>
        <p class="text-2xl font-bold text-white" id="summaryMonths">-</p>
      </div>
      <div class="result-box text-center">
        <p class="text-slate-400 text-sm mb-1">Ù†Ø±Ø® Ø³ÙˆØ¯ (Ù…Ø§Ù‡Ø§Ù†Ù‡)</p>
        <p class="text-2xl font-bold text-orange-400" id="summaryRate">-</p>
      </div>
      <div class="result-box text-center">
        <p class="text-slate-400 text-sm mb-1">Ù…Ø¨Ù„Øº ØªØ§Ù…ÛŒÙ† Ø´Ø¯Ù‡</p>
        <p class="text-2xl font-bold text-green-400" id="summaryFinanced">-</p>
      </div>
    </div>
  </div>

</div>
</div>

<script>
// Utilities
const formatNumber = (n) => {
  const persianDigits = ['Û°', 'Û±', 'Û²', 'Û³', 'Û´', 'Ûµ', 'Û¶', 'Û·', 'Û¸', 'Û¹'];
  const numStr = Math.round(n).toString();
  let result = '';
  
  // Add thousand separators
  for (let i = 0; i < numStr.length; i++) {
    if (i > 0 && (numStr.length - i) % 3 === 0) {
      result += 'Ù¬'; // Persian comma
    }
    const digit = parseInt(numStr[i]);
    result += persianDigits[digit];
  }
  
  return result + ' ØªÙˆÙ…Ø§Ù†';
};

const parseFormattedNumber = (str) => {
  // Remove persian/english commas and spaces
  return str.replace(/[Ù¬,\sØªÙˆÙ…Ø§Ù†]/g, '')
            .replace(/[Û°-Û¹]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d))
            .replace(/[^0-9]/g, '');
};

// Plan configuration - Payment structures (monthlyRate is now dynamic from user input)
const PLANS = {
  'PLAN1': {
    name: 'Ù¾Ù„Ù† Û±: Ø§ØµÙ„ + Ø³ÙˆØ¯ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡',
    description: 'Ø§ØµÙ„ Ùˆ Ø³ÙˆØ¯ Ø¨Ù‡ ØµÙˆØ±Øª Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯',
    paymentType: 'monthly_principal_interest' // Ø§Ù‚Ø³Ø§Ø· Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ Ø´Ø§Ù…Ù„ Ø§ØµÙ„ Ùˆ Ø³ÙˆØ¯
  },
  'PLAN2': {
    name: 'Ù¾Ù„Ù† Û²: Ø³ÙˆØ¯ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ + Ø§ØµÙ„ Ø¯Ø± Ø§Ù†ØªÙ‡Ø§',
    description: 'Ø³ÙˆØ¯ Ø¨Ù‡ ØµÙˆØ±Øª Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ Ùˆ Ø§ØµÙ„ Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯',
    paymentType: 'monthly_interest_only' // Ø³ÙˆØ¯ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ + Ø§ØµÙ„ Ø¯Ø± Ø§Ù†ØªÙ‡Ø§
  },
  'PLAN3': {
    name: 'Ù¾Ù„Ù† Û³: Ø§ØµÙ„ + Ø³ÙˆØ¯ Ø¯Ø± Ø§Ù†ØªÙ‡Ø§',
    description: 'Ø§ØµÙ„ Ùˆ Ø³ÙˆØ¯ Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ÛŒ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯',
    paymentType: 'lump_sum' // Ù¾Ø±Ø¯Ø§Ø®Øª ÛŒÚ©Ø¬Ø§ Ø¯Ø± Ø§Ù†ØªÙ‡Ø§
  }
};

const VAT_RATE = 10; // Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡ 10%

// API Configuration
const API_URL = 'https://n8nb2wall.darkube.app/webhook/internal-calculator';

// Calculate function
async function calculate() {
  // Get inputs
  const invoiceAmountStr = document.getElementById('invoiceAmount').value;
  const invoiceAmount = Number(parseFormattedNumber(invoiceAmountStr));
  const isTaxExempt = document.getElementById('isTaxExempt').value;
  const hasVAT = document.getElementById('hasVAT').value;
  const duration = Number(document.getElementById('duration').value);
  const planCode = document.getElementById('plan').value;
  const monthlyRate = Number(document.getElementById('monthlyRate').value);
  const platformFeeRate = Number(document.getElementById('platformFee').value);
  const collateralCoverRate = Number(document.getElementById('collateralCover').value);

  // Validate (only when calculate button is clicked, not on every input)
  if (!invoiceAmount || invoiceAmount <= 0) {
    alert('Ù„Ø·ÙØ§Ù‹ Ù…Ø¨Ù„Øº ÙØ§Ú©ØªÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
    return;
  }
  
  if (!duration || duration <= 0) {
    alert('Ù„Ø·ÙØ§Ù‹ Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
    return;
  }
  
  if (!planCode) {
    alert('Ù„Ø·ÙØ§Ù‹ Ù†ÙˆØ¹ Ù¾Ù„Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
    return;
  }

  if (!monthlyRate || monthlyRate <= 0 || monthlyRate > 100) {
    alert('Ù„Ø·ÙØ§Ù‹ Ø¯Ø±ØµØ¯ Ø³ÙˆØ¯ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ Ø±Ø§ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ø¨ÛŒÙ† 0 ØªØ§ 100)');
    return;
  }

  // Show loading state
  const btn = document.getElementById('calculateBtn');
  const originalText = btn.innerHTML;
  btn.innerHTML = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡...';
  btn.disabled = true;

  try {
    // Send data to N8N
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        invoiceAmount,
        isTaxExempt,
        hasVAT,
        duration,
        planCode,
        monthlyRate,
        platformFeeRate,
        collateralCoverRate
      })
    });

    if (!response.ok) {
      throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
    }

    const result = await response.json();

    // N8N returns array, get first item
    const responseData = Array.isArray(result) ? result[0] : result;

    if (!responseData.success) {
      throw new Error(responseData.message || 'Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ø§Øª');
    }

    // Update UI with results from N8N
    // API returns data in responseData.data
    const data = responseData.data || responseData;
    updateUI(data);

  } catch (error) {
    console.error('Error:', error);
    alert('Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ø§Øª. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
  } finally {
    // Restore button state
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
}

// Update UI with calculation results
function updateUI(data) {
  const plan = PLANS[document.getElementById('plan').value];
  const duration = Number(document.getElementById('duration').value);
  const monthlyRate = Number(document.getElementById('monthlyRate').value);
  
  // Investor
  document.getElementById('investorInitial').textContent = formatNumber(data.investor.initial);
  
  if (data.summary.paymentType === 'lump_sum') {
    document.getElementById('investorMonthly').textContent = 'Û° ØªÙˆÙ…Ø§Ù† (Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø± Ø§Ù†ØªÙ‡Ø§)';
    document.getElementById('investorMonthlyProfit').textContent = 'Û°% (Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø± Ø§Ù†ØªÙ‡Ø§)';
    document.getElementById('investorAnnualProfit').textContent = 'Û°% (Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø± Ø§Ù†ØªÙ‡Ø§)';
  } else {
    document.getElementById('investorMonthly').textContent = formatNumber(data.investor.monthlyReturn);
    const monthlyProfitPercent = (data.investor.monthlyProfit || 0).toFixed(2);
    document.getElementById('investorMonthlyProfit').textContent = monthlyProfitPercent.toString().replace(/[0-9]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[d]) + '%';
    const annualProfitPercent = (data.investor.annualProfit || 0).toFixed(1);
    document.getElementById('investorAnnualProfit').textContent = annualProfitPercent.toString().replace(/[0-9]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[d]) + '%';
  }
  
  document.getElementById('investorTotal').textContent = formatNumber(data.investor.totalReturn);
  document.getElementById('investorProfit').textContent = formatNumber(data.investor.profit);
  
  // Recipient
  document.getElementById('recipientCash').textContent = formatNumber(data.recipient.cash);
  
  if (data.summary.paymentType === 'lump_sum') {
    document.getElementById('recipientMonthly').textContent = 'Û° ØªÙˆÙ…Ø§Ù† (Ù¾Ø±Ø¯Ø§Ø®Øª Ø¯Ø± Ø§Ù†ØªÙ‡Ø§)';
    document.getElementById('recipientMonthlyProfit').textContent = 'Û°% (Ù¾Ø±Ø¯Ø§Ø®Øª Ø¯Ø± Ø§Ù†ØªÙ‡Ø§)';
    document.getElementById('recipientAnnualProfit').textContent = 'Û°% (Ù¾Ø±Ø¯Ø§Ø®Øª Ø¯Ø± Ø§Ù†ØªÙ‡Ø§)';
  } else {
    document.getElementById('recipientMonthly').textContent = formatNumber(data.recipient.monthlyInstallment);
    const monthlyProfitPercent = (data.recipient.monthlyProfit || 0).toFixed(2);
    document.getElementById('recipientMonthlyProfit').textContent = monthlyProfitPercent.toString().replace(/[0-9]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[d]) + '%';
    const annualProfitPercent = (data.recipient.annualProfit || 0).toFixed(1);
    document.getElementById('recipientAnnualProfit').textContent = annualProfitPercent.toString().replace(/[0-9]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[d]) + '%';
  }
  
  document.getElementById('recipientTotal').textContent = formatNumber(data.recipient.totalPayment);
  document.getElementById('recipientCost').textContent = formatNumber(data.recipient.financingCost);

  // B2Wall Platform
  document.getElementById('platformFeeAmount').textContent = formatNumber(data.platform.platformFee);
  document.getElementById('platformFeeVat').textContent = formatNumber(data.platform.platformFeeVat || 0);
  document.getElementById('collateralAmount').textContent = formatNumber(data.platform.collateral);
  document.getElementById('collateralVat').textContent = formatNumber(data.platform.collateralVat || 0);
  document.getElementById('platformTotal').textContent = formatNumber(data.platform.totalRevenue);

  // Summary
  document.getElementById('summaryPlan').textContent = data.summary.planName;
  document.getElementById('summaryMonths').textContent = 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[Math.floor(duration / 10)] + 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[duration % 10] + ' Ù…Ø§Ù‡';
  document.getElementById('summaryRate').textContent = monthlyRate.toString().replace(/[0-9]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[d]) + '%';
  document.getElementById('summaryFinanced').textContent = formatNumber(data.invoice.withVAT);
  
  // Show summary
  document.getElementById('summaryCard').style.display = 'block';
  
  // Show monthly installments table for Plan 1
  if (data.summary.paymentType === 'monthly_principal_interest' && data.monthlyInstallments && data.monthlyInstallments.length > 0) {
    displayMonthlyInstallments(data.monthlyInstallments);
    document.getElementById('installmentsTableCard').style.display = 'block';
  } else {
    document.getElementById('installmentsTableCard').style.display = 'none';
  }
}

// Display monthly installments table
function displayMonthlyInstallments(installments) {
  const tbody = document.getElementById('installmentsTableBody');
  tbody.innerHTML = '';
  
  installments.forEach(inst => {
    const row = document.createElement('tr');
    row.className = 'border-b border-slate-700 hover:bg-slate-800';
    row.innerHTML = `
      <td class="px-4 py-3 text-slate-300">${inst.month}</td>
      <td class="px-4 py-3 text-slate-300">${formatNumber(inst.remainingDebt).replace(' ØªÙˆÙ…Ø§Ù†', '')}</td>
      <td class="px-4 py-3 text-slate-300">${formatNumber(inst.projectInterest).replace(' ØªÙˆÙ…Ø§Ù†', '')}</td>
      <td class="px-4 py-3 text-slate-300">${formatNumber(inst.principalPayment).replace(' ØªÙˆÙ…Ø§Ù†', '')}</td>
      <td class="px-4 py-3 text-slate-300">${formatNumber(inst.companyProfit).replace(' ØªÙˆÙ…Ø§Ù†', '')}</td>
      <td class="px-4 py-3 text-slate-300">${formatNumber(inst.profitVat).replace(' ØªÙˆÙ…Ø§Ù†', '')}</td>
      <td class="px-4 py-3 text-slate-300 font-bold">${formatNumber(inst.totalPayment).replace(' ØªÙˆÙ…Ø§Ù†', '')}</td>
      <td class="px-4 py-3 text-green-400 font-bold">${formatNumber(inst.investorReceipt).replace(' ØªÙˆÙ…Ø§Ù†', '')}</td>
    `;
    tbody.appendChild(row);
  });
}

// Download PDF function
function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('l', 'mm', 'a4'); // landscape orientation
  
  // Get all data
  const invoiceAmount = document.getElementById('invoiceAmount').value;
  const duration = document.getElementById('duration').value;
  const monthlyRate = document.getElementById('monthlyRate').value;
  const plan = document.getElementById('plan').value;
  const planName = document.querySelector(`#plan option[value="${plan}"]`).textContent;
  
  // Title
  doc.setFontSize(18);
  doc.text('Ú¯Ø²Ø§Ø±Ø´ Ù…Ø­Ø§Ø³Ø¨Ø§Øª ØªØ£Ù…ÛŒÙ† Ù…Ø§Ù„ÛŒ', 150, 15, { align: 'center' });
  
  // Summary section
  doc.setFontSize(12);
  let yPos = 30;
  doc.text(`Ù…Ø¨Ù„Øº ÙØ§Ú©ØªÙˆØ±: ${invoiceAmount}`, 20, yPos);
  yPos += 7;
  doc.text(`Ù…Ø¯Øª Ø²Ù…Ø§Ù†: ${duration} Ù…Ø§Ù‡`, 20, yPos);
  yPos += 7;
  doc.text(`Ù†ÙˆØ¹ Ù¾Ù„Ù†: ${planName}`, 20, yPos);
  yPos += 7;
  doc.text(`Ø¯Ø±ØµØ¯ Ø³ÙˆØ¯ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡: ${monthlyRate}%`, 20, yPos);
  yPos += 10;
  
  // Get results data
  const investorInitial = document.getElementById('investorInitial').textContent;
  const investorMonthly = document.getElementById('investorMonthly').textContent;
  const investorMonthlyProfit = document.getElementById('investorMonthlyProfit').textContent;
  const investorAnnualProfit = document.getElementById('investorAnnualProfit').textContent;
  const investorTotal = document.getElementById('investorTotal').textContent;
  const investorProfit = document.getElementById('investorProfit').textContent;
  
  const recipientCash = document.getElementById('recipientCash').textContent;
  const recipientMonthly = document.getElementById('recipientMonthly').textContent;
  const recipientMonthlyProfit = document.getElementById('recipientMonthlyProfit').textContent;
  const recipientAnnualProfit = document.getElementById('recipientAnnualProfit').textContent;
  const recipientTotal = document.getElementById('recipientTotal').textContent;
  const recipientCost = document.getElementById('recipientCost').textContent;
  
  // Investor section
  doc.setFontSize(14);
  doc.text('Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±', 20, yPos);
  yPos += 7;
  doc.setFontSize(10);
  doc.text(`Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø§ÙˆÙ„ÛŒÙ‡: ${investorInitial}`, 25, yPos);
  yPos += 6;
  doc.text(`Ø¯Ø±ÛŒØ§ÙØªÛŒ Ù…Ø§Ù‡Ø§Ù†Ù‡: ${investorMonthly}`, 25, yPos);
  yPos += 6;
  doc.text(`Ø³ÙˆØ¯ Ø¯Ø±ÛŒØ§ÙØªÛŒ Ù…Ø§Ù‡Ø§Ù†Ù‡: ${investorMonthlyProfit}`, 25, yPos);
  yPos += 6;
  doc.text(`Ø³ÙˆØ¯ Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø³Ø§Ù„Ø§Ù†Ù‡: ${investorAnnualProfit}`, 25, yPos);
  yPos += 6;
  doc.text(`Ù…Ø¬Ù…ÙˆØ¹ Ø¯Ø±ÛŒØ§ÙØªÛŒ: ${investorTotal}`, 25, yPos);
  yPos += 6;
  doc.text(`Ø³ÙˆØ¯ Ø®Ø§Ù„Øµ: ${investorProfit}`, 25, yPos);
  yPos += 10;
  
  // Recipient section
  doc.setFontSize(14);
  doc.text('Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÙ¾Ø°ÛŒØ±', 20, yPos);
  yPos += 7;
  doc.setFontSize(10);
  doc.text(`Ø¯Ø±ÛŒØ§ÙØªÛŒ Ù†Ù‚Ø¯ÛŒ: ${recipientCash}`, 25, yPos);
  yPos += 6;
  doc.text(`Ù‚Ø³Ø· Ù…Ø§Ù‡Ø§Ù†Ù‡: ${recipientMonthly}`, 25, yPos);
  yPos += 6;
  doc.text(`Ø³ÙˆØ¯ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Ù…Ø§Ù‡Ø§Ù†Ù‡: ${recipientMonthlyProfit}`, 25, yPos);
  yPos += 6;
  doc.text(`Ø³ÙˆØ¯ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Ø³Ø§Ù„Ø§Ù†Ù‡: ${recipientAnnualProfit}`, 25, yPos);
  yPos += 6;
  doc.text(`Ù…Ø¬Ù…ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ: ${recipientTotal}`, 25, yPos);
  yPos += 6;
  doc.text(`Ù‡Ø²ÛŒÙ†Ù‡ Ú©Ù„ ØªØ§Ù…ÛŒÙ† Ù…Ø§Ù„ÛŒ: ${recipientCost}`, 25, yPos);
  yPos += 10;
  
  // Monthly installments table (if Plan 1)
  if (plan === 'PLAN1') {
    const installmentsTable = document.getElementById('installmentsTable');
    if (installmentsTable && installmentsTable.style.display !== 'none') {
      doc.autoTable({
        html: '#installmentsTable',
        startY: yPos,
        theme: 'striped',
        headStyles: { fillColor: [30, 41, 59], textColor: 255 },
        styles: { font: 'Vazirmatn', fontSize: 8, cellPadding: 2 },
        margin: { left: 20, right: 20 }
      });
    }
  }
  
  // Save PDF
  doc.save(`Ú¯Ø²Ø§Ø±Ø´-ØªØ§Ù…ÛŒÙ†-Ù…Ø§Ù„ÛŒ-${Date.now()}.pdf`);
}

// Event listeners
document.getElementById('calculateBtn').addEventListener('click', calculate);
document.getElementById('downloadPdfBtn').addEventListener('click', downloadPDF);

// Handle tax exempt status change
document.getElementById('isTaxExempt').addEventListener('change', function() {
  const vatQuestionSection = document.getElementById('vatQuestionSection');
  if (this.value === 'yes') {
    // Ø§Ú¯Ø± Ú©Ø§Ù„Ø§ Ù…Ø¹Ø§Ù Ø§Ø³ØªØŒ Ø³ÙˆØ§Ù„ Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡ Ø±Ø§ Ù…Ø®ÙÛŒ Ú©Ù†
    vatQuestionSection.style.display = 'none';
  } else {
    // Ø§Ú¯Ø± Ù…Ø´Ù…ÙˆÙ„ Ù…Ø§Ù„ÛŒØ§Øª Ø§Ø³ØªØŒ Ø³ÙˆØ§Ù„ Ø±Ø§ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡
    vatQuestionSection.style.display = 'block';
  }
  
  // Recalculate if summary is visible
  if (document.getElementById('summaryCard').style.display !== 'none') {
    calculate();
  }
});

// Auto-calculate on input/change - REMOVED, only calculate on button click
// Helper function to format number to millions/ billions
function formatToReadable(num) {
  if (!num || num === 0) return '';
  const millions = num / 1000000;
  const billions = num / 1000000000;
  
  if (billions >= 1) {
    return billions.toFixed(billions % 1 === 0 ? 0 : 1) + ' Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯ ØªÙˆÙ…Ø§Ù†';
  } else if (millions >= 1) {
    return millions.toFixed(millions % 1 === 0 ? 0 : 1) + ' Ù…ÛŒÙ„ÛŒÙˆÙ† ØªÙˆÙ…Ø§Ù†';
  } else {
    return formatNumber(num);
  }
}

// Event listeners for formatting invoice amount
document.getElementById('invoiceAmount').addEventListener('input', function(e) {
  const val = parseFormattedNumber(e.target.value);
  const displayEl = document.getElementById('invoiceAmountDisplay');
  
  if (val && val > 0) {
    displayEl.textContent = formatToReadable(val);
    displayEl.style.display = 'block';
  } else {
    displayEl.style.display = 'none';
  }
});

document.getElementById('invoiceAmount').addEventListener('blur', function(e) {
  const val = parseFormattedNumber(e.target.value);
  if (val) {
    e.target.value = formatNumber(val).replace(' ØªÙˆÙ…Ø§Ù†', '');
  }
});

document.getElementById('invoiceAmount').addEventListener('focus', function(e) {
  // Remove formatting on focus for easier editing
  const val = parseFormattedNumber(e.target.value);
  if (val) {
    e.target.value = val;
  }
});

// Don't auto-calculate anymore
</script>

</body>
</html>
