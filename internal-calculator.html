<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒÚ¯Ø± Ø¯Ø§Ø®Ù„ÛŒ ØªØ£Ù…ÛŒÙ† Ù…Ø§Ù„ÛŒ | B2Wall Internal Tool</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<style>
body{ font-family:'Vazirmatn',system-ui; background:#0f172a }
.card{ background:#1e293b; border:1px solid #334155; border-radius:1rem; box-shadow:0 4px 24px rgba(0,0,0,.3) }
.input-field{ width:100%; padding:.875rem 1rem; background:#0f172a; border:2px solid #334155; border-radius:.75rem; color:#e2e8f0; font-size:1rem; font-weight:600; transition:all .2s; direction:ltr; text-align:right }
.input-field:focus{ outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.1) }
.btn{ padding:.75rem 1.25rem; border-radius:.75rem; font-weight:700; transition:all .2s; cursor:pointer }
.btn-primary{ background:#3b82f6; color:#fff }
.btn-primary:hover{ background:#2563eb; transform:translateY(-1px) }
.result-box{ background:#0f172a; border:2px solid #334155; border-radius:.75rem; padding:1rem }
.badge{ display:inline-flex; align-items:center; gap:.25rem; padding:.25rem .625rem; border-radius:9999px; font-size:.75rem; font-weight:600 }
.badge-success{ background:#10b981; color:#fff }
.badge-warning{ background:#f59e0b; color:#fff }
.badge-info{ background:#06b6d4; color:#fff }
label{ color:#94a3b8; font-size:.875rem; font-weight:600; margin-bottom:.5rem; display:block }
.divider{ height:1px; background:#334155; margin:1.5rem 0 }
</style>
</head>
<body>

<div class="min-h-screen py-8 px-4">
<div class="max-w-6xl mx-auto">
  
  <!-- Header -->
  <div class="card p-6 mb-6">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-white mb-1">ğŸ§® Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒÚ¯Ø± Ø¯Ø§Ø®Ù„ÛŒ ØªØ£Ù…ÛŒÙ† Ù…Ø§Ù„ÛŒ</h1>
        <p class="text-slate-400 text-sm">Ø§Ø¨Ø²Ø§Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø± Ùˆ Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÙ¾Ø°ÛŒØ±</p>
      </div>
      <span class="badge badge-warning">Internal Tool</span>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    
    <!-- Input Section -->
    <div class="card p-6">
      <h2 class="text-xl font-bold text-white mb-4">ğŸ“Š ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§</h2>
      
      <div class="space-y-4">
        <div>
          <label>Ù…Ø¨Ù„Øº ÙØ§Ú©ØªÙˆØ±</label>
          <input type="text" id="invoiceAmount" class="input-field" placeholder="Ù…Ø«Ø§Ù„: ÛµÛ°Û°ØŒÛ°Û°Û°ØŒÛ°Û°Û°" value=""/>
        </div>

        <div>
          <label>Ø¢ÛŒØ§ Ú©Ø§Ù„Ø§ Ø¬Ø²Ùˆ Ù…ÙˆØ§Ø±Ø¯ Ù…Ø¹Ø§Ù Ø§Ø² Ù…Ø§Ù„ÛŒØ§Øª Ø§Ø³ØªØŸ</label>
          <select id="isTaxExempt" class="input-field">
            <option value="no">Ø®ÛŒØ±ØŒ Ù…Ø´Ù…ÙˆÙ„ Ù…Ø§Ù„ÛŒØ§Øª Ø§Ø³Øª</option>
            <option value="yes">Ø¨Ù„Ù‡ØŒ Ù…Ø¹Ø§Ù Ø§Ø² Ù…Ø§Ù„ÛŒØ§Øª Ø§Ø³Øª</option>
          </select>
          <div class="mt-2 p-3 bg-slate-900 rounded-lg border border-slate-700">
            <p class="text-xs text-slate-400 leading-relaxed">
              ğŸ’¡ <strong class="text-slate-300">Ø±Ø§Ù‡Ù†Ù…Ø§:</strong> Ú©Ø§Ù„Ø§Ù‡Ø§ÛŒ Ù…Ø¹Ø§Ù Ø§Ø² Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø§Ù…Ù„ Ù…Ø­ØµÙˆÙ„Ø§Øª Ú©Ø´Ø§ÙˆØ±Ø²ÛŒ ÙØ±Ø¢ÙˆØ±ÛŒ Ù†Ø´Ø¯Ù‡ØŒ Ø¯Ø§Ù… Ùˆ Ø·ÛŒÙˆØ± Ø²Ù†Ø¯Ù‡ØŒ Ø¢Ø¨Ø²ÛŒØ§Ù†ØŒ Ø§Ù†ÙˆØ§Ø¹ Ø¯Ø§Ø±Ùˆ Ùˆ ÙˆØ§Ú©Ø³Ù†ØŒ Ù„ÙˆØ§Ø²Ù… Ù…ØµØ±ÙÛŒ Ø¯Ø±Ù…Ø§Ù†ÛŒØŒ ÙØ±Ø´ Ø¯Ø³ØªØ¨Ø§ÙØŒ Ù…Ø­ØµÙˆÙ„Ø§Øª Ù„Ø¨Ù†ÛŒ (Ø´ÛŒØ±ØŒ Ù¾Ù†ÛŒØ±ØŒ Ù…Ø§Ø³Øª)ØŒ Ø¢Ø±Ø¯ØŒ Ù†Ø§Ù† Ùˆ ØªØ¬Ù‡ÛŒØ²Ø§Øª Ø¯ÙØ§Ø¹ÛŒ Ø§Ø³Øª.
            </p>
          </div>
        </div>

        <div id="vatQuestionSection">
          <label>Ø¢ÛŒØ§ ÙØ§Ú©ØªÙˆØ± Ø´Ø§Ù…Ù„ Û±Û°Ùª Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡ Ø§Ø³ØªØŸ</label>
          <select id="hasVAT" class="input-field">
            <option value="yes">Ø¨Ù„Ù‡ØŒ Ø´Ø§Ù…Ù„ Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡ Ø§Ø³Øª</option>
            <option value="no">Ø®ÛŒØ±ØŒ Ø¨Ø¯ÙˆÙ† Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡</option>
          </select>
        </div>

        <div>
          <label>Ù…Ø¯Øª Ø²Ù…Ø§Ù† (Ù…Ø§Ù‡)</label>
          <input type="number" id="duration" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 12" value="12" min="1" max="60"/>
        </div>

        <div>
          <label>Ù†ÙˆØ¹ Ù¾Ù„Ù† ØªØ§Ù…ÛŒÙ† Ù…Ø§Ù„ÛŒ</label>
          <select id="plan" class="input-field">
            <option value="PLAN1" selected>Ù¾Ù„Ù† Û±: Ø§ØµÙ„ + Ø³ÙˆØ¯ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ (Û´.ÛµÙª Ù…Ø§Ù‡Ø§Ù†Ù‡)</option>
            <option value="PLAN2">Ù¾Ù„Ù† Û²: Ø³ÙˆØ¯ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ + Ø§ØµÙ„ Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ (Ûµ.ÛµÙª Ù…Ø§Ù‡Ø§Ù†Ù‡)</option>
            <option value="PLAN3">Ù¾Ù„Ù† Û³: Ø§ØµÙ„ + Ø³ÙˆØ¯ Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ (Û·Ùª Ù…Ø§Ù‡Ø§Ù†Ù‡)</option>
          </select>
        </div>

        <div>
          <label>Ú©Ø§Ø±Ù…Ø²Ø¯ Ù¾Ù„ØªÙØ±Ù… (Û° ØªØ§ ÛµÙª Ø§Ø² Ù…Ø¨Ù„Øº ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡)</label>
          <input type="number" id="platformFee" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 2" value="2" step="0.5" min="0" max="5"/>
        </div>

        <div>
          <label>Ø¯Ø±ØµØ¯ Ø±ÙˆÚ©Ø´ Ø¶Ù…Ø§Ù†Øª (Û° ØªØ§ ÛµÙª Ø§Ø² Ù…Ø¨Ù„Øº ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡)</label>
          <input type="number" id="collateralCover" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 3" value="3" step="0.5" min="0" max="5"/>
        </div>

        <div class="divider"></div>

        <button id="calculateBtn" class="btn btn-primary w-full">
          Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ù† ğŸš€
        </button>
      </div>
    </div>

    <!-- Results Section -->
    <div class="card p-6">
      <h2 class="text-xl font-bold text-white mb-4">ğŸ“ˆ Ù†ØªØ§ÛŒØ¬ Ù…Ø­Ø§Ø³Ø¨Ø§Øª</h2>
      
      <div id="results" class="space-y-6">
        
        <!-- Investor (Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±) -->
        <div>
          <div class="flex items-center gap-2 mb-3">
            <span class="badge badge-success">Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±</span>
            <h3 class="text-lg font-bold text-slate-300">Ú©Ø³ÛŒ Ú©Ù‡ Ø³Ø±Ù…Ø§ÛŒÙ‡ Ù…ÛŒâ€ŒØ¯Ù‡</h3>
          </div>
          
          <div class="space-y-3">
            <div class="result-box">
              <p class="text-slate-400 text-sm mb-1">Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø§ÙˆÙ„ÛŒÙ‡</p>
              <p class="text-2xl font-bold text-white" id="investorInitial">-</p>
            </div>
            
            <div class="result-box">
              <p class="text-slate-400 text-sm mb-1">Ø¯Ø±ÛŒØ§ÙØªÛŒ Ù…Ø§Ù‡Ø§Ù†Ù‡</p>
              <p class="text-xl font-bold text-green-400" id="investorMonthly">-</p>
            </div>
            
            <div class="result-box">
              <p class="text-slate-400 text-sm mb-1">Ù…Ø¬Ù…ÙˆØ¹ Ø¯Ø±ÛŒØ§ÙØªÛŒ</p>
              <p class="text-xl font-bold text-emerald-400" id="investorTotal">-</p>
            </div>
            
            <div class="result-box">
              <p class="text-slate-400 text-sm mb-1">Ø³ÙˆØ¯ Ø®Ø§Ù„Øµ</p>
              <p class="text-lg font-bold text-green-500" id="investorProfit">-</p>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- Recipient (Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÙ¾Ø°ÛŒØ±) -->
        <div>
          <div class="flex items-center gap-2 mb-3">
            <span class="badge badge-warning">Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÙ¾Ø°ÛŒØ±</span>
            <h3 class="text-lg font-bold text-slate-300">Ú©Ø³ÛŒ Ú©Ù‡ ØªØ§Ù…ÛŒÙ† Ù…Ø§Ù„ÛŒ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ù‡</h3>
          </div>
          
          <div class="space-y-3">
            <div class="result-box">
              <p class="text-slate-400 text-sm mb-1">Ø¯Ø±ÛŒØ§ÙØªÛŒ Ù†Ù‚Ø¯ÛŒ</p>
              <p class="text-2xl font-bold text-white" id="recipientCash">-</p>
            </div>
            
            <div class="result-box">
              <p class="text-slate-400 text-sm mb-1">Ù‚Ø³Ø· Ù…Ø§Ù‡Ø§Ù†Ù‡</p>
              <p class="text-xl font-bold text-orange-400" id="recipientMonthly">-</p>
            </div>
            
            <div class="result-box">
              <p class="text-slate-400 text-sm mb-1">Ù…Ø¬Ù…ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ</p>
              <p class="text-xl font-bold text-red-400" id="recipientTotal">-</p>
            </div>
            
            <div class="result-box">
              <p class="text-slate-400 text-sm mb-1">Ù‡Ø²ÛŒÙ†Ù‡ Ú©Ù„ ØªØ§Ù…ÛŒÙ† Ù…Ø§Ù„ÛŒ</p>
              <p class="text-lg font-bold text-rose-500" id="recipientCost">-</p>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- B2Wall Platform -->
        <div>
          <div class="flex items-center gap-2 mb-3">
            <span class="badge badge-info">B2Wall</span>
            <h3 class="text-lg font-bold text-slate-300">Ø¯Ø±Ø¢Ù…Ø¯ Ù¾Ù„ØªÙØ±Ù…</h3>
          </div>
          
          <div class="space-y-3">
            <div class="result-box">
              <p class="text-slate-400 text-sm mb-1">Ú©Ø§Ø±Ù…Ø²Ø¯ Ù¾Ù„ØªÙØ±Ù…</p>
              <p class="text-xl font-bold text-cyan-400" id="platformFeeAmount">-</p>
            </div>
            
            <div class="result-box">
              <p class="text-slate-400 text-sm mb-1">Ø±ÙˆÚ©Ø´ Ø¶Ù…Ø§Ù†Øª</p>
              <p class="text-xl font-bold text-purple-400" id="collateralAmount">-</p>
            </div>
            
            <div class="result-box">
              <p class="text-slate-400 text-sm mb-1">Ù…Ø¬Ù…ÙˆØ¹ Ø¯Ø±Ø¢Ù…Ø¯</p>
              <p class="text-xl font-bold text-blue-400" id="platformTotal">-</p>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>

  <!-- Summary Card -->
  <div class="card p-6 mt-6" id="summaryCard" style="display:none;">
    <h2 class="text-xl font-bold text-white mb-4">ğŸ“‹ Ø®Ù„Ø§ØµÙ‡ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</h2>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="result-box text-center">
        <p class="text-slate-400 text-sm mb-1">Ù¾Ù„Ù†</p>
        <p class="text-2xl font-bold text-white" id="summaryPlan">-</p>
      </div>
      <div class="result-box text-center">
        <p class="text-slate-400 text-sm mb-1">ØªØ¹Ø¯Ø§Ø¯ Ø§Ù‚Ø³Ø§Ø·</p>
        <p class="text-2xl font-bold text-white" id="summaryMonths">-</p>
      </div>
      <div class="result-box text-center">
        <p class="text-slate-400 text-sm mb-1">Ù†Ø±Ø® Ø³ÙˆØ¯ (Ù…Ø§Ù‡Ø§Ù†Ù‡)</p>
        <p class="text-2xl font-bold text-orange-400" id="summaryRate">-</p>
      </div>
      <div class="result-box text-center">
        <p class="text-slate-400 text-sm mb-1">Ù…Ø¨Ù„Øº ØªØ§Ù…ÛŒÙ† Ø´Ø¯Ù‡</p>
        <p class="text-2xl font-bold text-green-400" id="summaryFinanced">-</p>
      </div>
    </div>
  </div>

</div>
</div>

<script>
// Utilities
const formatNumber = (n) => {
  const persianDigits = ['Û°', 'Û±', 'Û²', 'Û³', 'Û´', 'Ûµ', 'Û¶', 'Û·', 'Û¸', 'Û¹'];
  const numStr = Math.round(n).toString();
  let result = '';
  
  // Add thousand separators
  for (let i = 0; i < numStr.length; i++) {
    if (i > 0 && (numStr.length - i) % 3 === 0) {
      result += 'Ù¬'; // Persian comma
    }
    const digit = parseInt(numStr[i]);
    result += persianDigits[digit];
  }
  
  return result + ' ØªÙˆÙ…Ø§Ù†';
};

const parseFormattedNumber = (str) => {
  // Remove persian/english commas and spaces
  return str.replace(/[Ù¬,\sØªÙˆÙ…Ø§Ù†]/g, '')
            .replace(/[Û°-Û¹]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d))
            .replace(/[^0-9]/g, '');
};

// Plan configuration - Monthly interest rates and payment structures
const PLANS = {
  'PLAN1': {
    name: 'Ù¾Ù„Ù† Û±: Ø§ØµÙ„ + Ø³ÙˆØ¯ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡',
    monthlyRate: 4.5,
    description: 'Ø§ØµÙ„ Ùˆ Ø³ÙˆØ¯ Ø¨Ù‡ ØµÙˆØ±Øª Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯',
    paymentType: 'monthly_principal_interest' // Ø§Ù‚Ø³Ø§Ø· Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ Ø´Ø§Ù…Ù„ Ø§ØµÙ„ Ùˆ Ø³ÙˆØ¯
  },
  'PLAN2': {
    name: 'Ù¾Ù„Ù† Û²: Ø³ÙˆØ¯ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ + Ø§ØµÙ„ Ø¯Ø± Ø§Ù†ØªÙ‡Ø§',
    monthlyRate: 5.5,
    description: 'Ø³ÙˆØ¯ Ø¨Ù‡ ØµÙˆØ±Øª Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ Ùˆ Ø§ØµÙ„ Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯',
    paymentType: 'monthly_interest_only' // Ø³ÙˆØ¯ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ + Ø§ØµÙ„ Ø¯Ø± Ø§Ù†ØªÙ‡Ø§
  },
  'PLAN3': {
    name: 'Ù¾Ù„Ù† Û³: Ø§ØµÙ„ + Ø³ÙˆØ¯ Ø¯Ø± Ø§Ù†ØªÙ‡Ø§',
    monthlyRate: 7,
    description: 'Ø§ØµÙ„ Ùˆ Ø³ÙˆØ¯ Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ÛŒ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯',
    paymentType: 'lump_sum' // Ù¾Ø±Ø¯Ø§Ø®Øª ÛŒÚ©Ø¬Ø§ Ø¯Ø± Ø§Ù†ØªÙ‡Ø§
  }
};

const VAT_RATE = 10; // Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡ 10%

// API Configuration
const API_URL = 'https://n8nb2wall.darkube.app/webhook/internal-calculator';

// Calculate function
async function calculate() {
  // Get inputs
  const invoiceAmountStr = document.getElementById('invoiceAmount').value;
  const invoiceAmount = Number(parseFormattedNumber(invoiceAmountStr));
  const isTaxExempt = document.getElementById('isTaxExempt').value;
  const hasVAT = document.getElementById('hasVAT').value;
  const duration = Number(document.getElementById('duration').value);
  const planCode = document.getElementById('plan').value;
  const platformFeeRate = Number(document.getElementById('platformFee').value);
  const collateralCoverRate = Number(document.getElementById('collateralCover').value);

  // Validate (only when calculate button is clicked, not on every input)
  if (!invoiceAmount || invoiceAmount <= 0) {
    alert('Ù„Ø·ÙØ§Ù‹ Ù…Ø¨Ù„Øº ÙØ§Ú©ØªÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
    return;
  }
  
  if (!duration || duration <= 0) {
    alert('Ù„Ø·ÙØ§Ù‹ Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
    return;
  }
  
  if (!planCode) {
    alert('Ù„Ø·ÙØ§Ù‹ Ù†ÙˆØ¹ Ù¾Ù„Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
    return;
  }

  // Show loading state
  const btn = document.getElementById('calculateBtn');
  const originalText = btn.innerHTML;
  btn.innerHTML = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡...';
  btn.disabled = true;

  try {
    // Send data to N8N
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        invoiceAmount,
        isTaxExempt,
        hasVAT,
        duration,
        planCode,
        platformFeeRate,
        collateralCoverRate
      })
    });

    if (!response.ok) {
      throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
    }

    const result = await response.json();

    // N8N returns array, get first item
    const data = Array.isArray(result) ? result[0] : result;

    if (!data.success) {
      throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ø§Øª');
    }

    // Update UI with results from N8N
    updateUI(data.data);

  } catch (error) {
    console.error('Error:', error);
    alert('Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ø§Øª. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
  } finally {
    // Restore button state
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
}

// Update UI with calculation results
function updateUI(data) {
  const plan = PLANS[document.getElementById('plan').value];
  const duration = Number(document.getElementById('duration').value);
  
  // Investor
  document.getElementById('investorInitial').textContent = formatNumber(data.investor.initial);
  
  if (data.summary.paymentType === 'lump_sum') {
    document.getElementById('investorMonthly').textContent = 'Û° ØªÙˆÙ…Ø§Ù† (Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø± Ø§Ù†ØªÙ‡Ø§)';
  } else {
    document.getElementById('investorMonthly').textContent = formatNumber(data.investor.monthlyReturn);
  }
  
  document.getElementById('investorTotal').textContent = formatNumber(data.investor.totalReturn);
  document.getElementById('investorProfit').textContent = formatNumber(data.investor.profit);
  
  // Recipient
  document.getElementById('recipientCash').textContent = formatNumber(data.recipient.cash);
  
  if (data.summary.paymentType === 'lump_sum') {
    document.getElementById('recipientMonthly').textContent = 'Û° ØªÙˆÙ…Ø§Ù† (Ù¾Ø±Ø¯Ø§Ø®Øª Ø¯Ø± Ø§Ù†ØªÙ‡Ø§)';
  } else {
    document.getElementById('recipientMonthly').textContent = formatNumber(data.recipient.monthlyInstallment);
  }
  
  document.getElementById('recipientTotal').textContent = formatNumber(data.recipient.totalPayment);
  document.getElementById('recipientCost').textContent = formatNumber(data.recipient.financingCost);

  // B2Wall Platform
  document.getElementById('platformFeeAmount').textContent = formatNumber(data.platform.platformFee);
  document.getElementById('collateralAmount').textContent = formatNumber(data.platform.collateral);
  document.getElementById('platformTotal').textContent = formatNumber(data.platform.total);

  // Summary
  document.getElementById('summaryPlan').textContent = data.summary.planName;
  document.getElementById('summaryMonths').textContent = 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[Math.floor(duration / 10)] + 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[duration % 10] + ' Ù…Ø§Ù‡';
  document.getElementById('summaryRate').textContent = data.summary.monthlyRate.toString().replace(/[0-9]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[d]) + '%';
  document.getElementById('summaryFinanced').textContent = formatNumber(data.invoice.withVAT);
  
  // Show summary
  document.getElementById('summaryCard').style.display = 'block';
}

// Event listeners
document.getElementById('calculateBtn').addEventListener('click', calculate);

// Handle tax exempt status change
document.getElementById('isTaxExempt').addEventListener('change', function() {
  const vatQuestionSection = document.getElementById('vatQuestionSection');
  if (this.value === 'yes') {
    // Ø§Ú¯Ø± Ú©Ø§Ù„Ø§ Ù…Ø¹Ø§Ù Ø§Ø³ØªØŒ Ø³ÙˆØ§Ù„ Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡ Ø±Ø§ Ù…Ø®ÙÛŒ Ú©Ù†
    vatQuestionSection.style.display = 'none';
  } else {
    // Ø§Ú¯Ø± Ù…Ø´Ù…ÙˆÙ„ Ù…Ø§Ù„ÛŒØ§Øª Ø§Ø³ØªØŒ Ø³ÙˆØ§Ù„ Ø±Ø§ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡
    vatQuestionSection.style.display = 'block';
  }
  
  // Recalculate if summary is visible
  if (document.getElementById('summaryCard').style.display !== 'none') {
    calculate();
  }
});

// Auto-calculate on input/change - REMOVED, only calculate on button click
// Event listeners for formatting invoice amount
document.getElementById('invoiceAmount').addEventListener('blur', function(e) {
  const val = parseFormattedNumber(e.target.value);
  if (val) {
    e.target.value = formatNumber(val).replace(' ØªÙˆÙ…Ø§Ù†', '');
  }
});

document.getElementById('invoiceAmount').addEventListener('focus', function(e) {
  // Remove formatting on focus for easier editing
  const val = parseFormattedNumber(e.target.value);
  if (val) {
    e.target.value = val;
  }
});

// Don't auto-calculate anymore
</script>

</body>
</html>
